<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Node (tezt-tezos.Tezt_tezos.Node)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezt-tezos</a> &#x00BB; <a href="../index.html">Tezt_tezos</a> &#x00BB; Node</nav><header class="odoc-preamble"><h1>Module <code><span>Tezt_tezos.Node</span></code></h1><p>Spawn Tezos nodes and control them.</p></header><nav class="odoc-toc"><ul><li><a href="#commands">Commands</a></li><li><a href="#events">Events</a></li><li><a href="#high-level-functions">High-Level Functions</a></li></ul></nav><div class="odoc-content"><p>Convention: in this module, some functions implement node commands; those functions are named after those commands. For instance, <code>Node.config_init</code> corresponds to <code>tezos-node config init</code>, and <code>Node.run</code> corresponds to <code>tezos-node run</code>.</p><p>The arguments of those functions are also named after the actual arguments. For instance, <code>?network</code> is named after <code>--network</code>, to make <code>Node.config_init ~network:&quot;carthagenet&quot;</code> look as close as possible to <code>tezos-node config init --network carthagenet</code>.</p><p>Most options have default values which are not necessarily the default values of <code>tezos-node</code>. Indeed, the latter are tailored for Mainnet, but here we use defaults which are tailored for the sandbox. In particular, the default value for <code>?network</code> is <code>&quot;sandbox&quot;</code>. However, if you specify an option such as <code>~network</code> or <code>~history_mode</code>, they are passed to the node unchanged, to reduce surprises.</p><p>These conventions are also followed in the <code>Client</code> module.</p><div class="odoc-spec"><div class="spec type" id="type-history_mode" class="anchored"><a href="#type-history_mode" class="anchor"></a><code><span><span class="keyword">type</span> history_mode</span><span> = </span></code><table><tr id="type-history_mode.Archive" class="anchored"><td class="def variant constructor"><a href="#type-history_mode.Archive" class="anchor"></a><code><span>| </span><span><span class="constructor">Archive</span></span></code></td></tr><tr id="type-history_mode.Full" class="anchored"><td class="def variant constructor"><a href="#type-history_mode.Full" class="anchor"></a><code><span>| </span><span><span class="constructor">Full</span></span></code></td></tr><tr id="type-history_mode.Rolling" class="anchored"><td class="def variant constructor"><a href="#type-history_mode.Rolling" class="anchor"></a><code><span>| </span><span><span class="constructor">Rolling</span></span></code></td></tr></table></div><div class="spec-doc"><p>History modes for the node.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-argument" class="anchored"><a href="#type-argument" class="anchor"></a><code><span><span class="keyword">type</span> argument</span><span> = </span></code><table><tr id="type-argument.Network" class="anchored"><td class="def variant constructor"><a href="#type-argument.Network" class="anchor"></a><code><span>| </span><span><span class="constructor">Network</span> <span class="keyword">of</span> string</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p><code>--network</code></p><span class="comment-delim">*)</span></td></tr><tr id="type-argument.History_mode" class="anchored"><td class="def variant constructor"><a href="#type-argument.History_mode" class="anchor"></a><code><span>| </span><span><span class="constructor">History_mode</span> <span class="keyword">of</span> <a href="#type-history_mode">history_mode</a></span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p><code>--history-mode</code></p><span class="comment-delim">*)</span></td></tr><tr id="type-argument.Expected_pow" class="anchored"><td class="def variant constructor"><a href="#type-argument.Expected_pow" class="anchor"></a><code><span>| </span><span><span class="constructor">Expected_pow</span> <span class="keyword">of</span> int</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p><code>--expected-pow</code></p><span class="comment-delim">*)</span></td></tr><tr id="type-argument.Singleprocess" class="anchored"><td class="def variant constructor"><a href="#type-argument.Singleprocess" class="anchor"></a><code><span>| </span><span><span class="constructor">Singleprocess</span></span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p><code>--singleprocess</code></p><span class="comment-delim">*)</span></td></tr><tr id="type-argument.Bootstrap_threshold" class="anchored"><td class="def variant constructor"><a href="#type-argument.Bootstrap_threshold" class="anchor"></a><code><span>| </span><span><span class="constructor">Bootstrap_threshold</span> <span class="keyword">of</span> int</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p><code>--bootstrap-threshold</code> (deprecated)</p><span class="comment-delim">*)</span></td></tr><tr id="type-argument.Synchronisation_threshold" class="anchored"><td class="def variant constructor"><a href="#type-argument.Synchronisation_threshold" class="anchor"></a><code><span>| </span><span><span class="constructor">Synchronisation_threshold</span> <span class="keyword">of</span> int</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p><code>--synchronisation-threshold</code></p><span class="comment-delim">*)</span></td></tr><tr id="type-argument.Connections" class="anchored"><td class="def variant constructor"><a href="#type-argument.Connections" class="anchor"></a><code><span>| </span><span><span class="constructor">Connections</span> <span class="keyword">of</span> int</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p><code>--connections</code></p><span class="comment-delim">*)</span></td></tr><tr id="type-argument.Private_mode" class="anchored"><td class="def variant constructor"><a href="#type-argument.Private_mode" class="anchor"></a><code><span>| </span><span><span class="constructor">Private_mode</span></span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p><code>--private-mode</code></p><span class="comment-delim">*)</span></td></tr><tr id="type-argument.Peer" class="anchored"><td class="def variant constructor"><a href="#type-argument.Peer" class="anchor"></a><code><span>| </span><span><span class="constructor">Peer</span> <span class="keyword">of</span> string</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p><code>--peer</code></p><span class="comment-delim">*)</span></td></tr></table></div><div class="spec-doc"><p>Tezos node command-line arguments.</p><p>Not all arguments are available here. Some are simply not implemented, and some are handled separately because they need special care. The latter are implemented as optional labeled arguments (e.g. <code>?net_port</code> and <code>?data_dir</code>).</p></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Tezos node states.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>?runner:<a href="../../../tezt/Tezt/Runner/index.html#type-t">Tezt.Runner.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?path:string <span class="arrow">&#45;&gt;</span></span> <span>?name:string <span class="arrow">&#45;&gt;</span></span> <span>?color:<a href="../../../tezt/Tezt/Log/Color/index.html#type-t">Tezt.Log.Color.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?data_dir:string <span class="arrow">&#45;&gt;</span></span>
<span>?event_pipe:string <span class="arrow">&#45;&gt;</span></span> <span>?net_port:int <span class="arrow">&#45;&gt;</span></span> <span>?rpc_host:string <span class="arrow">&#45;&gt;</span></span> <span>?rpc_port:int <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Create a node.</p><p>This function just creates the <code>t</code> value, it does not call <code>identity_generate</code> nor <code>config_init</code> nor <code>run</code>.</p><p>The standard output and standard error output of the node will be logged with prefix <code>name</code> and color <code>color</code>.</p><p>Default <code>data_dir</code> is a temporary directory which is always the same for each <code>name</code>.</p><p>Default <code>event_pipe</code> is a temporary file whose name is derived from <code>name</code>. It will be created as a named pipe so that node events can be received.</p><p>Default values for <code>net_port</code> or <code>rpc_port</code> are chosen automatically with values starting from 16384 (configurable with `--starting-port`). They are used by <code>config_init</code> and by functions from the <code>Client</code> module. They are not used by <code>run</code>, so if you do not call <code>config_init</code> or generate the configuration file through some other means, your node will not listen.</p><p>The argument list is a list of configuration options that the node should run with. It is passed to the first run of <code>tezos-node config init</code>. It is also passed to all runs of <code>tezos-node run</code> that occur before <code>tezos-node config init</code>. If <code>Expected_pow</code> is given, it is also used as the default value for <a href="#val-identity_generate"><code>identity_generate</code></a>.</p><p>If <code>runner</code> is specified, the node will be spawned on this runner using SSH.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-add_argument" class="anchored"><a href="#val-add_argument" class="anchor"></a><code><span><span class="keyword">val</span> add_argument : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-argument">argument</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Add an argument to a node as if it was passed to <a href="#val-create"><code>create</code></a>.</p><p>The argument is passed to the next run of <code>tezos-node config init</code>. It is also passed to all runs of <code>tezos-node run</code> that occur before the next <code>tezos-node config init</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-add_peer" class="anchored"><a href="#val-add_peer" class="anchor"></a><code><span><span class="keyword">val</span> add_peer : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Add a <code>--peer</code> argument to a node.</p><p>Usage: <code>add_peer node peer</code></p><p>Same as <code>add_argument node (Peer &quot;127.0.0.1:&lt;PORT&gt;&quot;)</code> where <code>&lt;PORT&gt;</code> is the P2P port of <code>peer</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-add_peer_with_id" class="anchored"><a href="#val-add_peer_with_id" class="anchor"></a><code><span><span class="keyword">val</span> add_peer_with_id : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Add a <code>--peer</code> argument to a node.</p><p>Usage: <code>add_peer node peer</code></p><p>Same as <code>add_argument node (Peer &quot;127.0.0.1:&lt;PORT&gt;#&lt;ID&gt;&quot;)</code> where <code>&lt;PORT&gt;</code> is the P2P port and <code>&lt;ID&gt;</code> is the identity of <code>peer</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-point_and_id" class="anchored"><a href="#val-point_and_id" class="anchor"></a><code><span><span class="keyword">val</span> point_and_id : <span>?from:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Get the P2P point and id for a node.</p><p>Return <code>&quot;&lt;ADDRESS&gt;:&lt;PORT&gt;#&lt;ID&gt;&quot;</code> where <code>&lt;PORT&gt;</code> is the P2P port and <code>&lt;ID&gt;</code> is the identity of the node.</p><p><code>&lt;ADDRESS&gt;</code> is obtained using <code>Runner.address runner</code> with <code>?from</code> being the runner of <code>from</code> and <code>runner</code> is the runner of the node. In other words it is the address where <code>from</code> can contact <code>node</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-name" class="anchored"><a href="#val-name" class="anchor"></a><code><span><span class="keyword">val</span> name : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the name of a node.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-net_port" class="anchored"><a href="#val-net_port" class="anchor"></a><code><span><span class="keyword">val</span> net_port : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Get the network port given as <code>--net-addr</code> to a node.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-rpc_host" class="anchored"><a href="#val-rpc_host" class="anchor"></a><code><span><span class="keyword">val</span> rpc_host : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the RPC host given as <code>--rpc-addr</code> to a node.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-rpc_port" class="anchored"><a href="#val-rpc_port" class="anchor"></a><code><span><span class="keyword">val</span> rpc_port : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Get the RPC port given as <code>--rpc-addr</code> to a node.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-data_dir" class="anchored"><a href="#val-data_dir" class="anchor"></a><code><span><span class="keyword">val</span> data_dir : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the data-dir of a node.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-runner" class="anchored"><a href="#val-runner" class="anchor"></a><code><span><span class="keyword">val</span> runner : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezt/Tezt/Runner/index.html#type-t">Tezt.Runner.t</a> option</span></span></code></div><div class="spec-doc"><p>Get the runner associated to a node.</p><p>Return <code>None</code> if the node runs on the local machine.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-check_error" class="anchored"><a href="#val-check_error" class="anchor"></a><code><span><span class="keyword">val</span> check_error : <span>?exit_code:int <span class="arrow">&#45;&gt;</span></span> <span>?msg:<a href="../../../tezt/Tezt/Base/index.html#type-rex">Tezt.Base.rex</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait until a node terminates and check its status.</p><p>If the node is not running, or if the process returns an exit code which is not <code>exit_code</code>, or if <code>msg</code> does not match the stderr output, fail the test.</p><p>If <code>exit_code</code> is not specified, any non-zero code is accepted. If no <code>msg</code> is given, the stderr is ignored.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-wait" class="anchored"><a href="#val-wait" class="anchor"></a><code><span><span class="keyword">val</span> wait : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Unix</span>.process_status <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait until a node terminates and return its status. If the node is not running, make the test fail.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-terminate" class="anchored"><a href="#val-terminate" class="anchor"></a><code><span><span class="keyword">val</span> terminate : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Send SIGTERM to a node and wait for it to terminate.</p></div></div><h3 id="commands"><a href="#commands" class="anchor"></a>Commands</h3><div class="odoc-spec"><div class="spec value" id="val-identity_generate" class="anchored"><a href="#val-identity_generate" class="anchor"></a><code><span><span class="keyword">val</span> identity_generate : <span>?expected_pow:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>tezos-node identity generate</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-spawn_identity_generate" class="anchored"><a href="#val-spawn_identity_generate" class="anchor"></a><code><span><span class="keyword">val</span> spawn_identity_generate : <span>?expected_pow:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezt/Tezt/Process/index.html#type-t">Tezt.Process.t</a></span></code></div><div class="spec-doc"><p>Same as <code>identity_generate</code>, but do not wait for the process to exit.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-show_history_mode" class="anchored"><a href="#val-show_history_mode" class="anchor"></a><code><span><span class="keyword">val</span> show_history_mode : <span><a href="#type-history_mode">history_mode</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Convert an history mode into a string.</p><p>The result is suitable to be passed to the node on the command-line.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-config_init" class="anchored"><a href="#val-config_init" class="anchor"></a><code><span><span class="keyword">val</span> config_init : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Run <code>tezos-node config init</code>.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Config_file" class="anchored"><a href="#module-Config_file" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Config_file/index.html">Config_file</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Node configuration files.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-spawn_config_init" class="anchored"><a href="#val-spawn_config_init" class="anchor"></a><code><span><span class="keyword">val</span> spawn_config_init : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezt/Tezt/Process/index.html#type-t">Tezt.Process.t</a></span></code></div><div class="spec-doc"><p>Same as <code>config_init</code>, but do not wait for the process to exit.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-run" class="anchored"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : <span>?on_terminate:<span>(<span><span class="xref-unresolved">Unix</span>.process_status <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span>?event_level:string <span class="arrow">&#45;&gt;</span></span>
<span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Spawn <code>tezos-node run</code>.</p><p>The resulting promise is fulfilled as soon as the node has been spawned. It continues running in the background.</p><p><code>event_level</code> specifies the verbosity of the file descriptor sink. This must be at least <code>&quot;notice&quot;</code>, which is the level of event <code>&quot;node_is_ready.v0&quot;</code>, needed for <a href="#val-wait_for_ready"><code>wait_for_ready</code></a>. Possible values are therefore: <code>&quot;debug&quot;</code>, <code>&quot;info&quot;</code>, and <code>&quot;notice&quot;</code>. Other values are ignored (verbosity then stays at default <code>&quot;notice&quot;</code>).</p></div></div><h3 id="events"><a href="#events" class="anchor"></a>Events</h3><div class="odoc-spec"><div class="spec exception" id="exception-Terminated_before_event" class="anchored"><a href="#exception-Terminated_before_event" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Terminated_before_event</span> <span class="keyword">of</span> </span><span>{</span></code><table><tr id="module-Node.daemon" class="anchored"><td class="def record field"><a href="#module-Node.daemon" class="anchor"></a><code><span>daemon : string;</span></code></td></tr><tr id="module-Node.event" class="anchored"><td class="def record field"><a href="#module-Node.event" class="anchor"></a><code><span>event : string;</span></code></td></tr><tr id="module-Node.where" class="anchored"><td class="def record field"><a href="#module-Node.where" class="anchor"></a><code><span>where : <span>string option</span>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Exception raised by <code>wait_for</code> functions if the node terminates before the event.</p><p>You may catch or let it propagate to cause the test to fail. <code>daemon</code> is the name of the node. <code>event</code> is the name of the event. <code>where</code> is an additional optional constraint, such as <code>&quot;level &gt;= 10&quot;</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-wait_for_ready" class="anchored"><a href="#val-wait_for_ready" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_ready : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait until the node is ready.</p><p>More precisely, wait until a <code>node_is_ready</code> event occurs. If such an event already occurred, return immediately.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-wait_for_level" class="anchored"><a href="#val-wait_for_level" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for a given chain level.</p><p>More precisely, wait until a <code>node_chain_validator</code> with a <code>level</code> greater or equal to the requested level occurs. If such an event already occurred, return immediately.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-wait_for_identity" class="anchored"><a href="#val-wait_for_identity" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_identity : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for the node to read its identity.</p><p>More precisely, wait until a <code>read_identity</code> event occurs. If such an event already occurred, return immediately.</p><p>Return the identity.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-wait_for" class="anchored"><a href="#val-wait_for" class="anchor"></a><code><span><span class="keyword">val</span> wait_for : <span>?where:string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="../../../tezt/Tezt/JSON/index.html#type-t">Tezt.JSON.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for a custom event to occur.</p><p>Usage: <code>wait_for node name filter</code></p><p>If an event named <code>name</code> occurs, apply <code>filter</code> to its value. If <code>filter</code> returns <code>None</code>, continue waiting. If <code>filter</code> returns <code>Some x</code>, return <code>x</code>.</p><p><code>where</code> is used as the <code>where</code> field of the <code>Terminated_before_event</code> exception if the node terminates. It should describe the constraint that <code>filter</code> applies, such as <code>&quot;field level exists&quot;</code>.</p><p>It is advised to register such event handlers before starting the node, as if they occur before being registered, they will not trigger your handler. For instance, you can define a promise with <code>let x_event = wait_for node &quot;x&quot; (fun x -&gt; Some x)</code> and bind it later with <code>let* x = x_event</code>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-event" class="anchored"><a href="#type-event" class="anchor"></a><code><span><span class="keyword">type</span> event</span><span> = </span><span>{</span></code><table><tr id="type-event.name" class="anchored"><td class="def record field"><a href="#type-event.name" class="anchor"></a><code><span>name : string;</span></code></td></tr><tr id="type-event.value" class="anchored"><td class="def record field"><a href="#type-event.value" class="anchor"></a><code><span>value : <a href="../../../tezt/Tezt/JSON/index.html#type-t">Tezt.JSON.t</a>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Raw events.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-on_event" class="anchored"><a href="#val-on_event" class="anchor"></a><code><span><span class="keyword">val</span> on_event : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="#type-event">event</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Add a callback to be called whenever the node emits an event.</p><p>Contrary to <code>wait_for</code> functions, this callback is never removed.</p><p>Listening to events with <code>on_event</code> will not prevent <code>wait_for</code> promises to be fulfilled. You can also have multiple <code>on_event</code> handlers, although the order in which they trigger is unspecified.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-log_events" class="anchored"><a href="#val-log_events" class="anchor"></a><code><span><span class="keyword">val</span> log_events : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Register an event handler that logs all events.</p><p>Use this when you need to debug or reverse engineer incoming events. Usually you do not want to keep that in the final versions of your tests.</p></div></div><h3 id="high-level-functions"><a href="#high-level-functions" class="anchor"></a>High-Level Functions</h3><div class="odoc-spec"><div class="spec value" id="val-init" class="anchored"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : <span>?runner:<a href="../../../tezt/Tezt/Runner/index.html#type-t">Tezt.Runner.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?path:string <span class="arrow">&#45;&gt;</span></span> <span>?name:string <span class="arrow">&#45;&gt;</span></span> <span>?color:<a href="../../../tezt/Tezt/Log/Color/index.html#type-t">Tezt.Log.Color.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?data_dir:string <span class="arrow">&#45;&gt;</span></span>
<span>?event_pipe:string <span class="arrow">&#45;&gt;</span></span> <span>?net_port:int <span class="arrow">&#45;&gt;</span></span> <span>?rpc_host:string <span class="arrow">&#45;&gt;</span></span> <span>?rpc_port:int <span class="arrow">&#45;&gt;</span></span>
<span>?event_level:string <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Initialize a node.</p><p>This <a href="#val-create"><code>create</code></a>s a node, runs <a href="#val-identity_generate"><code>identity_generate</code></a>, <a href="#val-config_init"><code>config_init</code></a> and <a href="#val-run"><code>run</code></a>, then waits for the node to be ready, and finally returns the node.</p><p>Arguments are passed to <a href="#val-config_init"><code>config_init</code></a>. If you specified <code>Expected_pow</code>, it is also passed to <a href="#val-identity_generate"><code>identity_generate</code></a>. Arguments are not passed to <a href="#val-run"><code>run</code></a>. If you do not wish the arguments to be stored in the configuration file (which will affect future runs too), do not use <code>init</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-restart" class="anchored"><a href="#val-restart" class="anchor"></a><code><span><span class="keyword">val</span> restart : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-argument">argument</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Restart a node.</p><p>This <a href="#val-terminate"><code>terminate</code></a>s a node, then <a href="#val-run"><code>run</code></a>s it again and waits for it to be ready.</p><p>If you passed arguments such as <code>Expected_pow</code> or <code>Singleprocess</code> to <a href="#val-run"><code>run</code></a> they are not automatically passed again. You can pass them to <code>restart</code>, or you can pass other values if you want to restart with other parameters.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-send_raw_data" class="anchored"><a href="#val-send_raw_data" class="anchor"></a><code><span><span class="keyword">val</span> send_raw_data : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>data:string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>send_raw_data node ~data</code> writes <code>~data</code> using an IP socket on the net port of <code>node</code>.</p></div></div></div></body></html>