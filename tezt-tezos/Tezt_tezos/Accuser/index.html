<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Accuser (tezt-tezos.Tezt_tezos.Accuser)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezt-tezos</a> &#x00BB; <a href="../index.html">Tezt_tezos</a> &#x00BB; Accuser</nav><header class="odoc-preamble"><h1>Module <code><span>Tezt_tezos.Accuser</span></code></h1><p>Spawn Tezos accuser and control them.</p></header><nav class="odoc-toc"><ul><li><a href="#commands">Commands</a></li><li><a href="#events">Events</a></li><li><a href="#high-level-functions">High-Level Functions</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Tezos accuser states.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-event" class="anchored"><a href="#type-event" class="anchor"></a><code><span><span class="keyword">type</span> event</span><span> = </span><span>{</span></code><table><tr id="type-event.name" class="anchored"><td class="def record field"><a href="#type-event.name" class="anchor"></a><code><span>name : string;</span></code></td></tr><tr id="type-event.value" class="anchored"><td class="def record field"><a href="#type-event.value" class="anchor"></a><code><span>value : <a href="../../../tezt/Tezt/JSON/index.html#type-t">Tezt.JSON.t</a>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Raw events.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>protocol:<a href="../Protocol/index.html#type-t">Protocol.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?name:string <span class="arrow">&#45;&gt;</span></span> <span>?color:<a href="../../../tezt/Tezt/Log/Color/index.html#type-t">Tezt.Log.Color.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?event_pipe:string <span class="arrow">&#45;&gt;</span></span>
<span>?base_dir:string <span class="arrow">&#45;&gt;</span></span> <span>?runner:<a href="../../../tezt/Tezt/Runner/index.html#type-t">Tezt.Runner.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Node/index.html#type-t">Node.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Create an accuser.</p><p>This function just creates the <code>t</code> value, it does not call <code>run</code>.</p><p>The path to accuser binary is chosen from the <code>protocol</code>.</p><p>The standard output and standard error output of the accuser will be logged with prefix <code>name</code> and color <code>color</code>.</p><p>Default <code>event_pipe</code> is a temporary file whose name is derived from <code>name</code>. It will be created as a named pipe so that accuser events can be received.</p><p><code>base_dir</code> corresponds to the (useless) &quot;--base-dir&quot; argument of the tezos-accuser command.</p><p>The <code>Node.t</code> parameter is the accuser's node target. The accuser will be configured to be synchronised with the given node, and will communicate with it.</p><p>If <code>runner</code> is specified, the accuser will be spawned on this runner using SSH.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-name" class="anchored"><a href="#val-name" class="anchor"></a><code><span><span class="keyword">val</span> name : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the name of an accuser.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-node_rpc_port" class="anchored"><a href="#val-node_rpc_port" class="anchor"></a><code><span><span class="keyword">val</span> node_rpc_port : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Get the RPC port of the associated node.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-terminate" class="anchored"><a href="#val-terminate" class="anchor"></a><code><span><span class="keyword">val</span> terminate : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Send SIGTERM to an accuser and wait for it to terminate.</p></div></div><h3 id="commands"><a href="#commands" class="anchor"></a>Commands</h3><div class="odoc-spec"><div class="spec value" id="val-run" class="anchored"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Spawn <code>tezos-accuser run</code>.</p><p>The resulting promise is fulfilled as soon as the accuser has been spawned. It continues running in the background.</p></div></div><h3 id="events"><a href="#events" class="anchor"></a>Events</h3><div class="odoc-spec"><div class="spec exception" id="exception-Terminated_before_event" class="anchored"><a href="#exception-Terminated_before_event" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Terminated_before_event</span> <span class="keyword">of</span> </span><span>{</span></code><table><tr id="module-Accuser.daemon" class="anchored"><td class="def record field"><a href="#module-Accuser.daemon" class="anchor"></a><code><span>daemon : string;</span></code></td></tr><tr id="module-Accuser.event" class="anchored"><td class="def record field"><a href="#module-Accuser.event" class="anchor"></a><code><span>event : string;</span></code></td></tr><tr id="module-Accuser.where" class="anchored"><td class="def record field"><a href="#module-Accuser.where" class="anchor"></a><code><span>where : <span>string option</span>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Exception raised by <code>wait_for</code> functions if the node terminates before the event.</p><p>You may catch or let it propagate to cause the test to fail. <code>daemon</code> is the name of the accuser. <code>event</code> is the name of the event. <code>where</code> is an additional optional constraint, such as <code>&quot;level &gt;= 10&quot;</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-wait_for_ready" class="anchored"><a href="#val-wait_for_ready" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_ready : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait until the accuser is ready.</p><p>More precisely, wait until the node on which the accuser is connected to is bootstrapped, and then, the accuser is ready.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-wait_for" class="anchored"><a href="#val-wait_for" class="anchor"></a><code><span><span class="keyword">val</span> wait_for : <span>?where:string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="../../../tezt/Tezt/JSON/index.html#type-t">Tezt.JSON.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Wait for a custom event to occur.</p><p>Usage: <code>wait_for accuser name filter</code></p><p>If an event named <code>name</code> occurs, apply <code>filter</code> to its value. If <code>filter</code> returns <code>None</code>, continue waiting. If <code>filter</code> returns <code>Some x</code>, return <code>x</code>.</p><p><code>where</code> is used as the <code>where</code> field of the <code>Terminated_before_event</code> exception if the accuser terminates. It should describe the constraint that <code>filter</code> applies, such as <code>&quot;field level exists&quot;</code>.</p><p>It is advised to register such event handlers before starting the accuser, as if they occur before being registered, they will not trigger your handler. For instance, you can define a promise with <code>let x_event = wait_for accuser &quot;x&quot; (fun x -&gt; Some x)</code> and bind it later with <code>let* x = x_event</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-on_event" class="anchored"><a href="#val-on_event" class="anchor"></a><code><span><span class="keyword">val</span> on_event : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="#type-event">event</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Add a callback to be called whenever the accuser emits an event.</p><p>Contrary to <code>wait_for</code> functions, this callback is never removed.</p><p>Listening to events with <code>on_event</code> will not prevent <code>wait_for</code> promises to be fulfilled. You can also have multiple <code>on_event</code> handlers, although the order in which they trigger is unspecified.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-log_events" class="anchored"><a href="#val-log_events" class="anchor"></a><code><span><span class="keyword">val</span> log_events : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Register an event handler that logs all events.</p><p>Use this when you need to debug or reverse engineer incoming events. Usually you do not want to keep that in the final versions of your tests.</p></div></div><h3 id="high-level-functions"><a href="#high-level-functions" class="anchor"></a>High-Level Functions</h3><div class="odoc-spec"><div class="spec value" id="val-init" class="anchored"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : <span>protocol:<a href="../Protocol/index.html#type-t">Protocol.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?name:string <span class="arrow">&#45;&gt;</span></span> <span>?color:<a href="../../../tezt/Tezt/Log/Color/index.html#type-t">Tezt.Log.Color.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?event_pipe:string <span class="arrow">&#45;&gt;</span></span>
<span>?base_dir:string <span class="arrow">&#45;&gt;</span></span> <span>?runner:<a href="../../../tezt/Tezt/Runner/index.html#type-t">Tezt.Runner.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Node/index.html#type-t">Node.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Initialize an accuser.</p><p>This <a href="#val-create"><code>create</code></a>s an accuser and <a href="#val-run"><code>run</code></a>, then waits for the accuser to be ready, and finally returns the accuser.</p><p>As the accuser usually needs to be connected to a node, we first wait for the node to be ready and then, run the accuser. If one does not want to wait for the node to be ready, it is necessary to use <code>create</code> and then <code>run</code>.</p><p>The path to accuser binary is chosen from the <code>protocol</code>.</p><p>The standard output and standard error output of the accuser will be logged with prefix <code>name</code> and color <code>color</code>.</p><p>Default <code>event_pipe</code> is a temporary file whose name is derived from <code>name</code>. It will be created as a named pipe so that accuser events can be received.</p><p><code>base_dir</code> corresponds to the (useless) &quot;--base-dir&quot; argument of the tezos-accuser command.</p><p>The <code>Node.t</code> parameter is the accuser's node target. The accuser will be configured to be synchronised with the given node, and will communicate with it.</p><p>If <code>runner</code> is specified, the accuser will be spawned on this runner using SSH.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-restart" class="anchored"><a href="#val-restart" class="anchor"></a><code><span><span class="keyword">val</span> restart : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Restart an accuser.</p><p>This <a href="#val-terminate"><code>terminate</code></a>s an accuser, then <a href="#val-run"><code>run</code></a>s it again and waits for it to be ready.</p></div></div></div></body></html>