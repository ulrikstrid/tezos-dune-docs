<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Baking (tezos-protocol-functor-010-PtGRANAD.Tezos_protocol_010_PtGRANAD_functor.Functor.Make.Baking)</title><link rel="stylesheet" href="../../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../index.html">tezos-protocol-functor-010-PtGRANAD</a> &#x00BB; <a href="../../../index.html">Tezos_protocol_010_PtGRANAD_functor</a> &#x00BB; <a href="../../index.html">Functor</a> &#x00BB; <a href="../index.html">Make</a> &#x00BB; Baking</nav><header class="odoc-preamble"><h1>Module <code><span>Make.Baking</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type extension"><code><span><span class="keyword">type</span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-error">Tezos_protocol_environment.Error_monad.error</a> += </span></code><table><tr id="extension-Invalid_fitness_gap" class="anchored"><td class="def extension"><a href="#extension-Invalid_fitness_gap" class="anchor"></a><code><span>| </span><span><span class="extension">Invalid_fitness_gap</span> <span class="keyword">of</span> int64 * int64</span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec type extension"><code><span><span class="keyword">type</span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-error">Tezos_protocol_environment.Error_monad.error</a> += </span></code><table><tr id="extension-Timestamp_too_early" class="anchored"><td class="def extension"><a href="#extension-Timestamp_too_early" class="anchor"></a><code><span>| </span><span><span class="extension">Timestamp_too_early</span> <span class="keyword">of</span> </span><span>{</span></code><table><tr id="module-Baking.minimal_time" class="anchored"><td class="def record field"><a href="#module-Baking.minimal_time" class="anchor"></a><code><span>minimal_time : <a href="../Alpha_context/Timestamp/index.html#type-t">Alpha_context.Timestamp.t</a>;</span></code></td></tr><tr id="module-Baking.provided_time" class="anchored"><td class="def record field"><a href="#module-Baking.provided_time" class="anchor"></a><code><span>provided_time : <a href="../Alpha_context/Timestamp/index.html#type-t">Alpha_context.Timestamp.t</a>;</span></code></td></tr><tr id="module-Baking.priority" class="anchored"><td class="def record field"><a href="#module-Baking.priority" class="anchor"></a><code><span>priority : int;</span></code></td></tr><tr id="module-Baking.endorsing_power_opt" class="anchored"><td class="def record field"><a href="#module-Baking.endorsing_power_opt" class="anchor"></a><code><span>endorsing_power_opt : <span>int option</span>;</span></code></td></tr></table><code><span>}</span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec type extension"><code><span><span class="keyword">type</span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-error">Tezos_protocol_environment.Error_monad.error</a> += </span></code><table><tr id="extension-Invalid_block_signature" class="anchored"><td class="def extension"><a href="#extension-Invalid_block_signature" class="anchor"></a><code><span>| </span><span><span class="extension">Invalid_block_signature</span> <span class="keyword">of</span> <a href="../argument-1-Tezos_protocol_environment/Block_hash/index.html#type-t">Tezos_protocol_environment.Block_hash.t</a> * <a href="../argument-1-Tezos_protocol_environment/Signature/Public_key_hash/index.html#type-t">Tezos_protocol_environment.Signature.Public_key_hash.t</a></span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec type extension"><code><span><span class="keyword">type</span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-error">Tezos_protocol_environment.Error_monad.error</a> += </span></code><table><tr id="extension-Unexpected_endorsement" class="anchored"><td class="def extension"><a href="#extension-Unexpected_endorsement" class="anchor"></a><code><span>| </span><span><span class="extension">Unexpected_endorsement</span></span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec type extension"><code><span><span class="keyword">type</span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-error">Tezos_protocol_environment.Error_monad.error</a> += </span></code><table><tr id="extension-Invalid_endorsement_slot" class="anchored"><td class="def extension"><a href="#extension-Invalid_endorsement_slot" class="anchor"></a><code><span>| </span><span><span class="extension">Invalid_endorsement_slot</span> <span class="keyword">of</span> int</span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec type extension"><code><span><span class="keyword">type</span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-error">Tezos_protocol_environment.Error_monad.error</a> += </span></code><table><tr id="extension-Unexpected_endorsement_slot" class="anchored"><td class="def extension"><a href="#extension-Unexpected_endorsement_slot" class="anchor"></a><code><span>| </span><span><span class="extension">Unexpected_endorsement_slot</span> <span class="keyword">of</span> int</span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec type extension"><code><span><span class="keyword">type</span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-error">Tezos_protocol_environment.Error_monad.error</a> += </span></code><table><tr id="extension-Invalid_signature" class="anchored"><td class="def extension"><a href="#extension-Invalid_signature" class="anchor"></a><code><span>| </span><span><span class="extension">Invalid_signature</span></span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec type extension"><code><span><span class="keyword">type</span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-error">Tezos_protocol_environment.Error_monad.error</a> += </span></code><table><tr id="extension-Invalid_stamp" class="anchored"><td class="def extension"><a href="#extension-Invalid_stamp" class="anchor"></a><code><span>| </span><span><span class="extension">Invalid_stamp</span></span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec value" id="val-minimal_time" class="anchored"><a href="#val-minimal_time" class="anchor"></a><code><span><span class="keyword">val</span> minimal_time : <span><a href="../Alpha_context/Constants/index.html#type-parametric">Alpha_context.Constants.parametric</a> <span class="arrow">&#45;&gt;</span></span> <span>priority:int <span class="arrow">&#45;&gt;</span></span> <span><a href="../argument-1-Tezos_protocol_environment/Time/index.html#type-t">Tezos_protocol_environment.Time.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../argument-1-Tezos_protocol_environment/Time/index.html#type-t">Tezos_protocol_environment.Time.t</a> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>minimal_time ctxt priority pred_block_time</code> returns the minimal time, given the predecessor block timestamp <code>pred_block_time</code>, after which a baker with priority <code>priority</code> is allowed to bake in principle, that is, assuming the block will contain enough endorsements.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-check_timestamp" class="anchored"><a href="#val-check_timestamp" class="anchor"></a><code><span><span class="keyword">val</span> check_timestamp : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span>priority:int <span class="arrow">&#45;&gt;</span></span> <span><a href="../argument-1-Tezos_protocol_environment/Time/index.html#type-t">Tezos_protocol_environment.Time.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p><code>check_timestamp ctxt priority pred_timestamp</code> verifies that the timestamp is coherent with the announced baking slot.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-endorsement_rights" class="anchored"><a href="#val-endorsement_rights" class="anchor"></a><code><span><span class="keyword">val</span> endorsement_rights : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span><span>(<a href="../Alpha_context/index.html#type-public_key">Alpha_context.public_key</a> * <span>int list</span> * bool)</span> <a href="../argument-1-Tezos_protocol_environment/Signature/Public_key_hash/Map/index.html#type-t">Tezos_protocol_environment.Signature.Public_key_hash.Map.t</a></span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span> <a href="../argument-1-Tezos_protocol_environment/Lwt/index.html#type-t">Tezos_protocol_environment.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>For a given level computes who has the right to include an endorsement in the next block. The result can be stored in Alpha_context.allowed_endorsements</p></div></div><div class="odoc-spec"><div class="spec value" id="val-check_endorsement_rights" class="anchored"><a href="#val-check_endorsement_rights" class="anchor"></a><code><span><span class="keyword">val</span> check_endorsement_rights : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../argument-1-Tezos_protocol_environment/Chain_id/index.html#type-t">Tezos_protocol_environment.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span> <span>slot:int <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../Alpha_context/Kind/index.html#type-endorsement">Alpha_context.Kind.endorsement</a> <a href="../Alpha_context/Operation/index.html#type-t">Alpha_context.Operation.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="../Alpha_context/index.html#type-public_key_hash">Alpha_context.public_key_hash</a> * <span>int list</span> * bool)</span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span> <a href="../argument-1-Tezos_protocol_environment/Lwt/index.html#type-t">Tezos_protocol_environment.Lwt.t</a></span></span></code></div><div class="spec-doc"><p>Check that the operation was signed by a the delegate allowed to endorse at the given slot and at the level specified by the endorsement. The slot should be the smallest among the delegate's slots.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-baking_reward" class="anchored"><a href="#val-baking_reward" class="anchor"></a><code><span><span class="keyword">val</span> baking_reward : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span>block_priority:int <span class="arrow">&#45;&gt;</span></span> <span>included_endorsements:int <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/Tez/index.html#type-t">Alpha_context.Tez.t</a> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p>Returns the baking reward calculated w.r.t a given priority <code>p</code> and a number <code>e</code> of included endorsements</p></div></div><div class="odoc-spec"><div class="spec value" id="val-endorsing_reward" class="anchored"><a href="#val-endorsing_reward" class="anchor"></a><code><span><span class="keyword">val</span> endorsing_reward : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span>block_priority:int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/Tez/index.html#type-t">Alpha_context.Tez.t</a> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p>Returns the endorsing reward calculated w.r.t a given priority.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-baking_priorities" class="anchored"><a href="#val-baking_priorities" class="anchor"></a><code><span><span class="keyword">val</span> baking_priorities : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/index.html#type-public_key">Alpha_context.public_key</a> <a href="../Misc/index.html#type-lazy_list">Misc.lazy_list</a></span></span></code></div><div class="spec-doc"><p><code>baking_priorities ctxt level</code> is the lazy list of contract's public key hashes that are allowed to bake for <code>level</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-first_baking_priorities" class="anchored"><a href="#val-first_baking_priorities" class="anchor"></a><code><span><span class="keyword">val</span> first_baking_priorities : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span>?max_priority:int <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/index.html#type-public_key_hash">Alpha_context.public_key_hash</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>int list</span> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span> <a href="../argument-1-Tezos_protocol_environment/Lwt/index.html#type-t">Tezos_protocol_environment.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>first_baking_priorities ctxt ?max_priority contract_hash level</code> is a list of priorities of max <code>?max_priority</code> elements, where the delegate of <code>contract_hash</code> is allowed to bake for <code>level</code>. If <code>?max_priority</code> is <code>None</code>, a sensible number of priorities is returned.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-check_signature" class="anchored"><a href="#val-check_signature" class="anchor"></a><code><span><span class="keyword">val</span> check_signature : <span><a href="../Alpha_context/Block_header/index.html#type-t">Alpha_context.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../argument-1-Tezos_protocol_environment/Chain_id/index.html#type-t">Tezos_protocol_environment.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/index.html#type-public_key">Alpha_context.public_key</a> <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span> <a href="../argument-1-Tezos_protocol_environment/Lwt/index.html#type-t">Tezos_protocol_environment.Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>check_signature ctxt chain_id block id</code> check if the block is signed with the given key, and belongs to the given <code>chain_id</code></p></div></div><div class="odoc-spec"><div class="spec value" id="val-check_header_proof_of_work_stamp" class="anchored"><a href="#val-check_header_proof_of_work_stamp" class="anchor"></a><code><span><span class="keyword">val</span> check_header_proof_of_work_stamp : <span><a href="../Alpha_context/Block_header/index.html#type-shell_header">Alpha_context.Block_header.shell_header</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/Block_header/index.html#type-contents">Alpha_context.Block_header.contents</a> <span class="arrow">&#45;&gt;</span></span> <span>int64 <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Checks if the header that would be built from the given components is valid for the given difficulty. The signature is not passed as it is does not impact the proof-of-work stamp. The stamp is checked on the hash of a block header whose signature has been zeroed-out.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-check_proof_of_work_stamp" class="anchored"><a href="#val-check_proof_of_work_stamp" class="anchor"></a><code><span><span class="keyword">val</span> check_proof_of_work_stamp : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/Block_header/index.html#type-t">Alpha_context.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p>verify if the proof of work stamp is valid</p></div></div><div class="odoc-spec"><div class="spec value" id="val-check_fitness_gap" class="anchored"><a href="#val-check_fitness_gap" class="anchor"></a><code><span><span class="keyword">val</span> check_fitness_gap : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/Block_header/index.html#type-t">Alpha_context.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p>check if the gap between the fitness of the current context and the given block is within the protocol parameters</p></div></div><div class="odoc-spec"><div class="spec value" id="val-earlier_predecessor_timestamp" class="anchored"><a href="#val-earlier_predecessor_timestamp" class="anchor"></a><code><span><span class="keyword">val</span> earlier_predecessor_timestamp : <span><a href="../Alpha_context/index.html#type-context">Alpha_context.context</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/Level/index.html#type-t">Alpha_context.Level.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Alpha_context/Timestamp/index.html#type-t">Alpha_context.Timestamp.t</a> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span></span></code></div></div><p>Since Emmy+</p><p>A block is valid only if its timestamp has a minimal delay with respect to the previous block's timestamp, and this minimal delay depends not only on the block's priority but also on the number of endorsement operations included in the block.</p><p>In Emmy+, blocks' fitness increases by one unit with each level.</p><p>In this way, Emmy+ simplifies the optimal baking strategy: The bakers used to have to choose whether to wait for more endorsements to include in their block, or to publish the block immediately, without waiting. The incentive for including more endorsements was to increase the fitness and win against unknown blocks. However, when a block was produced too late in the priority period, there was the risk that the block did not reach endorsers before the block of next priority. In Emmy+, the baker does not need to take such a decision, because the baker cannot publish a block too early.</p><div class="odoc-spec"><div class="spec value" id="val-minimal_valid_time" class="anchored"><a href="#val-minimal_valid_time" class="anchor"></a><code><span><span class="keyword">val</span> minimal_valid_time : <span><a href="../Alpha_context/Constants/index.html#type-parametric">Alpha_context.Constants.parametric</a> <span class="arrow">&#45;&gt;</span></span> <span>priority:int <span class="arrow">&#45;&gt;</span></span> <span>endorsing_power:int <span class="arrow">&#45;&gt;</span></span>
<span>predecessor_timestamp:<a href="../argument-1-Tezos_protocol_environment/Time/index.html#type-t">Tezos_protocol_environment.Time.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../argument-1-Tezos_protocol_environment/Time/index.html#type-t">Tezos_protocol_environment.Time.t</a> <a href="../argument-1-Tezos_protocol_environment/Error_monad/index.html#type-tzresult">Tezos_protocol_environment.Error_monad.tzresult</a></span></span></code></div><div class="spec-doc"><p>Given a block priority and a number of endorsement slots (given by the `endorsing_power` argument), it returns the minimum time at which the next block can be baked.</p></div></div></div></body></html>