<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Lwt_utils_unix (tezos-stdlib-unix.Tezos_stdlib_unix.Lwt_utils_unix)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-stdlib-unix</a> &#x00BB; <a href="../index.html">Tezos_stdlib_unix</a> &#x00BB; Lwt_utils_unix</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_stdlib_unix.Lwt_utils_unix</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value" id="val-default_net_timeout" class="anchored"><a href="#val-default_net_timeout" class="anchor"></a><code><span><span class="keyword">val</span> default_net_timeout : <span><span class="xref-unresolved">Ptime</span>.Span.t <span class="xref-unresolved">Stdlib</span>.ref</span></span></code></div><div class="spec-doc"><p><code>default_net_timeout</code> is the default timeout used by functions in this library which admit a timeout value, i.e. <code>read_bytes_with_timeout</code>, <code>Socket.connect</code>, <code>Socket.recv</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-read_bytes_with_timeout" class="anchored"><a href="#val-read_bytes_with_timeout" class="anchor"></a><code><span><span class="keyword">val</span> read_bytes_with_timeout : <span>?timeout:<span class="xref-unresolved">Ptime</span>.Span.t <span class="arrow">&#45;&gt;</span></span> <span>?file_offset:int <span class="arrow">&#45;&gt;</span></span> <span>?pos:int <span class="arrow">&#45;&gt;</span></span>
<span>?len:int <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span>bytes <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>read_bytes_with_timeout ?timeout ?file_offset ?pos ?len fd buf</code> reads <code>len-pos</code> bytes from <code>fd</code> into <code>bytes</code>. If <code>file_offset</code> is given, <code>Lwt_unix</code>.pread will be used instead of <code>Lwt_unix</code>.read.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Lwt_unix.Timeout</span> <p>if the operation failed to finish within a <code>timeout</code> time span.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-read_bytes" class="anchored"><a href="#val-read_bytes" class="anchor"></a><code><span><span class="keyword">val</span> read_bytes : <span>?file_offset:int <span class="arrow">&#45;&gt;</span></span> <span>?pos:int <span class="arrow">&#45;&gt;</span></span> <span>?len:int <span class="arrow">&#45;&gt;</span></span>
<span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span>bytes <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>read_bytes ?file_offset ?pos ?len fd buf</code> reads <code>len-pos</code> bytes from <code>fd</code> into <code>bytes</code>. If <code>file_offset</code> is given, <code>Lwt_unix</code>.pread will be used instead of <code>Lwt_unix</code>.read.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-write_string" class="anchored"><a href="#val-write_string" class="anchor"></a><code><span><span class="keyword">val</span> write_string : <span>?pos:int <span class="arrow">&#45;&gt;</span></span> <span>?len:int <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-write_bytes" class="anchored"><a href="#val-write_bytes" class="anchor"></a><code><span><span class="keyword">val</span> write_bytes : <span>?file_offset:int <span class="arrow">&#45;&gt;</span></span> <span>?pos:int <span class="arrow">&#45;&gt;</span></span> <span>?len:int <span class="arrow">&#45;&gt;</span></span>
<span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Stdlib</span>.Bytes.t <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>write_bytes ?file_offset ?pos ?len fd buf</code> writes <code>len-pos</code> bytes from <code>bytes</code> to <code>fd</code>. If <code>file_offset</code> is given, <code>Lwt_unix</code>.pwrite will be used instead of <code>Lwt_unix</code>.write.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Lwt_unix.Timeout</span> <p>if the operation failed to finish within a <code>timeout</code> time span.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-is_directory" class="anchored"><a href="#val-is_directory" class="anchor"></a><code><span><span class="keyword">val</span> is_directory : <span>string <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>is_directory path</code> tests if the given <code>path</code> refers to a directory (file kind is <code>S_DIR</code>). Returns <code>false</code> if <code>path</code> refers to a symbolic link.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-remove_dir" class="anchored"><a href="#val-remove_dir" class="anchor"></a><code><span><span class="keyword">val</span> remove_dir : <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-create_dir" class="anchored"><a href="#val-create_dir" class="anchor"></a><code><span><span class="keyword">val</span> create_dir : <span>?perm:int <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-copy_dir" class="anchored"><a href="#val-copy_dir" class="anchor"></a><code><span><span class="keyword">val</span> copy_dir : <span>?perm:int <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>copy_dir ?perm src dst</code> copies the content of directory <code>src</code> in a fresh directory <code>dst</code> created with <code>perm</code> (0o755 by default).</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Unix_error(ENOTDIR,_,_)</span> <p>if the given file is not a directory.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-read_file" class="anchored"><a href="#val-read_file" class="anchor"></a><code><span><span class="keyword">val</span> read_file : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-copy_file" class="anchored"><a href="#val-copy_file" class="anchor"></a><code><span><span class="keyword">val</span> copy_file : <span>src:string <span class="arrow">&#45;&gt;</span></span> <span>dst:string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-create_file" class="anchored"><a href="#val-create_file" class="anchor"></a><code><span><span class="keyword">val</span> create_file : <span>?close_on_exec:bool <span class="arrow">&#45;&gt;</span></span> <span>?perm:int <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-with_tempdir" class="anchored"><a href="#val-with_tempdir" class="anchor"></a><code><span><span class="keyword">val</span> with_tempdir : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>string <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-safe_close" class="anchored"><a href="#val-safe_close" class="anchor"></a><code><span><span class="keyword">val</span> safe_close : <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span><span>unit <a href="../../../tezos-error-monad/Tezos_error_monad/Error_monad/index.html#type-tzresult">Tezos_error_monad.Error_monad.tzresult</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-getaddrinfo" class="anchored"><a href="#val-getaddrinfo" class="anchor"></a><code><span><span class="keyword">val</span> getaddrinfo : <span>passive:bool <span class="arrow">&#45;&gt;</span></span> <span>node:string <span class="arrow">&#45;&gt;</span></span> <span>service:string <span class="arrow">&#45;&gt;</span></span>
<span><span><span>(<span class="xref-unresolved">Ipaddr</span>.V6.t * int)</span> list</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-getpass" class="anchored"><a href="#val-getpass" class="anchor"></a><code><span><span class="keyword">val</span> getpass : <span>unit <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>getpass ()</code> reads a password from stdio while setting-up the terminal to not display the password being typed.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Json" class="anchored"><a href="#module-Json" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Json/index.html">Json</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-retry" class="anchored"><a href="#val-retry" class="anchor"></a><code><span><span class="keyword">val</span> retry : <span>?log:<span>(<span><span class="type-var">'error</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span>?n:int <span class="arrow">&#45;&gt;</span></span> <span>?sleep:float <span class="arrow">&#45;&gt;</span></span>
<span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>,Â <span class="type-var">'error</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>,Â <span class="type-var">'error</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-io_error" class="anchored"><a href="#type-io_error" class="anchor"></a><code><span><span class="keyword">type</span> <span>'action io_error</span></span><span> = </span><span>{</span></code><table><tr id="type-io_error.action" class="anchored"><td class="def record field"><a href="#type-io_error.action" class="anchor"></a><code><span>action : <span class="type-var">'action</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>action which triggerred the error.</p><span class="comment-delim">*)</span></td></tr><tr id="type-io_error.unix_code" class="anchored"><td class="def record field"><a href="#type-io_error.unix_code" class="anchor"></a><code><span>unix_code : <span class="xref-unresolved">Unix</span>.error;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Unix code error.</p><span class="comment-delim">*)</span></td></tr><tr id="type-io_error.caller" class="anchored"><td class="def record field"><a href="#type-io_error.caller" class="anchor"></a><code><span>caller : string;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Unix function which triggerred the error.</p><span class="comment-delim">*)</span></td></tr><tr id="type-io_error.arg" class="anchored"><td class="def record field"><a href="#type-io_error.arg" class="anchor"></a><code><span>arg : string;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Argument given to the unix function: generally a path.</p><span class="comment-delim">*)</span></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p><code>with_io_error</code> aims to be used as the error type for the <code>with_*</code> functions below. The <code>action</code> type is the action which trigerred the error.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_open_file" class="anchored"><a href="#val-with_open_file" class="anchor"></a><code><span><span class="keyword">val</span> with_open_file : <span>flags:<span><span class="xref-unresolved">Unix</span>.open_flag list</span> <span class="arrow">&#45;&gt;</span></span> <span>?perm:<span class="xref-unresolved">Unix</span>.file_perm <span class="arrow">&#45;&gt;</span></span>
<span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>,Â <span><span>[ `Open <span>| `Close</span> ]</span> <a href="#type-io_error">io_error</a></span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>with_open_file ~flags ~perm filename f</code> opens the given file using <code>Lwt_unix</code>.open_file and passes the resulting file-descriptor to <code>f</code>. <code>with_open_file</code> ensures that the file-descriptor is closed when the promise returned by <code>f</code> resolves, or if <code>f</code> raises an exception.</p><p>See <code>Lwt_unix</code>.openfile for a description of the arguments, warnings, and other notes. Default values for <code>perm</code> is <code>0o640</code>.</p><p>Exceptions raised whilst opening or closing the file are wrapped in <code>Error</code>. When the error is <code>`Open</code>, the file could not be opened, and therefore the function <code>f</code> has not been run. When the error is <code>`Closed</code>, the function <code>f</code> was run but the file could not be closed.</p><p>Other exceptions are reraised.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_open_out" class="anchored"><a href="#val-with_open_out" class="anchor"></a><code><span><span class="keyword">val</span> with_open_out : <span>?overwrite:bool <span class="arrow">&#45;&gt;</span></span>
<span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>,Â <span><span>[ `Open <span>| `Close</span> ]</span> <a href="#type-io_error">io_error</a></span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>with_open_out ?overwrite filename f</code> uses <code>with_open_file</code> with the flags <code>O_WRONLY; O_CREAT; O_CLOEXEC</code> and the default permissions. The flag <code>O_TRUNC</code> is added if <code>overwrite</code> is <code>true</code>, which is the case by default.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_atomic_open_out" class="anchored"><a href="#val-with_atomic_open_out" class="anchor"></a><code><span><span class="keyword">val</span> with_atomic_open_out : <span>?overwrite:bool <span class="arrow">&#45;&gt;</span></span> <span>?temp_dir:string <span class="arrow">&#45;&gt;</span></span>
<span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>,Â <span><span>[ `Open <span>| `Close</span> <span>| `Rename</span> ]</span> <a href="#type-io_error">io_error</a></span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>with_atomic_open_out ?overwrite ?temp_dir filename f</code> is a wrapper around <code>with_open_out</code> were it ensures that the data are written onto <code>filename</code> in an atomic way.</p><p>This function uses a temporary file stored in the <code>temp_dir</code> directory. Then, this temporary filed is renamed as <code>filename</code>.</p><p>The renaming may fail, for example if the temporary file is not on the same partition as <code>filename</code>.</p><p>If the renaming fails, an error <code>`Rename</code> is returned. See <a href="#val-with_open_file"><code>with_open_file</code></a> for a description of the other errors. In that case, no write have been done on <code>filename</code>.</p><p>The default value of <code>temp_dir</code> is the same as <code>Filename.temp_file</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-with_open_in" class="anchored"><a href="#val-with_open_in" class="anchor"></a><code><span><span class="keyword">val</span> with_open_in : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>,Â <span><span>[ `Open <span>| `Close</span> ]</span> <a href="#type-io_error">io_error</a></span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>with_open_in filename f</code> uses <code>with_open_file</code> with the flags <code>O_RDONLY; O_CLOEXEC</code> and the default permissions.</p></div></div></div></body></html>