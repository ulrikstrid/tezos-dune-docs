<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tezos_shell__Consensus_heuristic (tezos-shell.Tezos_shell__Consensus_heuristic)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">tezos-shell</a> &#x00BB; Tezos_shell__Consensus_heuristic</nav><h1>Module <code>Tezos_shell__Consensus_heuristic</code></h1><h3 id="consensus-heuristic"><a href="#consensus-heuristic" class="anchor"></a>Consensus heuristic</h3><nav class="toc"><ul><li><a href="#consensus-heuristic-worker">Consensus heuristic worker</a></li></ul></nav></header><aside><p>A consensus heuristic is a mechanism by which a node attempts to find a data that its network of peers generally agrees upon. Typically, the node attempts to find out what the p2p network as a whole agrees is the head of the chain.</p><p>Note that, by nature, this problem does not necessarily have one exact solution. This is a heuristic, it makes a &quot;best guess&quot; based on information available locally.</p><p>The consensus heuristic is given <em>candidates</em>: tuples of the form <code>p,d</code> where <code>d</code> is the data and <code>p</code> is a peer id indicating the provenance of the data. Typically, a candidate indicates what a peer considers to be the head of the chain.</p><p>The consensus heuristic is parametrized by two values:</p><ul><li><em>expected</em> is the number of candidates that the heuristic keeps internally,</li><li><em>threshold</em> is the number of candidates that need to agree on their data for a consensus to be reached.</li></ul><p>A precondition for the heuristic is that <code>0 &lt;= threshold &lt;= expected &lt; 2 * threshold</code> to ensure a unique consensus value.</p></aside><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> <span>'a t</span></code></dt><dd><p><code>'a t</code> is the abstract internal state for the consensus heuristic mechanism. <code>'a</code> is the type of the data that needs to be agreed upon.</p><p>Note that these values are intended to be short-lived, one shot. Specifically, these values are not meant to be used over a long period of time during which there is churn in the set of p2p neighbors.</p></dd></dl><dl><dt class="spec type" id="type-state"><a href="#type-state" class="anchor"></a><code><span class="keyword">type</span> <span>'a state</span></code><code> = </code><table class="variant"><tr id="type-state.Consensus" class="anchored"><td class="def constructor"><a href="#type-state.Consensus" class="anchor"></a><code>| </code><code><span class="constructor">Consensus</span> <span class="keyword">of</span> <span class="type-var">'a</span></code></td></tr><tr id="type-state.No_consensus" class="anchored"><td class="def constructor"><a href="#type-state.No_consensus" class="anchor"></a><code>| </code><code><span class="constructor">No_consensus</span> <span class="keyword">of</span> <span><span>(<span class="type-var">'a</span> * int)</span> list</span></code></td></tr><tr id="type-state.Need_more_candidates" class="anchored"><td class="def constructor"><a href="#type-state.Need_more_candidates" class="anchor"></a><code>| </code><code><span class="constructor">Need_more_candidates</span></code></td></tr></table></dt><dd><p>The three different states that the heuristic can be in.</p><ul><li>If the heuristic received less than <em>expected</em> candidates and no candidates' data has <em>threshold</em> occurrences, then its state is <code>Need_more_candidates</code>.</li></ul><ul><li>If the heuristic received <em>expected</em> (or more) candidates but no candidates' data has <em>threshold</em> occurrences, its state is <code>No_consensus</code>. The payload for the constructor lists all the candidates' data with the number of their occurrences.</li></ul><ul><li>Otherwise there is some candidates' data that has <em>threshold</em> occurrences or more and the state is <code>Consensus</code>.</li></ul></dd></dl><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <span>?&#8288;compare:<span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> int)</span></span> <span>&#45;&gt;</span> <span>expected:int</span> <span>&#45;&gt;</span> <span>threshold:int</span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>create ~compare ~expected ~threshold ()</code> is a fresh heuristic state.</p><p><code>compare</code> is used internally to instantiate a map of candidates. It must be a total order over the type of data, but the specific of the order has no effect on the consensus.</p><dl><dt>raises [Invalid_argument]</dt><dd><p>if not <code>0 &lt;= threshold &lt;= expected &lt; 2 * threshold</code></p></dd></dl></dd></dl><dl><dt class="spec value" id="val-get_state"><a href="#val-get_state" class="anchor"></a><code><span class="keyword">val</span> get_state : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-state">state</a></span></code></dt><dd><p><code>get_state heuristic</code> returns the current <a href="index.html#type-state"><code>state</code></a> of the heuristic according to the semantics given above.</p></dd></dl><dl><dt class="spec value" id="val-update"><a href="#val-update" class="anchor"></a><code><span class="keyword">val</span> update : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>(<a href="../../tezos-base/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> * <span class="type-var">'a</span>)</span> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>update heuristic (peer, data)</code> updates the heuristic with the candidate <code>(peer, data)</code>. If a data was already registered for <code>peer</code>, then it is replaced by the update. It is the responsibility of the caller given a peer to update better and better data (for the caller's notion of &quot;better&quot;).</p></dd></dl><section><header><h3 id="consensus-heuristic-worker"><a href="#consensus-heuristic-worker" class="anchor"></a>Consensus heuristic worker</h3></header><dl><dt class="spec module" id="module-Worker"><a href="#module-Worker" class="anchor"></a><code><span class="keyword">module</span> <a href="Worker/index.html">Worker</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>This worker implements a memoisation mechanism for the consensus heuristic with an expiry date mechanism. The worker also handles a hook mechanism to be executed on values found by the consensus heuristic.</p></dd></dl></section></div></body></html>