<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Distributed_db (tezos-shell.Tezos_shell.Distributed_db)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">tezos-shell</a> &#x00BB; <a href="../index.html">Tezos_shell</a> &#x00BB; Distributed_db</nav><h1>Module <code>Tezos_shell.Distributed_db</code></h1><nav class="toc"><ul><li><a href="#network-database">Network database</a></li><li><a href="#sending-messages">Sending messages</a><ul><li><a href="#block-index">Block index</a></li><li><a href="#operations-index">Operations index</a></li><li><a href="#protocol-index">Protocol index</a></li></ul></li></ul></nav></header><aside><p>Tezos Shell - High-level API for the Gossip network and local storage.</p><p>It provides functions to query *static* resources such as blocks headers, operations, and functions to access dynamic resources such as heads and chains.</p><p>Several chains (mainchain, testchain, ...) can be managed independently. First a chain is activated using <code>activate</code>, which provides a <code>chain_db</code> from which it is possible to access resources. Eventually the chain is deactivated using <code>deactivate</code>.</p><p>Static resources are accessible via &quot;Requester&quot; modules (<code>Block_header</code>, <code>Operation</code>, <code>Operations</code>, <code>Protocol</code>). These modules act as read-through caches in front of the local storage <code>State</code> and the p2p layer. They centralize concurrent requests, and cache results in memory. They don't update <code>State</code> directly.</p><p>For instance, from a block_header hash, one can fetch the actual block header using <code>Block_header.fetch</code>, then the block operations with <code>Operations.fetch</code>.</p></aside><div class="spec module" id="module-Message"><a href="#module-Message" class="anchor"></a><code><span class="keyword">module</span> Message = <a href="../index.html#module-Distributed_db_message">Distributed_db_message</a></code></div><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dt class="spec type" id="type-db"><a href="#type-db" class="anchor"></a><code><span class="keyword">type</span> db</code><code> = <a href="index.html#type-t">t</a></code></dt><dt class="spec type" id="type-p2p"><a href="#type-p2p" class="anchor"></a><code><span class="keyword">type</span> p2p</code><code> = <span><span>(<a href="../Distributed_db_message/index.html#type-t">Message.t</a>, <a href="../../../tezos-p2p-services/Tezos_p2p_services/Peer_metadata/index.html#type-t">Tezos_p2p_services.Peer_metadata.t</a>, <a href="../../../tezos-p2p-services/Tezos_p2p_services/Connection_metadata/index.html#type-t">Tezos_p2p_services.Connection_metadata.t</a>)</span> <a href="../../../tezos-p2p/Tezos_p2p/P2p/index.html#type-net">Tezos_p2p.P2p.net</a></span></code></dt></dl><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <a href="../../../tezos-store/Tezos_store/Store/index.html#type-t">Tezos_store.Store.t</a> <span>&#45;&gt;</span> <a href="index.html#type-p2p">p2p</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dt class="spec value" id="val-store"><a href="#val-store" class="anchor"></a><code><span class="keyword">val</span> store : <a href="index.html#type-db">db</a> <span>&#45;&gt;</span> <a href="../../../tezos-store/Tezos_store/Store/index.html#type-t">Tezos_store.Store.t</a></code></dt><dt class="spec value" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span class="keyword">val</span> shutdown : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt></dl><section><header><h2 id="network-database"><a href="#network-database" class="anchor"></a>Network database</h2></header><dl><dt class="spec type" id="type-chain_db"><a href="#type-chain_db" class="anchor"></a><code><span class="keyword">type</span> chain_db</code></dt><dd><p>An instance of the distributed DB for a given chain</p></dd></dl><dl><dt class="spec value" id="val-activate"><a href="#val-activate" class="anchor"></a><code><span class="keyword">val</span> activate : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-store/Tezos_store/Store/Chain/index.html#type-t">Tezos_store.Store.Chain.t</a> <span>&#45;&gt;</span> <a href="../P2p_reader/index.html#type-callback">P2p_reader.callback</a> <span>&#45;&gt;</span> <a href="index.html#type-chain_db">chain_db</a></code></dt><dd><p>The first call to <code>activate t chain callbacks</code> activates <code>chain</code>, creates a <code>chain_db</code> and sends a <code>Get_current_branch chain_id</code> message to all neighbors, where <code>chain_id</code> is the identifier of <code>chain</code>. This informs the neighbors that this node expects notifications for new heads/mempools. The given <code>callbacks</code> are given to the <code>P2p_reader</code> for each <code>peer</code>:</p><ul><li><code>notify_branch peer locator</code> is called when the <code>P2p_reader</code> receives the message <code>Current_branch (chain, locator)</code> from peer <code>peer</code>.</li></ul><ul><li><code>notify_head peer head</code> is called when the <code>P2p_reader</code> receives the message <code>Current_head (chain, head, mempool)</code> from peer <code>peer</code>.</li></ul><ul><li><code>Disconnection peer</code> is called when the <code>P2p_reader</code> receives the message <code>Deactivate chain</code> from peer <code>peer</code> or when the <code>P2p_reader</code> associated to <code>peer</code> is shutdown.</li></ul><p>Subsequent calls simply return the existing <code>chain_db</code>.</p></dd></dl><dl><dt class="spec value" id="val-get_chain"><a href="#val-get_chain" class="anchor"></a><code><span class="keyword">val</span> get_chain : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Chain_id/index.html#type-t">Tezos_crypto.Chain_id.t</a> <span>&#45;&gt;</span> <span><a href="index.html#type-chain_db">chain_db</a> option</span></code></dt><dd><p>Look for the database of an active chain.</p></dd></dl><dl><dt class="spec value" id="val-deactivate"><a href="#val-deactivate" class="anchor"></a><code><span class="keyword">val</span> deactivate : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>deactivate chain_db</code> sends a <code>Deactivate chain_id</code> message to all active neighbors for this chain. This notifies them that this node isn't interested in messages for this chain</p></dd></dl><dl><dt class="spec value" id="val-disconnect"><a href="#val-disconnect" class="anchor"></a><code><span class="keyword">val</span> disconnect : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <a href="../../../tezos-base/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p>Kick a given peer.</p></dd></dl><dl><dt class="spec value" id="val-greylist"><a href="#val-greylist" class="anchor"></a><code><span class="keyword">val</span> greylist : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <a href="../../../tezos-base/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p>Greylist a given peer.</p></dd></dl><aside><p>Various accessors.</p></aside><dl><dt class="spec value" id="val-chain_store"><a href="#val-chain_store" class="anchor"></a><code><span class="keyword">val</span> chain_store : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <a href="../../../tezos-store/Tezos_store/Store/index.html#type-chain_store">Tezos_store.Store.chain_store</a></code></dt><dt class="spec value" id="val-db"><a href="#val-db" class="anchor"></a><code><span class="keyword">val</span> db : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <a href="index.html#type-db">db</a></code></dt><dt class="spec value" id="val-information"><a href="#val-information" class="anchor"></a><code><span class="keyword">val</span> information : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <a href="../../../tezos-shell-services/Tezos_shell_services/Chain_validator_worker_state/Distributed_db_state/index.html#type-view">Tezos_shell_services.Chain_validator_worker_state.Distributed_db_state.view</a></code></dt><dt class="spec value" id="val-my_peer_id"><a href="#val-my_peer_id" class="anchor"></a><code><span class="keyword">val</span> my_peer_id : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <a href="../../../tezos-base/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a></code></dt><dd><p>Return the peer id of the node</p></dd></dl><dl><dt class="spec value" id="val-get_peer_metadata"><a href="#val-get_peer_metadata" class="anchor"></a><code><span class="keyword">val</span> get_peer_metadata : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <a href="../../../tezos-base/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span>&#45;&gt;</span> <a href="../../../tezos-p2p-services/Tezos_p2p_services/Peer_metadata/index.html#type-t">Tezos_p2p_services.Peer_metadata.t</a></code></dt></dl></section><section><header><h2 id="sending-messages"><a href="#sending-messages" class="anchor"></a>Sending messages</h2></header><div class="spec module" id="module-Request"><a href="#module-Request" class="anchor"></a><code><span class="keyword">module</span> <a href="Request/index.html">Request</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Advertise"><a href="#module-Advertise" class="anchor"></a><code><span class="keyword">module</span> <a href="Advertise/index.html">Advertise</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><section><header><h3 id="block-index"><a href="#block-index" class="anchor"></a>Block index</h3></header><dl><dt class="spec module" id="module-Block_header"><a href="#module-Block_header" class="anchor"></a><code><span class="keyword">module</span> <a href="Block_header/index.html">Block_header</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Index of block headers.</p></dd></dl><dl><dt class="spec module" id="module-Operations"><a href="#module-Operations" class="anchor"></a><code><span class="keyword">module</span> <a href="Operations/index.html">Operations</a> : <a href="../../../tezos-requester/Tezos_requester/Requester/index.html#module-type-REQUESTER">Tezos_requester.Requester.REQUESTER</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="../../../tezos-requester/Tezos_requester/Requester/module-type-REQUESTER/index.html#type-t">t</a> := <a href="index.html#type-chain_db">chain_db</a> <span class="keyword">and</span> <span class="keyword">type</span> <a href="../../../tezos-requester/Tezos_requester/Requester/module-type-REQUESTER/index.html#type-key">key</a> = <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> * int <span class="keyword">and</span> <span class="keyword">type</span> <a href="../../../tezos-requester/Tezos_requester/Requester/module-type-REQUESTER/index.html#type-value">value</a> = <span><a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> list</span> <span class="keyword">and</span> <span class="keyword">type</span> <a href="../../../tezos-requester/Tezos_requester/Requester/module-type-REQUESTER/index.html#type-param">param</a> := <a href="../../../tezos-crypto/Tezos_crypto/Operation_list_list_hash/index.html#type-t">Tezos_crypto.Operation_list_list_hash.t</a></code></dt><dd><p>Index of all the operations of a given block (per validation pass).</p></dd></dl><dl><dt class="spec value" id="val-commit_block"><a href="#val-commit_block" class="anchor"></a><code><span class="keyword">val</span> commit_block : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <a href="Block_header/index.html#type-t">Block_header.t</a> <span>&#45;&gt;</span> <span><span><a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> list</span> list</span> <span>&#45;&gt;</span> <a href="../../../tezos-validation/Tezos_validation/Block_validation/index.html#type-result">Tezos_validation.Block_validation.result</a> <span>&#45;&gt;</span> <span><span><span><a href="../../../tezos-store/Tezos_store/Store/Block/index.html#type-t">Tezos_store.Store.Block.t</a> option</span> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p>Store on disk all the data associated to a valid block.</p></dd></dl><dl><dt class="spec value" id="val-commit_invalid_block"><a href="#val-commit_invalid_block" class="anchor"></a><code><span class="keyword">val</span> commit_invalid_block : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <a href="Block_header/index.html#type-t">Block_header.t</a> <span>&#45;&gt;</span> <span><a href="../../../tezos-base/Tezos_base__TzPervasives/Error_monad/index.html#type-error">Tezos_base__TzPervasives.Error_monad.error</a> list</span> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p>Store on disk all the data associated to an invalid block.</p></dd></dl></section><section><header><h3 id="operations-index"><a href="#operations-index" class="anchor"></a>Operations index</h3></header><dl><dt class="spec module" id="module-Operation"><a href="#module-Operation" class="anchor"></a><code><span class="keyword">module</span> <a href="Operation/index.html">Operation</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Index of operations (for the mempool).</p></dd></dl><dl><dt class="spec value" id="val-inject_operation"><a href="#val-inject_operation" class="anchor"></a><code><span class="keyword">val</span> inject_operation : <a href="index.html#type-chain_db">chain_db</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Operation_hash/index.html#type-t">Tezos_crypto.Operation_hash.t</a> <span>&#45;&gt;</span> <a href="Operation/index.html#type-t">Operation.t</a> <span>&#45;&gt;</span> <span>bool Lwt.t</span></code></dt><dd><p>Inject a new operation in the local index (memory only).</p></dd></dl></section><section><header><h3 id="protocol-index"><a href="#protocol-index" class="anchor"></a>Protocol index</h3></header><dl><dt class="spec module" id="module-Protocol"><a href="#module-Protocol" class="anchor"></a><code><span class="keyword">module</span> <a href="Protocol/index.html">Protocol</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Index of protocol sources.</p></dd></dl><dl><dt class="spec value" id="val-commit_protocol"><a href="#val-commit_protocol" class="anchor"></a><code><span class="keyword">val</span> commit_protocol : <a href="index.html#type-db">db</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Protocol_hash/index.html#type-t">Tezos_crypto.Protocol_hash.t</a> <span>&#45;&gt;</span> <a href="Protocol/index.html#type-t">Protocol.t</a> <span>&#45;&gt;</span> <span><span>bool <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p>Store on disk protocol sources.</p></dd></dl></section></section></div></body></html>