<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Prevalidator (tezos-shell.Tezos_shell.Prevalidator)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">tezos-shell</a> &#x00BB; <a href="../index.html">Tezos_shell</a> &#x00BB; Prevalidator</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_shell.Prevalidator</span></code></h1><p>Tezos Shell - Prevalidation of pending operations (a.k.a Mempool)</p></header><div class="odoc-content"><p>The prevalidator is in charge of the &quot;mempool&quot; (a.k.a. the set of known not-invalid-for-sure operations that are not yet included in the blockchain).</p><p>The prevalidator also maintains a sorted subset of the mempool that might correspond to a valid block on top of the current head. The &quot;in-progress&quot; context produced by the application of those operations is called the (pre)validation context.</p><p>Before including an operation into the mempool, the prevalidation worker tries to append the operation the prevalidation context. If the operation is (strongly) refused, it will not be added into the mempool and then it will be ignored by the node and never broadcast. If the operation is only &quot;branch_refused&quot; or &quot;branch_delayed&quot;, the operation won't be appended in the prevalidation context, but still broadcast.</p><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>An (abstract) prevalidator context. Separate prevalidator contexts should be * used for separate chains (e.g., mainchain vs testchain).</p></div></div><div class="odoc-spec"><div class="spec type" id="type-limits" class="anchored"><a href="#type-limits" class="anchor"></a><code><span><span class="keyword">type</span> limits</span><span> = </span><span>{</span></code><table><tr id="type-limits.max_refused_operations" class="anchored"><td class="def record field"><a href="#type-limits.max_refused_operations" class="anchor"></a><code><span>max_refused_operations : int;</span></code></td></tr><tr id="type-limits.operation_timeout" class="anchored"><td class="def record field"><a href="#type-limits.operation_timeout" class="anchor"></a><code><span>operation_timeout : <a href="../../../tezos-base/Tezos_base/Time/System/Span/index.html#type-t">Tezos_base.Time.System.Span.t</a>;</span></code></td></tr><tr id="type-limits.worker_limits" class="anchored"><td class="def record field"><a href="#type-limits.worker_limits" class="anchor"></a><code><span>worker_limits : <a href="../../../tezos-base/Tezos_base/Worker_types/index.html#type-limits">Tezos_base.Worker_types.limits</a>;</span></code></td></tr><tr id="type-limits.operations_batch_size" class="anchored"><td class="def record field"><a href="#type-limits.operations_batch_size" class="anchor"></a><code><span>operations_batch_size : int;</span></code></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span><a href="#type-limits">limits</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="keyword">module</span> <a href="../Prevalidator_filters/module-type-FILTER/index.html">Prevalidator_filters.FILTER</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Distributed_db/index.html#type-chain_db">Distributed_db.chain_db</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-t">t</a>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Creates/tear-down a new prevalidator context.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-shutdown" class="anchored"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-notify_operations" class="anchored"><a href="#val-notify_operations" class="anchor"></a><code><span><span class="keyword">val</span> notify_operations : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-base/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-base/Tezos_base/Mempool/index.html#type-t">Tezos_base.Mempool.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Notify the prevalidator that the identified peer has sent a bunch of * operations relevant to the specified context.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-inject_operation" class="anchored"><a href="#val-inject_operation" class="anchor"></a><code><span><span class="keyword">val</span> inject_operation : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Notify the prevalidator worker of a new injected operation.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-flush" class="anchored"><a href="#val-flush" class="anchor"></a><code><span><span class="keyword">val</span> flush : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/Set/index.html#type-t">Tezos_crypto.Block_hash.Set.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Operation_hash/Set/index.html#type-t">Tezos_crypto.Operation_hash.Set.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Notify the prevalidator that a new head has been selected.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-timestamp" class="anchored"><a href="#val-timestamp" class="anchor"></a><code><span><span class="keyword">val</span> timestamp : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-base/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a></span></code></div><div class="spec-doc"><p>Returns the timestamp of the prevalidator worker, that is the timestamp of the last reset of the prevalidation context</p></div></div><div class="odoc-spec"><div class="spec value" id="val-fitness" class="anchored"><a href="#val-fitness" class="anchor"></a><code><span><span class="keyword">val</span> fitness : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-base/Tezos_base/Fitness/index.html#type-t">Tezos_base.Fitness.t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Returns the fitness of the current prevalidation context</p></div></div><div class="odoc-spec"><div class="spec value" id="val-operations" class="anchored"><a href="#val-operations" class="anchor"></a><code><span><span class="keyword">val</span> operations : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> <a href="../../../tezos-base/Tezos_base/Preapply_result/index.html#type-t">Tezos_base.Preapply_result.t</a></span> * <span><a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <a href="../../../tezos-crypto/Tezos_crypto/Operation_hash/Map/index.html#type-t">Tezos_crypto.Operation_hash.Map.t</a></span></span></code></div><div class="spec-doc"><p>Returns the list of valid operations known to this prevalidation worker</p></div></div><div class="odoc-spec"><div class="spec value" id="val-pending" class="anchored"><a href="#val-pending" class="anchor"></a><code><span><span class="keyword">val</span> pending : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <a href="../../../tezos-crypto/Tezos_crypto/Operation_hash/Map/index.html#type-t">Tezos_crypto.Operation_hash.Map.t</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Returns the list of pending operations known to this prevalidation worker</p></div></div><div class="odoc-spec"><div class="spec value" id="val-running_workers" class="anchored"><a href="#val-running_workers" class="anchor"></a><code><span><span class="keyword">val</span> running_workers : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="../../../tezos-crypto/Tezos_crypto/Chain_id/index.html#type-t">Tezos_crypto.Chain_id.t</a> * <a href="../../../tezos-crypto/Tezos_crypto/Protocol_hash/index.html#type-t">Tezos_crypto.Protocol_hash.t</a> * <a href="#type-t">t</a>)</span> list</span></span></code></div><div class="spec-doc"><p>Returns the list of prevalidation contexts running and their associated chain</p></div></div><p>Two functions that are useful for managing the prevalidator's transition * from one protocol to the next.</p><div class="odoc-spec"><div class="spec value" id="val-protocol_hash" class="anchored"><a href="#val-protocol_hash" class="anchor"></a><code><span><span class="keyword">val</span> protocol_hash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-crypto/Tezos_crypto/Protocol_hash/index.html#type-t">Tezos_crypto.Protocol_hash.t</a></span></code></div><div class="spec-doc"><p>Returns the hash of the protocol the prevalidator was instantiated with</p></div></div><div class="odoc-spec"><div class="spec value" id="val-parameters" class="anchored"><a href="#val-parameters" class="anchor"></a><code><span><span class="keyword">val</span> parameters : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-limits">limits</a> * <a href="../Distributed_db/index.html#type-chain_db">Distributed_db.chain_db</a></span></code></div><div class="spec-doc"><p>Returns the parameters the prevalidator was created with.</p></div></div><p>Worker status and events</p><div class="odoc-spec"><div class="spec value" id="val-status" class="anchored"><a href="#val-status" class="anchor"></a><code><span><span class="keyword">val</span> status : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-base/Tezos_base/Worker_types/index.html#type-worker_status">Tezos_base.Worker_types.worker_status</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-pending_requests" class="anchored"><a href="#val-pending_requests" class="anchor"></a><code><span><span class="keyword">val</span> pending_requests : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="../../../tezos-base/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a> * <a href="../../../tezos-shell-services/Tezos_shell_services/Prevalidator_worker_state/Request/index.html#type-view">Tezos_shell_services.Prevalidator_worker_state.Request.view</a>)</span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-current_request" class="anchored"><a href="#val-current_request" class="anchor"></a><code><span><span class="keyword">val</span> current_request : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="../../../tezos-base/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a> * <a href="../../../tezos-base/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a> * <a href="../../../tezos-shell-services/Tezos_shell_services/Prevalidator_worker_state/Request/index.html#type-view">Tezos_shell_services.Prevalidator_worker_state.Request.view</a>)</span> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-last_events" class="anchored"><a href="#val-last_events" class="anchor"></a><code><span><span class="keyword">val</span> last_events : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="../../../tezos-event-logging/Tezos_event_logging/Internal_event/index.html#type-level">Tezos_event_logging.Internal_event.level</a> * <span><a href="../../../tezos-shell-services/Tezos_shell_services/Prevalidator_worker_state/Event/index.html#type-t">Tezos_shell_services.Prevalidator_worker_state.Event.t</a> list</span>)</span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-information" class="anchored"><a href="#val-information" class="anchor"></a><code><span><span class="keyword">val</span> information : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-base/Tezos_base/Worker_types/index.html#type-worker_information">Tezos_base.Worker_types.worker_information</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-pipeline_length" class="anchored"><a href="#val-pipeline_length" class="anchor"></a><code><span><span class="keyword">val</span> pipeline_length : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-rpc_directory" class="anchored"><a href="#val-rpc_directory" class="anchor"></a><code><span><span class="keyword">val</span> rpc_directory : <span><span><a href="#type-t">t</a> option</span> <a href="../../../tezos-rpc/Tezos_rpc/RPC_directory/index.html#type-t">Tezos_rpc.RPC_directory.t</a></span></span></code></div></div></div></body></html>