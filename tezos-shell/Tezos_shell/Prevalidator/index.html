<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Prevalidator (tezos-shell.Tezos_shell.Prevalidator)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-shell</a> &#x00BB; <a href="../index.html">Tezos_shell</a> &#x00BB; Prevalidator</nav><h1>Module <code>Tezos_shell.Prevalidator</code></h1></header><aside><p>Tezos Shell - Prevalidation of pending operations (a.k.a Mempool)</p></aside><aside><p>The prevalidator is in charge of the &quot;mempool&quot; (a.k.a. the set of known not-invalid-for-sure operations that are not yet included in the blockchain).</p><p>The prevalidator also maintains a sorted subset of the mempool that might correspond to a valid block on top of the current head. The &quot;in-progress&quot; context produced by the application of those operations is called the (pre)validation context.</p><p>Before including an operation into the mempool, the prevalidation worker tries to append the operation the prevalidation context. If the operation is (strongly) refused, it will not be added into the mempool and then it will be ignored by the node and never broadcast. If the operation is only &quot;branch_refused&quot; or &quot;branch_delayed&quot;, the operation won't be appended in the prevalidation context, but still broadcast.</p></aside><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dd><p>An (abstract) prevalidator context. Separate prevalidator contexts should be * used for separate chains (e.g., mainchain vs testchain).</p></dd></dl><dl><dt class="spec type" id="type-limits"><a href="#type-limits" class="anchor"></a><code><span class="keyword">type</span> limits</code><code> = </code><code>{</code><table class="record"><tr id="type-limits.max_refused_operations" class="anchored"><td class="def field"><a href="#type-limits.max_refused_operations" class="anchor"></a><code>max_refused_operations : int;</code></td></tr><tr id="type-limits.operation_timeout" class="anchored"><td class="def field"><a href="#type-limits.operation_timeout" class="anchor"></a><code>operation_timeout : <a href="../../../tezos-base/Tezos_base/Time/System/Span/index.html#type-t">Tezos_base.Time.System.Span.t</a>;</code></td></tr><tr id="type-limits.worker_limits" class="anchored"><td class="def field"><a href="#type-limits.worker_limits" class="anchor"></a><code>worker_limits : <a href="../../../tezos-base/Tezos_base/Worker_types/index.html#type-limits">Tezos_base.Worker_types.limits</a>;</code></td></tr><tr id="type-limits.operations_batch_size" class="anchored"><td class="def field"><a href="#type-limits.operations_batch_size" class="anchor"></a><code>operations_batch_size : int;</code></td></tr></table><code>}</code></dt></dl><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <a href="index.html#type-limits">limits</a> <span>&#45;&gt;</span> <span>(<span class="keyword">module</span> <a href="../Prevalidator_filters/module-type-FILTER/index.html">Prevalidator_filters.FILTER</a>)</span> <span>&#45;&gt;</span> <a href="../Distributed_db/index.html#type-chain_db">Distributed_db.chain_db</a> <span>&#45;&gt;</span> <span><span><a href="index.html#type-t">t</a> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p>Creates/tear-down a new prevalidator context.</p></dd></dl><dl><dt class="spec value" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span class="keyword">val</span> shutdown : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dt class="spec value" id="val-notify_operations"><a href="#val-notify_operations" class="anchor"></a><code><span class="keyword">val</span> notify_operations : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-base/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span>&#45;&gt;</span> <a href="../../../tezos-base/Tezos_base/Mempool/index.html#type-t">Tezos_base.Mempool.t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p>Notify the prevalidator that the identified peer has sent a bunch of * operations relevant to the specified context.</p></dd></dl><dl><dt class="spec value" id="val-inject_operation"><a href="#val-inject_operation" class="anchor"></a><code><span class="keyword">val</span> inject_operation : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p>Notify the prevalidator worker of a new injected operation.</p></dd></dl><dl><dt class="spec value" id="val-flush"><a href="#val-flush" class="anchor"></a><code><span class="keyword">val</span> flush : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/Set/index.html#type-t">Tezos_crypto.Block_hash.Set.t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Operation_hash/Set/index.html#type-t">Tezos_crypto.Operation_hash.Set.t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p>Notify the prevalidator that a new head has been selected.</p></dd></dl><dl><dt class="spec value" id="val-timestamp"><a href="#val-timestamp" class="anchor"></a><code><span class="keyword">val</span> timestamp : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-base/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a></code></dt><dd><p>Returns the timestamp of the prevalidator worker, that is the timestamp of the last reset of the prevalidation context</p></dd></dl><dl><dt class="spec value" id="val-fitness"><a href="#val-fitness" class="anchor"></a><code><span class="keyword">val</span> fitness : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="../../../tezos-base/Tezos_base/Fitness/index.html#type-t">Tezos_base.Fitness.t</a> Lwt.t</span></code></dt><dd><p>Returns the fitness of the current prevalidation context</p></dd></dl><dl><dt class="spec value" id="val-operations"><a href="#val-operations" class="anchor"></a><code><span class="keyword">val</span> operations : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-error">Tezos_base__TzPervasives.error</a> <a href="../../../tezos-base/Tezos_base/Preapply_result/index.html#type-t">Tezos_base.Preapply_result.t</a></span> * <span><a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <a href="../../../tezos-crypto/Tezos_crypto/Operation_hash/Map/index.html#type-t">Tezos_crypto.Operation_hash.Map.t</a></span></code></dt><dd><p>Returns the list of valid operations known to this prevalidation worker</p></dd></dl><dl><dt class="spec value" id="val-pending"><a href="#val-pending" class="anchor"></a><code><span class="keyword">val</span> pending : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span><a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> <a href="../../../tezos-crypto/Tezos_crypto/Operation_hash/Map/index.html#type-t">Tezos_crypto.Operation_hash.Map.t</a></span> Lwt.t</span></code></dt><dd><p>Returns the list of pending operations known to this prevalidation worker</p></dd></dl><dl><dt class="spec value" id="val-running_workers"><a href="#val-running_workers" class="anchor"></a><code><span class="keyword">val</span> running_workers : unit <span>&#45;&gt;</span> <span><span>(<a href="../../../tezos-crypto/Tezos_crypto/Chain_id/index.html#type-t">Tezos_crypto.Chain_id.t</a> * <a href="../../../tezos-crypto/Tezos_crypto/Protocol_hash/index.html#type-t">Tezos_crypto.Protocol_hash.t</a> * <a href="index.html#type-t">t</a>)</span> list</span></code></dt><dd><p>Returns the list of prevalidation contexts running and their associated chain</p></dd></dl><aside><p>Two functions that are useful for managing the prevalidator's transition * from one protocol to the next.</p></aside><dl><dt class="spec value" id="val-protocol_hash"><a href="#val-protocol_hash" class="anchor"></a><code><span class="keyword">val</span> protocol_hash : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Protocol_hash/index.html#type-t">Tezos_crypto.Protocol_hash.t</a></code></dt><dd><p>Returns the hash of the protocol the prevalidator was instantiated with</p></dd></dl><dl><dt class="spec value" id="val-parameters"><a href="#val-parameters" class="anchor"></a><code><span class="keyword">val</span> parameters : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-limits">limits</a> * <a href="../Distributed_db/index.html#type-chain_db">Distributed_db.chain_db</a></code></dt><dd><p>Returns the parameters the prevalidator was created with.</p></dd></dl><aside><p>Worker status and events</p></aside><dl><dt class="spec value" id="val-status"><a href="#val-status" class="anchor"></a><code><span class="keyword">val</span> status : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-base/Tezos_base/Worker_types/index.html#type-worker_status">Tezos_base.Worker_types.worker_status</a></code></dt><dt class="spec value" id="val-pending_requests"><a href="#val-pending_requests" class="anchor"></a><code><span class="keyword">val</span> pending_requests : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<a href="../../../tezos-base/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a> * <a href="../../../tezos-shell-services/Tezos_shell_services/Prevalidator_worker_state/Request/index.html#type-view">Tezos_shell_services.Prevalidator_worker_state.Request.view</a>)</span> list</span></code></dt><dt class="spec value" id="val-current_request"><a href="#val-current_request" class="anchor"></a><code><span class="keyword">val</span> current_request : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<a href="../../../tezos-base/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a> * <a href="../../../tezos-base/Tezos_base/Time/System/index.html#type-t">Tezos_base.Time.System.t</a> * <a href="../../../tezos-shell-services/Tezos_shell_services/Prevalidator_worker_state/Request/index.html#type-view">Tezos_shell_services.Prevalidator_worker_state.Request.view</a>)</span> option</span></code></dt><dt class="spec value" id="val-last_events"><a href="#val-last_events" class="anchor"></a><code><span class="keyword">val</span> last_events : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<a href="../../../tezos-event-logging/Tezos_event_logging/Internal_event/index.html#type-level">Tezos_base__TzPervasives.Internal_event.level</a> * <span><a href="../../../tezos-shell-services/Tezos_shell_services/Prevalidator_worker_state/Event/index.html#type-t">Tezos_shell_services.Prevalidator_worker_state.Event.t</a> list</span>)</span> list</span></code></dt><dt class="spec value" id="val-information"><a href="#val-information" class="anchor"></a><code><span class="keyword">val</span> information : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-base/Tezos_base/Worker_types/index.html#type-worker_information">Tezos_base.Worker_types.worker_information</a></code></dt><dt class="spec value" id="val-pipeline_length"><a href="#val-pipeline_length" class="anchor"></a><code><span class="keyword">val</span> pipeline_length : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int</code></dt><dt class="spec value" id="val-rpc_directory"><a href="#val-rpc_directory" class="anchor"></a><code><span class="keyword">val</span> rpc_directory : <span><span><a href="index.html#type-t">t</a> option</span> <a href="../../../tezos-rpc/Tezos_rpc/RPC_directory/index.html#type-t">Tezos_rpc.RPC_directory.t</a></span></code></dt></dl></div></body></html>