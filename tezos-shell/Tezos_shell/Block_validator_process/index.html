<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Block_validator_process (tezos-shell.Tezos_shell.Block_validator_process)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">tezos-shell</a> &#x00BB; <a href="../index.html">Tezos_shell</a> &#x00BB; Block_validator_process</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_shell.Block_validator_process</span></code></h1><p>Block_validator_process is used to validate new blocks. This validation can be</p><ul><li>internal: the same processus is used to run the node and to validate blocks</li><li>external: another processus is used to validate blocks This module also ensures the liveness of the operations (see <code>Block_validation:check_liveness</code>).</li></ul></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type" id="type-validator_environment" class="anchored"><a href="#type-validator_environment" class="anchor"></a><code><span><span class="keyword">type</span> validator_environment</span><span> = </span><span>{</span></code><table><tr id="type-validator_environment.user_activated_upgrades" class="anchored"><td class="def record field"><a href="#type-validator_environment.user_activated_upgrades" class="anchor"></a><code><span>user_activated_upgrades : <a href="../../../tezos-base/Tezos_base/User_activated/index.html#type-upgrades">Tezos_base.User_activated.upgrades</a>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>user activated upgrades</p><span class="comment-delim">*)</span></td></tr><tr id="type-validator_environment.user_activated_protocol_overrides" class="anchored"><td class="def record field"><a href="#type-validator_environment.user_activated_protocol_overrides" class="anchor"></a><code><span>user_activated_protocol_overrides : <a href="../../../tezos-base/Tezos_base/User_activated/index.html#type-protocol_overrides">Tezos_base.User_activated.protocol_overrides</a>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>user activated protocol overrides</p><span class="comment-delim">*)</span></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-validator_kind" class="anchored"><a href="#type-validator_kind" class="anchor"></a><code><span><span class="keyword">type</span> validator_kind</span><span> = </span></code><table><tr id="type-validator_kind.Internal" class="anchored"><td class="def variant constructor"><a href="#type-validator_kind.Internal" class="anchor"></a><code><span>| </span><span><span class="constructor">Internal</span> : <a href="../../../tezos-store/Tezos_store/Store/Chain/index.html#type-chain_store">Tezos_store.Store.Chain.chain_store</a> <span class="arrow">&#45;&gt;</span> <a href="#type-validator_kind">validator_kind</a></span></code></td></tr><tr id="type-validator_kind.External" class="anchored"><td class="def variant constructor"><a href="#type-validator_kind.External" class="anchor"></a><code><span>| </span><span><span class="constructor">External</span> : </span><span>{</span></code><table><tr id="type-validator_kind.genesis" class="anchored"><td class="def record field"><a href="#type-validator_kind.genesis" class="anchor"></a><code><span>genesis : <a href="../../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base.Genesis.t</a>;</span></code></td></tr><tr id="type-validator_kind.data_dir" class="anchored"><td class="def record field"><a href="#type-validator_kind.data_dir" class="anchor"></a><code><span>data_dir : string;</span></code></td></tr><tr id="type-validator_kind.context_root" class="anchored"><td class="def record field"><a href="#type-validator_kind.context_root" class="anchor"></a><code><span>context_root : string;</span></code></td></tr><tr id="type-validator_kind.protocol_root" class="anchored"><td class="def record field"><a href="#type-validator_kind.protocol_root" class="anchor"></a><code><span>protocol_root : string;</span></code></td></tr><tr id="type-validator_kind.process_path" class="anchored"><td class="def record field"><a href="#type-validator_kind.process_path" class="anchor"></a><code><span>process_path : string;</span></code></td></tr><tr id="type-validator_kind.sandbox_parameters" class="anchored"><td class="def record field"><a href="#type-validator_kind.sandbox_parameters" class="anchor"></a><code><span>sandbox_parameters : <span><span class="xref-unresolved">Tezos_base__TzPervasives</span>.Data_encoding.json option</span>;</span></code></td></tr></table><code><span>}</span><span> <span class="arrow">&#45;&gt;</span> <a href="#type-validator_kind">validator_kind</a></span></code></td></tr></table></div><div class="spec-doc"><p>For performances reasons, it may be interesting to use another processus (from the OS) to validate blocks (External). However, in that case, only one processus has a write access to the context. Currently informations are exchanged via the file system.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Internal representation of the block validator process</p></div></div><div class="odoc-spec"><div class="spec value" id="val-init" class="anchored"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : <span><a href="#type-validator_environment">validator_environment</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-validator_kind">validator_kind</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-t">t</a>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-close" class="anchored"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>close vp</code> closes the given <code>vp</code>. In the case of an <code>External</code> validator process, we first ask the validator to shutdown. If it is still running after 5 seconds, we notice that the block validation process is unresponsive and we force its termination (using a registered Lwt_exit.clean_up_callback).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-restore_context_integrity" class="anchored"><a href="#val-restore_context_integrity" class="anchor"></a><code><span><span class="keyword">val</span> restore_context_integrity : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span>int option</span>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-apply_block" class="anchored"><a href="#val-apply_block" class="anchor"></a><code><span><span class="keyword">val</span> apply_block : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-store/Tezos_store/Store/index.html#type-chain_store">Tezos_store.Store.chain_store</a> <span class="arrow">&#45;&gt;</span></span> <span>predecessor:<a href="../../../tezos-store/Tezos_store/Store/Block/index.html#type-t">Tezos_store.Store.Block.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-base/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span><a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> list</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="../../../tezos-validation/Tezos_validation/Block_validation/index.html#type-result">Tezos_validation.Block_validation.result</a>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>apply_block bvp predecessor header os</code> checks the liveness of the operations and then call <code>Block_validation.apply</code></p></div></div><div class="odoc-spec"><div class="spec value" id="val-commit_genesis" class="anchored"><a href="#val-commit_genesis" class="anchor"></a><code><span><span class="keyword">val</span> commit_genesis : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>chain_id:<a href="../../../tezos-crypto/Tezos_crypto/Chain_id/index.html#type-t">Tezos_crypto.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="../../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-init_test_chain" class="anchored"><a href="#val-init_test_chain" class="anchor"></a><code><span><span class="keyword">val</span> init_test_chain : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-store/Tezos_store/Store/Block/index.html#type-t">Tezos_store.Store.Block.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="../../../tezos-base/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>init_test_chain</code> must only be called on a forking block.</p></div></div></div></body></html>