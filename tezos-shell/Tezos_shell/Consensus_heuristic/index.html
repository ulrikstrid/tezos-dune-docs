<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Consensus_heuristic (tezos-shell.Tezos_shell.Consensus_heuristic)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-shell</a> &#x00BB; <a href="../index.html">Tezos_shell</a> &#x00BB; Consensus_heuristic</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_shell.Consensus_heuristic</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#consensus-heuristic">Consensus heuristic</a></li><li><a href="#consensus-heuristic-worker">Consensus heuristic worker</a></li></ul></nav><div class="odoc-content"><h3 id="consensus-heuristic"><a href="#consensus-heuristic" class="anchor"></a>Consensus heuristic</h3><p>A consensus heuristic is a mechanism by which a node attempts to find a data that its network of peers generally agrees upon. Typically, the node attempts to find out what the p2p network as a whole agrees is the head of the chain.</p><p>Note that, by nature, this problem does not necessarily have one exact solution. This is a heuristic, it makes a &quot;best guess&quot; based on information available locally.</p><p>The consensus heuristic is given <em>candidates</em>: tuples of the form <code>p,d</code> where <code>d</code> is the data and <code>p</code> is a peer id indicating the provenance of the data. Typically, a candidate indicates what a peer considers to be the head of the chain.</p><p>The consensus heuristic is parametrized by two values:</p><ul><li><em>expected</em> is the number of candidates that the heuristic keeps internally,</li><li><em>threshold</em> is the number of candidates that need to agree on their data for a consensus to be reached.</li></ul><p>A precondition for the heuristic is that <code>0 &lt;= threshold &lt;= expected &lt; 2 * threshold</code> to ensure a unique consensus value.</p><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span></code></div><div class="spec-doc"><p><code>'a t</code> is the abstract internal state for the consensus heuristic mechanism. <code>'a</code> is the type of the data that needs to be agreed upon.</p><p>Note that these values are intended to be short-lived, one shot. Specifically, these values are not meant to be used over a long period of time during which there is churn in the set of p2p neighbors.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-state" class="anchored"><a href="#type-state" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a state</span></span><span> = </span></code><table><tr id="type-state.Consensus" class="anchored"><td class="def variant constructor"><a href="#type-state.Consensus" class="anchor"></a><code><span>| </span><span><span class="constructor">Consensus</span> <span class="keyword">of</span> <span class="type-var">'a</span></span></code></td></tr><tr id="type-state.No_consensus" class="anchored"><td class="def variant constructor"><a href="#type-state.No_consensus" class="anchor"></a><code><span>| </span><span><span class="constructor">No_consensus</span> <span class="keyword">of</span> <span><span>(<span class="type-var">'a</span> * int)</span> list</span></span></code></td></tr><tr id="type-state.Need_more_candidates" class="anchored"><td class="def variant constructor"><a href="#type-state.Need_more_candidates" class="anchor"></a><code><span>| </span><span><span class="constructor">Need_more_candidates</span></span></code></td></tr></table></div><div class="spec-doc"><p>The three different states that the heuristic can be in.</p><ul><li>If the heuristic received less than <em>expected</em> candidates and no candidates' data has <em>threshold</em> occurrences, then its state is <code>Need_more_candidates</code>.</li></ul><ul><li>If the heuristic received <em>expected</em> (or more) candidates but no candidates' data has <em>threshold</em> occurrences, its state is <code>No_consensus</code>. The payload for the constructor lists all the candidates' data with the number of their occurrences.</li></ul><ul><li>Otherwise there is some candidates' data that has <em>threshold</em> occurrences or more and the state is <code>Consensus</code>.</li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>?compare:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> int)</span> <span class="arrow">&#45;&gt;</span></span> <span>expected:int <span class="arrow">&#45;&gt;</span></span> <span>threshold:int <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>create ~compare ~expected ~threshold ()</code> is a fresh heuristic state.</p><p><code>compare</code> is used internally to instantiate a map of candidates. It must be a total order over the type of data, but the specific of the order has no effect on the consensus.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">[Invalid_argument]</span> <p>if not <code>0 &lt;= threshold &lt;= expected &lt; 2 * threshold</code></p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-get_state" class="anchored"><a href="#val-get_state" class="anchor"></a><code><span><span class="keyword">val</span> get_state : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-state">state</a></span></span></code></div><div class="spec-doc"><p><code>get_state heuristic</code> returns the current <a href="#type-state"><code>state</code></a> of the heuristic according to the semantics given above.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-update" class="anchored"><a href="#val-update" class="anchor"></a><code><span><span class="keyword">val</span> update : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="../../../tezos-base/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> * <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>update heuristic (peer, data)</code> updates the heuristic with the candidate <code>(peer, data)</code>. If a data was already registered for <code>peer</code>, then it is replaced by the update. It is the responsibility of the caller given a peer to update better and better data (for the caller's notion of &quot;better&quot;).</p></div></div><h3 id="consensus-heuristic-worker"><a href="#consensus-heuristic-worker" class="anchor"></a>Consensus heuristic worker</h3><div class="odoc-spec"><div class="spec module" id="module-Worker" class="anchored"><a href="#module-Worker" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Worker/index.html">Worker</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>This worker implements a memoisation mechanism for the consensus heuristic with an expiry date mechanism. The worker also handles a hook mechanism to be executed on values found by the consensus heuristic.</p></div></div></div></body></html>