<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tezos_store__Block_repr (tezos-store.Tezos_store__Block_repr)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">tezos-store</a> &#x00BB; Tezos_store__Block_repr</nav><h1>Module <code>Tezos_store__Block_repr</code></h1><nav class="toc"><ul><li><a href="#type-definitions-and-encodings">Type definitions and encodings</a></li><li><a href="#genesis">Genesis</a></li><li><a href="#accessors">Accessors</a><ul><li><a href="#block-header-accessors">Block header accessors</a></li><li><a href="#metadata-accessors">Metadata accessors</a></li></ul></li><li><a href="#utility-functions">Utility functions</a></li></ul></nav></header><aside><p>Block representation effectively stored on disk and its accessors.</p></aside><section><header><h2 id="type-definitions-and-encodings"><a href="#type-definitions-and-encodings" class="anchor"></a>Type definitions and encodings</h2></header><dl><dt class="spec type" id="type-contents"><a href="#type-contents" class="anchor"></a><code><span class="keyword">type</span> contents</code><code> = </code><code>{</code><table class="record"><tr id="type-contents.header" class="anchored"><td class="def field"><a href="#type-contents.header" class="anchor"></a><code>header : <a href="../../tezos-base/Tezos_base/Block_header/index.html#type-t">Tezos_base__TzPervasives.Block_header.t</a>;</code></td></tr><tr id="type-contents.operations" class="anchored"><td class="def field"><a href="#type-contents.operations" class="anchor"></a><code>operations : <span><span><a href="../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base__TzPervasives.Operation.t</a> list</span> list</span>;</code></td></tr><tr id="type-contents.block_metadata_hash" class="anchored"><td class="def field"><a href="#type-contents.block_metadata_hash" class="anchor"></a><code>block_metadata_hash : <span><a href="../../tezos-crypto/Tezos_crypto/Block_metadata_hash/index.html#type-t">Tezos_crypto.Block_metadata_hash.t</a> option</span>;</code></td></tr><tr id="type-contents.operations_metadata_hashes" class="anchored"><td class="def field"><a href="#type-contents.operations_metadata_hashes" class="anchor"></a><code>operations_metadata_hashes : <span><span><span><a href="../../tezos-crypto/Tezos_crypto/Operation_metadata_hash/index.html#type-t">Tezos_crypto.Operation_metadata_hash.t</a> list</span> list</span> option</span>;</code></td></tr></table><code>}</code></dt><dd><p>The type for the effective <code>contents</code> of a block is its header and the <code>operations</code> it contains. Their metadata hashes are also present.</p></dd></dl><dl><dt class="spec type" id="type-metadata"><a href="#type-metadata" class="anchor"></a><code><span class="keyword">type</span> metadata</code><code> = </code><code>{</code><table class="record"><tr id="type-metadata.message" class="anchored"><td class="def field"><a href="#type-metadata.message" class="anchor"></a><code>message : <span>string option</span>;</code></td></tr><tr id="type-metadata.max_operations_ttl" class="anchored"><td class="def field"><a href="#type-metadata.max_operations_ttl" class="anchor"></a><code>max_operations_ttl : int;</code></td></tr><tr id="type-metadata.last_allowed_fork_level" class="anchored"><td class="def field"><a href="#type-metadata.last_allowed_fork_level" class="anchor"></a><code>last_allowed_fork_level : Stdlib.Int32.t;</code></td></tr><tr id="type-metadata.block_metadata" class="anchored"><td class="def field"><a href="#type-metadata.block_metadata" class="anchor"></a><code>block_metadata : Stdlib.Bytes.t;</code></td></tr><tr id="type-metadata.operations_metadata" class="anchored"><td class="def field"><a href="#type-metadata.operations_metadata" class="anchor"></a><code>operations_metadata : <span><span>Stdlib.Bytes.t list</span> list</span>;</code></td></tr></table><code>}</code></dt><dd><p>The type for a block's <code>metadata</code> stored on disk. This representation is tightly linked to <a href="../../tezos-validation/Tezos_validation/Block_validation/index.html#type-result"><code>Block_validation.result</code></a> which also has a strong dependency to <a href="../../tezos-protocol-environment/Tezos_protocol_environment/index.html#type-validation_result"><code>Tezos_protocol_environment.validation_result</code></a>.</p><p>Some fields exposed by <a href="../../tezos-validation/Tezos_validation/Block_validation/index.html#type-result"><code>Block_validation.result</code></a> are unnecessary hence the lack of direct link.</p></dd></dl><dl><dt class="spec type" id="type-block"><a href="#type-block" class="anchor"></a><code><span class="keyword">type</span> block</code><code> = </code><code>{</code><table class="record"><tr id="type-block.hash" class="anchored"><td class="def field"><a href="#type-block.hash" class="anchor"></a><code>hash : <a href="../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a>;</code></td></tr><tr id="type-block.contents" class="anchored"><td class="def field"><a href="#type-block.contents" class="anchor"></a><code>contents : <a href="index.html#type-contents">contents</a>;</code></td></tr><tr id="type-block.metadata" class="anchored"><td class="def field"><a href="#type-block.metadata" class="anchor"></a><code><span class="keyword">mutable</span> metadata : <span><a href="index.html#type-metadata">metadata</a> option</span>;</code></td></tr></table><code>}</code></dt><dd><p>The type for a <code>block</code> stored on disk.</p><p>The <code>hash</code> of the block is also stored to improve efficiency by not forcing the user to hash the header. This also allows to store fake hashes (e.g. sandbox's genesis blocks) but should be prevented by the API.</p><p>The <code>metadata</code> might not be present. The mutability flag allows users to re-use the same structure to store freshly loaded metadata.</p></dd></dl><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code><code> = <a href="index.html#type-block">block</a></code></dt></dl></section><section><header><h2 id="genesis"><a href="#genesis" class="anchor"></a>Genesis</h2></header><dl><dt class="spec value" id="val-create_genesis_block"><a href="#val-create_genesis_block" class="anchor"></a><code><span class="keyword">val</span> create_genesis_block : <span>genesis:<a href="../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base__TzPervasives.Genesis.t</a></span> <span>&#45;&gt;</span> <a href="../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>create_genesis_block ~genesis context_hash</code> creates a default genesis block for the given <code>genesis</code> and its <code>context_hash</code> that contains metadata.</p></dd></dl><dl><dt class="spec value" id="val-contents_encoding"><a href="#val-contents_encoding" class="anchor"></a><code><span class="keyword">val</span> contents_encoding : <span><a href="index.html#type-contents">contents</a> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#module-Data_encoding">Tezos_base__TzPervasives.Data_encoding</a>.t</span></code></dt><dd><p>Encoding for <a href="index.html#type-contents"><code>contents</code></a>.</p></dd></dl><dl><dt class="spec value" id="val-metadata_encoding"><a href="#val-metadata_encoding" class="anchor"></a><code><span class="keyword">val</span> metadata_encoding : <span><a href="index.html#type-metadata">metadata</a> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#module-Data_encoding">Tezos_base__TzPervasives.Data_encoding</a>.t</span></code></dt><dd><p>Encoding for <a href="index.html#type-metadata"><code>metadata</code></a>.</p></dd></dl><dl><dt class="spec value" id="val-encoding"><a href="#val-encoding" class="anchor"></a><code><span class="keyword">val</span> encoding : <span><a href="index.html#type-t">t</a> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#module-Data_encoding">Tezos_base__TzPervasives.Data_encoding</a>.t</span></code></dt><dd><p>Encoding for <a href="index.html#type-t"><code>t</code></a> (and <a href="index.html#type-block"><code>block</code></a>).</p><p><b>Important</b> An encoded block is prefixed by 4 bytes which stands for the length of the data. This is the case with <code>Data_encoding.dynamic_size ~kind:`Uint30</code> encodings. This will be expected to be present to improve the store efficiency.</p></dd></dl><dl><dt class="spec value" id="val-pp_json"><a href="#val-pp_json" class="anchor"></a><code><span class="keyword">val</span> pp_json : Stdlib.Format.formatter <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>pp_json</code> pretty-print a block as JSON.</p></dd></dl></section><section><header><h2 id="accessors"><a href="#accessors" class="anchor"></a>Accessors</h2></header><dl><dt class="spec value" id="val-descriptor"><a href="#val-descriptor" class="anchor"></a><code><span class="keyword">val</span> descriptor : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../Tezos_store/Store_types/index.html#type-block_descriptor">Tezos_store.Store_types.block_descriptor</a></code></dt><dd><p><code>descriptor block</code> returns the pair (hash x level) of <code>block</code>.</p></dd></dl><dl><dt class="spec value" id="val-hash"><a href="#val-hash" class="anchor"></a><code><span class="keyword">val</span> hash : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></code></dt><dd><p><code>hash block</code> returns the stored <code>block</code>'s hash. It is not guaranteed to be the same as <code>Block_header.hash (header block)</code> (e.g. in sandbox, the genesis block might have a fake hash).</p></dd></dl><dl><dt class="spec value" id="val-operations"><a href="#val-operations" class="anchor"></a><code><span class="keyword">val</span> operations : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span><a href="../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base__TzPervasives.Operation.t</a> list</span> list</span></code></dt><dd><p><code>operations block</code> returns the list of list of operations contained in the <code>block</code>.</p></dd></dl><section><header><h3 id="block-header-accessors"><a href="#block-header-accessors" class="anchor"></a>Block header accessors</h3></header><dl><dt class="spec value" id="val-header"><a href="#val-header" class="anchor"></a><code><span class="keyword">val</span> header : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base/Block_header/index.html#type-t">Tezos_base__TzPervasives.Block_header.t</a></code></dt><dt class="spec value" id="val-shell_header"><a href="#val-shell_header" class="anchor"></a><code><span class="keyword">val</span> shell_header : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base__TzPervasives.Block_header.shell_header</a></code></dt><dt class="spec value" id="val-level"><a href="#val-level" class="anchor"></a><code><span class="keyword">val</span> level : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> Stdlib.Int32.t</code></dt><dt class="spec value" id="val-proto_level"><a href="#val-proto_level" class="anchor"></a><code><span class="keyword">val</span> proto_level : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int</code></dt><dt class="spec value" id="val-predecessor"><a href="#val-predecessor" class="anchor"></a><code><span class="keyword">val</span> predecessor : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></code></dt><dt class="spec value" id="val-timestamp"><a href="#val-timestamp" class="anchor"></a><code><span class="keyword">val</span> timestamp : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base__Time/Protocol/index.html#type-t">Tezos_base__TzPervasives.Time.Protocol.t</a></code></dt><dt class="spec value" id="val-validation_passes"><a href="#val-validation_passes" class="anchor"></a><code><span class="keyword">val</span> validation_passes : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int</code></dt><dt class="spec value" id="val-operations_hash"><a href="#val-operations_hash" class="anchor"></a><code><span class="keyword">val</span> operations_hash : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../tezos-crypto/Tezos_crypto/Operation_list_list_hash/index.html#type-t">Tezos_crypto.Operation_list_list_hash.t</a></code></dt><dt class="spec value" id="val-fitness"><a href="#val-fitness" class="anchor"></a><code><span class="keyword">val</span> fitness : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base/Fitness/index.html#type-t">Tezos_base__TzPervasives.Fitness.t</a></code></dt><dt class="spec value" id="val-context"><a href="#val-context" class="anchor"></a><code><span class="keyword">val</span> context : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a></code></dt><dt class="spec value" id="val-protocol_data"><a href="#val-protocol_data" class="anchor"></a><code><span class="keyword">val</span> protocol_data : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> Stdlib.Bytes.t</code></dt><dt class="spec value" id="val-block_metadata_hash"><a href="#val-block_metadata_hash" class="anchor"></a><code><span class="keyword">val</span> block_metadata_hash : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="../../tezos-crypto/Tezos_crypto/Block_metadata_hash/index.html#type-t">Tezos_crypto.Block_metadata_hash.t</a> option</span></code></dt><dt class="spec value" id="val-operations_metadata_hashes"><a href="#val-operations_metadata_hashes" class="anchor"></a><code><span class="keyword">val</span> operations_metadata_hashes : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span><span><a href="../../tezos-crypto/Tezos_crypto/Operation_metadata_hash/index.html#type-t">Tezos_crypto.Operation_metadata_hash.t</a> list</span> list</span> option</span></code></dt></dl></section><section><header><h3 id="metadata-accessors"><a href="#metadata-accessors" class="anchor"></a>Metadata accessors</h3></header><dl><dt class="spec value" id="val-metadata"><a href="#val-metadata" class="anchor"></a><code><span class="keyword">val</span> metadata : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="index.html#type-metadata">metadata</a> option</span></code></dt><dt class="spec value" id="val-message"><a href="#val-message" class="anchor"></a><code><span class="keyword">val</span> message : <a href="index.html#type-metadata">metadata</a> <span>&#45;&gt;</span> <span>string option</span></code></dt><dt class="spec value" id="val-max_operations_ttl"><a href="#val-max_operations_ttl" class="anchor"></a><code><span class="keyword">val</span> max_operations_ttl : <a href="index.html#type-metadata">metadata</a> <span>&#45;&gt;</span> int</code></dt><dt class="spec value" id="val-last_allowed_fork_level"><a href="#val-last_allowed_fork_level" class="anchor"></a><code><span class="keyword">val</span> last_allowed_fork_level : <a href="index.html#type-metadata">metadata</a> <span>&#45;&gt;</span> Stdlib.Int32.t</code></dt><dt class="spec value" id="val-block_metadata"><a href="#val-block_metadata" class="anchor"></a><code><span class="keyword">val</span> block_metadata : <a href="index.html#type-metadata">metadata</a> <span>&#45;&gt;</span> Stdlib.Bytes.t</code></dt><dt class="spec value" id="val-operations_metadata"><a href="#val-operations_metadata" class="anchor"></a><code><span class="keyword">val</span> operations_metadata : <a href="index.html#type-metadata">metadata</a> <span>&#45;&gt;</span> <span><span>Stdlib.Bytes.t list</span> list</span></code></dt></dl></section></section><section><header><h2 id="utility-functions"><a href="#utility-functions" class="anchor"></a>Utility functions</h2></header><dl><dt class="spec value" id="val-check_block_consistency"><a href="#val-check_block_consistency" class="anchor"></a><code><span class="keyword">val</span> check_block_consistency : <span>?&#8288;genesis_hash:<a href="../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;pred_block:<a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>check_block_consistency ?genesis_hash ?pred_block block</code> checks that the stored data is consistent:</p><ul><li>Does the <code>hash</code> stored equals the result of <code>Block_header.hash</code> of its header and, if not, is this the stored <code>genesis_hash</code>?</li><li>Is the <code>block</code> a successor of <code>pred_block</code> with regards to its level and its predecessor's hash?</li><li>Are the stored operations hashes consistent regarding the stored operations hashes?</li></ul></dd></dl><dl><dt class="spec value" id="val-read_next_block_exn"><a href="#val-read_next_block_exn" class="anchor"></a><code><span class="keyword">val</span> read_next_block_exn : Lwt_unix.file_descr <span>&#45;&gt;</span> <span><span>(<a href="index.html#type-t">t</a> * int)</span> Lwt.t</span></code></dt><dd><p><code>read_next_block_exn fd</code> reads from <code>fd</code> and decode the next block found in the descriptor. The <code>fd</code>'s offset is moved as a side effect. This returns the decoded block along with the block length (number of bytes) of the encoded block. This function updates the given <code>fd</code> state and may raise Unix.error errors, see Unix.read.</p></dd></dl><dl><dt class="spec value" id="val-read_next_block"><a href="#val-read_next_block" class="anchor"></a><code><span class="keyword">val</span> read_next_block : Lwt_unix.file_descr <span>&#45;&gt;</span> <span><span><span>(<a href="index.html#type-t">t</a> * int)</span> option</span> Lwt.t</span></code></dt><dd><p>Same as <code>read_next_block fd</code> but returns <code>None</code> if there was an error.</p></dd></dl><dl><dt class="spec value" id="val-pread_block_exn"><a href="#val-pread_block_exn" class="anchor"></a><code><span class="keyword">val</span> pread_block_exn : Lwt_unix.file_descr <span>&#45;&gt;</span> <span>file_offset:int</span> <span>&#45;&gt;</span> <span><span>(<a href="index.html#type-t">t</a> * int)</span> Lwt.t</span></code></dt><dd><p><code>pread_block_exn fd ~file_offset</code> reads from <code>fd</code> and decode the block at offset <code>file_offset</code> in the descriptor. This returns the decoded block along with the block length (number of bytes) of the encoded block. This function may raise Unix.error errors, see Unix.read.</p></dd></dl><dl><dt class="spec value" id="val-pread_block"><a href="#val-pread_block" class="anchor"></a><code><span class="keyword">val</span> pread_block : Lwt_unix.file_descr <span>&#45;&gt;</span> <span>file_offset:int</span> <span>&#45;&gt;</span> <span><span><span>(<a href="index.html#type-t">t</a> * int)</span> option</span> Lwt.t</span></code></dt><dd><p>Same as <code>pread_block fd ~file_offset</code> but returns <code>None</code> if there was an error.</p></dd></dl></section></div></body></html>