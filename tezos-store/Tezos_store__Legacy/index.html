<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tezos_store__Legacy (tezos-store.Tezos_store__Legacy)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">tezos-store</a> &#x00BB; Tezos_store__Legacy</nav><h1>Module <code>Tezos_store__Legacy</code></h1><p>Legacy storage upgrade</p><p>The legacy store upgrade aims to migrate a storage using the LMDB backend (v0.0.4) to the new store representation (v0.0.5). This migration is available for any store running v0.0.4 with any history mode. The upgrade procedure is going to retrieve each the block and its associated data available in the old store, convert and store them in the new backend. It will preserve all the information originally contained in the LMDB store such as the current head, checkpoint, savepoint and caboose.</p></header><dl><dt class="spec module" id="module-Hardcoded"><a href="#module-Hardcoded" class="anchor"></a><code><span class="keyword">module</span> <a href="Hardcoded/index.html">Hardcoded</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Module for handling values needed by the legacy upgrade. It exposes the <code>cycle_length</code> to allow upgrading <code>supported_networks</code> only. These values are mandatory as the new backend regroup blocks by cycles, something which was not available in the previous representation when the metadata of blocks is not fully available.</p></dd></dl><dl><dt class="spec extension"><code><span class="keyword">type</span> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-error">Tezos_base__TzPervasives.error</a> += </code><code><span class="extension">Failed_to_convert_protocol</span> <span class="keyword">of</span> <a href="../../tezos-crypto/Tezos_crypto/Protocol_hash/index.html#type-t">Tezos_crypto.Protocol_hash.t</a></code></dt><dt class="spec extension"><code><span class="keyword">type</span> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-error">Tezos_base__TzPervasives.error</a> += </code><code><span class="extension">Failed_to_upgrade</span> <span class="keyword">of</span> string</code></dt></dl><dl><dt class="spec value" id="val-temporary_former_store_path"><a href="#val-temporary_former_store_path" class="anchor"></a><code><span class="keyword">val</span> temporary_former_store_path : <span>data_dir:string</span> <span>&#45;&gt;</span> string</code></dt><dd><p><code>temporary_former_store_path ~data_dir</code> returns the path of the preserved legacy store given a <code>data_dir</code></p></dd></dl><dl><dt class="spec value" id="val-raw_upgrade"><a href="#val-raw_upgrade" class="anchor"></a><code><span class="keyword">val</span> raw_upgrade : <a href="../../tezos-base/Tezos_base__Distributed_db_version/Name/index.html#type-t">Tezos_base__TzPervasives.Distributed_db_version.Name.t</a> <span>&#45;&gt;</span> <span>new_store:<a href="../Tezos_store/Store/index.html#type-t">Tezos_store.Store.t</a></span> <span>&#45;&gt;</span> <span>legacy_state:<a href="../../tezos-legacy-store/Tezos_legacy_store/Legacy_state/index.html#type-t">Tezos_legacy_store.Legacy_state.t</a></span> <span>&#45;&gt;</span> <a href="../../tezos-shell-services/Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base__TzPervasives.Genesis.t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>raw_upgrade chain_name ~new_store ~old_store hm genesis</code> is the low level upgrade procedure which performs the store upgrade given the direct paths to the <code>new_store</code> and <code>old_store</code>.</p><p><b>Warning</b> This function is unsafe and is exposed for testing purposes.</p></dd></dl><dl><dt class="spec value" id="val-upgrade_0_0_4"><a href="#val-upgrade_0_0_4" class="anchor"></a><code><span class="keyword">val</span> upgrade_0_0_4 : <span>data_dir:string</span> <span>&#45;&gt;</span> <span>?&#8288;patch_context:<span>(<a href="../../tezos-context/Tezos_context/Context/index.html#type-t">Tezos_context.Context.t</a> <span>&#45;&gt;</span> <span><span><a href="../../tezos-context/Tezos_context/Context/index.html#type-t">Tezos_context.Context.t</a> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>chain_name:<a href="../../tezos-base/Tezos_base__Distributed_db_version/Name/index.html#type-t">Tezos_base__TzPervasives.Distributed_db_version.Name.t</a></span> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base__TzPervasives.Genesis.t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>upgrade_0_0_4 ~data_dir genesis patch_context ~chain_name</code> upgrades a store located in <code>data_dir</code> base on v.0.0.4 to a v0.0.5. It outputs information regarding the necessary actions in order to cleanely complete the upgrade. Here this case, the user must delete the old storage. Returns the message to display to the user.</p></dd></dl></div></body></html>