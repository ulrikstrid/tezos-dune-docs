<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tezos_store__Reconstruction (tezos-store.Tezos_store__Reconstruction)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">tezos-store</a> &#x00BB; Tezos_store__Reconstruction</nav><h1>Module <code>Tezos_store__Reconstruction</code></h1><p>Storage reconstruction</p><p>The storage reconstruction feature aims to re-compute the contexts (ledger state) and the blocks metadata of a full mode storage, and thus, migrate a storage from a full history mode to an archive one.</p><p>To do so, it is needed to re-validate the whole chain, by applying (using the standard validation method: <a href="../../tezos-validation/Tezos_validation/Block_validation/index.html#val-apply"><code>Block_validation.apply</code></a>) all the blocks from the genesis on empty context. As a storage running a full history mode will not store all the ledger state but keeps all the blocks (and operations), it is the only mode that can be reconstructed. The operation consist of two major steps:</p><ul><li>Reconstructing the cemented block store: for each cemented cycle, the context of each block along with their associated metadatas are restored.</li><li>Reconstructing the floating block stores: this step is only necessary if the store was recently imported from a snapshot as some metadata will be missing.</li></ul><p>As the reconstruction procedure changes the state of the storage, it cannot be run while a node is running on the storage to reconstruct. If the reconstruction is interrupted, it will be resumed if restarted.</p></header><dl><dt class="spec type" id="type-failure_kind"><a href="#type-failure_kind" class="anchor"></a><code><span class="keyword">type</span> failure_kind</code><code> = </code><table class="variant"><tr id="type-failure_kind.Nothing_to_reconstruct" class="anchored"><td class="def constructor"><a href="#type-failure_kind.Nothing_to_reconstruct" class="anchor"></a><code>| </code><code><span class="constructor">Nothing_to_reconstruct</span></code></td></tr><tr id="type-failure_kind.Context_hash_mismatch" class="anchored"><td class="def constructor"><a href="#type-failure_kind.Context_hash_mismatch" class="anchor"></a><code>| </code><code><span class="constructor">Context_hash_mismatch</span> <span class="keyword">of</span> <a href="../../tezos-base/Tezos_base/Block_header/index.html#type-t">Tezos_base__TzPervasives.Block_header.t</a> * <a href="../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a> * <a href="../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a></code></td></tr><tr id="type-failure_kind.Missing_block" class="anchored"><td class="def constructor"><a href="#type-failure_kind.Missing_block" class="anchor"></a><code>| </code><code><span class="constructor">Missing_block</span> <span class="keyword">of</span> <a href="../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></code></td></tr></table></dt></dl><dl><dt class="spec extension"><code><span class="keyword">type</span> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-error">Tezos_base__TzPervasives.error</a> += </code><code><span class="extension">Reconstruction_failure</span> <span class="keyword">of</span> <a href="index.html#type-failure_kind">failure_kind</a></code></dt><dt class="spec extension"><code><span class="keyword">type</span> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-error">Tezos_base__TzPervasives.error</a> += </code><code><span class="extension">Cannot_reconstruct</span> <span class="keyword">of</span> <a href="../../tezos-shell-services/Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a></code></dt></dl><dl><dt class="spec value" id="val-reconstruct"><a href="#val-reconstruct" class="anchor"></a><code><span class="keyword">val</span> reconstruct : <span>?&#8288;patch_context:<span>(<a href="../../tezos-context/Tezos_context/Context/index.html#type-t">Tezos_context.Context.t</a> <span>&#45;&gt;</span> <span><span><a href="../../tezos-context/Tezos_context/Context/index.html#type-t">Tezos_context.Context.t</a> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>store_dir:string</span> <span>&#45;&gt;</span> <span>context_dir:string</span> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base__TzPervasives.Genesis.t</a> <span>&#45;&gt;</span> <span>user_activated_upgrades:<a href="../../tezos-base/Tezos_base/User_activated/index.html#type-upgrades">Tezos_base__TzPervasives.User_activated.upgrades</a></span> <span>&#45;&gt;</span> <span>user_activated_protocol_overrides:<a href="../../tezos-base/Tezos_base/User_activated/index.html#type-protocol_overrides">Tezos_base__TzPervasives.User_activated.protocol_overrides</a></span> <span>&#45;&gt;</span> <span><span>unit <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>reconstruct ?patch_context ~store_dir ~context_dir genesis uau
    uapo</code> reconstructs the storage located in <code>store_dir</code> and <code>context_dir</code>. The resulting storage will see its history mode changed to archive.</p></dd></dl></div></body></html>