<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tezos_store__Snapshots (tezos-store.Tezos_store__Snapshots)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">tezos-store</a> &#x00BB; Tezos_store__Snapshots</nav><h1>Module <code>Tezos_store__Snapshots</code></h1><p>Snapshots for the store</p><p>Snapshots are canonical representations of the store and its associated context. Its main purposes it to save and load a current state with the minimal necessary amount of information. This snapshot may also be shared by third parties to facilitate the bootstrap process.</p><p>A snapshot of a block <code>B</code> is composed of:</p><ul><li>The metadata of the snapshot;</li><li>A single context containing every key that the block <code>B-1</code> needs (see below);</li><li>The set of blocks and their operations from the genesis block up to <code>B</code> -- it might contain less blocks if the snapshot is created from a store using a <code>Rolling</code> history mode of if it is created as a <code>Rolling</code> snapshot. Block's metadata are not exported ;</li><li>The set of necessary Tezos protocols.</li></ul><p>Exporting a snapshot will generate such a file (or a directory, if the snapshot is not compressed). Importing a snapshot will initialize a fresh store with the data contained in the snapshot. As snapshots may be shared between users, checks are made to ensure that no malicious data is loaded. For instance, we export the context of block <code>B-1</code> to make sure that the application of the block <code>B</code>, given its predecessor's context, is valid.</p><p>Depending on the history mode, a snapshot might contain less blocks. In full, all blocks are present and importing such a snapshot will populate the <code>Cemented_store</code> with every cycle up to the snapshot's target block. Meanwhile, in <code>Rolling</code>, only a few previous blocks will be exported (<code>max_op_ttl</code> from the target block), only populating a <code>Floating_block_store</code>. Thus, the snapshot size greatly differs depending on the history mode used.</p><p>Snapshots may be created concurrently with a running node. It might impact the node for a few seconds to retrieve the necessary consistent information to producethe snapshot.</p></header><dl><dt class="spec extension"><code><span class="keyword">type</span> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-error">Tezos_base__TzPervasives.error</a> += </code><code><span class="extension">Incompatible_history_mode</span> <span class="keyword">of</span> </code><code>{</code><table class="record"><tr id=".requested" class="anchored"><td class="def field"><a href="#.requested" class="anchor"></a><code>requested : <a href="../../tezos-shell-services/Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a>;</code></td></tr><tr id=".stored" class="anchored"><td class="def field"><a href="#.stored" class="anchor"></a><code>stored : <a href="../../tezos-shell-services/Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a>;</code></td></tr></table><code>}</code><code> | </code><code><span class="extension">Invalid_export_block</span> <span class="keyword">of</span> </code><code>{</code><table class="record"><tr id=".block" class="anchored"><td class="def field"><a href="#.block" class="anchor"></a><code>block : <span><a href="../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> option</span>;</code></td></tr><tr id=".reason" class="anchored"><td class="def field"><a href="#.reason" class="anchor"></a><code>reason : <span>[ `Pruned <span>| `Pruned_pred</span> <span>| `Unknown</span> <span>| `Unknown_ancestor</span> <span>| `Caboose</span> <span>| `Genesis</span> <span>| `Not_enough_pred</span> ]</span>;</code></td></tr></table><code>}</code><code> | </code><code><span class="extension">Invalid_export_path</span> <span class="keyword">of</span> string</code><code> | </code><code><span class="extension">Snapshot_file_not_found</span> <span class="keyword">of</span> string</code><code> | </code><code><span class="extension">Inconsistent_protocol_hash</span> <span class="keyword">of</span> </code><code>{</code><table class="record"><tr id=".expected" class="anchored"><td class="def field"><a href="#.expected" class="anchor"></a><code>expected : <a href="../../tezos-crypto/Tezos_crypto/Protocol_hash/index.html#type-t">Tezos_crypto.Protocol_hash.t</a>;</code></td></tr><tr id=".got" class="anchored"><td class="def field"><a href="#.got" class="anchor"></a><code>got : <a href="../../tezos-crypto/Tezos_crypto/Protocol_hash/index.html#type-t">Tezos_crypto.Protocol_hash.t</a>;</code></td></tr></table><code>}</code><code> | </code><code><span class="extension">Inconsistent_context_hash</span> <span class="keyword">of</span> </code><code>{</code><table class="record"><tr id=".expected" class="anchored"><td class="def field"><a href="#.expected" class="anchor"></a><code>expected : <a href="../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a>;</code></td></tr><tr id=".got" class="anchored"><td class="def field"><a href="#.got" class="anchor"></a><code>got : <a href="../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a>;</code></td></tr></table><code>}</code><code> | </code><code><span class="extension">Inconsistent_context</span> <span class="keyword">of</span> <a href="../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a></code><code> | </code><code><span class="extension">Cannot_decode_protocol</span> <span class="keyword">of</span> <a href="../../tezos-crypto/Tezos_crypto/Protocol_hash/index.html#type-t">Tezos_crypto.Protocol_hash.t</a></code><code> | </code><code><span class="extension">Cannot_write_metadata</span> <span class="keyword">of</span> string</code><code> | </code><code><span class="extension">Cannot_read</span> <span class="keyword">of</span> </code><code>{</code><table class="record"><tr id=".kind" class="anchored"><td class="def field"><a href="#.kind" class="anchor"></a><code>kind : <span>[ `Metadata <span>| `Block_data</span> <span>| `Context</span> <span>| `Protocol_table</span> <span>| `Protocol</span> <span>| `Cemented_cycle</span> ]</span>;</code></td></tr><tr id=".path" class="anchored"><td class="def field"><a href="#.path" class="anchor"></a><code>path : string;</code></td></tr></table><code>}</code><code> | </code><code><span class="extension">Inconsistent_floating_store</span> <span class="keyword">of</span> <a href="../Tezos_store/Store_types/index.html#type-block_descriptor">Tezos_store.Store_types.block_descriptor</a> * <a href="../Tezos_store/Store_types/index.html#type-block_descriptor">Tezos_store.Store_types.block_descriptor</a></code><code> | </code><code><span class="extension">Missing_target_block</span> <span class="keyword">of</span> <a href="../Tezos_store/Store_types/index.html#type-block_descriptor">Tezos_store.Store_types.block_descriptor</a></code><code> | </code><code><span class="extension">Cannot_read_floating_store</span> <span class="keyword">of</span> string</code><code> | </code><code><span class="extension">Cannot_retrieve_block_interval</span></code><code> | </code><code><span class="extension">Invalid_cemented_file</span> <span class="keyword">of</span> string</code><code> | </code><code><span class="extension">Missing_cemented_file</span> <span class="keyword">of</span> string</code><code> | </code><code><span class="extension">Corrupted_floating_store</span></code><code> | </code><code><span class="extension">Invalid_protocol_file</span> <span class="keyword">of</span> string</code><code> | </code><code><span class="extension">Target_block_validation_failed</span> <span class="keyword">of</span> <a href="../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> * string</code><code> | </code><code><span class="extension">Directory_already_exists</span> <span class="keyword">of</span> string</code><code> | </code><code><span class="extension">Empty_floating_store</span></code><code> | </code><code><span class="extension">Cannot_create_tmp_export_directory</span> <span class="keyword">of</span> string</code><code> | </code><code><span class="extension">Inconsistent_chain_import</span> <span class="keyword">of</span> </code><code>{</code><table class="record"><tr id=".expected" class="anchored"><td class="def field"><a href="#.expected" class="anchor"></a><code>expected : <a href="../../tezos-base/Tezos_base__Distributed_db_version/Name/index.html#type-t">Tezos_base__TzPervasives.Distributed_db_version.Name.t</a>;</code></td></tr><tr id=".got" class="anchored"><td class="def field"><a href="#.got" class="anchor"></a><code>got : <a href="../../tezos-base/Tezos_base__Distributed_db_version/Name/index.html#type-t">Tezos_base__TzPervasives.Distributed_db_version.Name.t</a>;</code></td></tr></table><code>}</code><code> | </code><code><span class="extension">Inconsistent_imported_block</span> <span class="keyword">of</span> <a href="../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> * <a href="../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></code><code> | </code><code><span class="extension">Inconsistent_snapshot_file</span> <span class="keyword">of</span> string</code></dt></dl><dl><dt class="spec value" id="val-current_version"><a href="#val-current_version" class="anchor"></a><code><span class="keyword">val</span> current_version : int</code></dt><dd><p>Current version of snapshots</p></dd></dl><dl><dt class="spec type" id="type-metadata"><a href="#type-metadata" class="anchor"></a><code><span class="keyword">type</span> metadata</code></dt><dd><p>The type of the snapshot <code>metadata</code>.</p></dd></dl><dl><dt class="spec type" id="type-snapshot_metadata"><a href="#type-snapshot_metadata" class="anchor"></a><code><span class="keyword">type</span> snapshot_metadata</code><code> = </code><table class="variant"><tr id="type-snapshot_metadata.Current_metadata" class="anchored"><td class="def constructor"><a href="#type-snapshot_metadata.Current_metadata" class="anchor"></a><code>| </code><code><span class="constructor">Current_metadata</span> <span class="keyword">of</span> <a href="index.html#type-metadata">metadata</a></code></td></tr><tr id="type-snapshot_metadata.Legacy_metadata" class="anchored"><td class="def constructor"><a href="#type-snapshot_metadata.Legacy_metadata" class="anchor"></a><code>| </code><code><span class="constructor">Legacy_metadata</span> <span class="keyword">of</span> </code><code>{</code><table class="record"><tr id="type-snapshot_metadata.version" class="anchored"><td class="def field"><a href="#type-snapshot_metadata.version" class="anchor"></a><code>version : string;</code></td></tr><tr id="type-snapshot_metadata.legacy_history_mode" class="anchored"><td class="def field"><a href="#type-snapshot_metadata.legacy_history_mode" class="anchor"></a><code>legacy_history_mode : <a href="../../tezos-shell-services/Tezos_shell_services/History_mode/Legacy/index.html#type-t">Tezos_shell_services.History_mode.Legacy.t</a>;</code></td></tr></table><code>}</code></td></tr></table></dt><dt class="spec type" id="type-snapshot_format"><a href="#type-snapshot_format" class="anchor"></a><code><span class="keyword">type</span> snapshot_format</code><code> = </code><table class="variant"><tr id="type-snapshot_format.Tar" class="anchored"><td class="def constructor"><a href="#type-snapshot_format.Tar" class="anchor"></a><code>| </code><code><span class="constructor">Tar</span></code></td></tr><tr id="type-snapshot_format.Raw" class="anchored"><td class="def constructor"><a href="#type-snapshot_format.Raw" class="anchor"></a><code>| </code><code><span class="constructor">Raw</span></code></td></tr></table></dt></dl><dl><dt class="spec value" id="val-pp_snapshot_format"><a href="#val-pp_snapshot_format" class="anchor"></a><code><span class="keyword">val</span> pp_snapshot_format : Stdlib.Format.formatter <span>&#45;&gt;</span> <a href="index.html#type-snapshot_format">snapshot_format</a> <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-snapshot_format_encoding"><a href="#val-snapshot_format_encoding" class="anchor"></a><code><span class="keyword">val</span> snapshot_format_encoding : <span><a href="index.html#type-snapshot_format">snapshot_format</a> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#module-Data_encoding">Tezos_base__TzPervasives.Data_encoding</a>.t</span></code></dt></dl><dl><dt class="spec type" id="type-snapshot_kind"><a href="#type-snapshot_kind" class="anchor"></a><code><span class="keyword">type</span> snapshot_kind</code><code> = </code><table class="variant"><tr id="type-snapshot_kind.Current" class="anchored"><td class="def constructor"><a href="#type-snapshot_kind.Current" class="anchor"></a><code>| </code><code><span class="constructor">Current</span> <span class="keyword">of</span> <a href="index.html#type-snapshot_format">snapshot_format</a></code></td></tr><tr id="type-snapshot_kind.Legacy" class="anchored"><td class="def constructor"><a href="#type-snapshot_kind.Legacy" class="anchor"></a><code>| </code><code><span class="constructor">Legacy</span></code></td></tr><tr id="type-snapshot_kind.Invalid" class="anchored"><td class="def constructor"><a href="#type-snapshot_kind.Invalid" class="anchor"></a><code>| </code><code><span class="constructor">Invalid</span></code></td></tr></table></dt></dl><dl><dt class="spec value" id="val-metadata_encoding"><a href="#val-metadata_encoding" class="anchor"></a><code><span class="keyword">val</span> metadata_encoding : <span><a href="index.html#type-metadata">metadata</a> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#module-Data_encoding">Tezos_base__TzPervasives.Data_encoding</a>.t</span></code></dt><dd><p>Encoding of a snapshot's <a href="index.html#type-metadata"><code>metadata</code></a></p></dd></dl><dl><dt class="spec value" id="val-pp_metadata"><a href="#val-pp_metadata" class="anchor"></a><code><span class="keyword">val</span> pp_metadata : Stdlib.Format.formatter <span>&#45;&gt;</span> <a href="index.html#type-metadata">metadata</a> <span>&#45;&gt;</span> unit</code></dt><dd><p>Pretty-printer of a snapshot's <a href="index.html#type-metadata"><code>metadata</code></a></p></dd></dl><dl><dt class="spec value" id="val-read_snapshot_metadata"><a href="#val-read_snapshot_metadata" class="anchor"></a><code><span class="keyword">val</span> read_snapshot_metadata : <span>snapshot_path:string</span> <span>&#45;&gt;</span> <span><span><a href="index.html#type-snapshot_metadata">snapshot_metadata</a> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>read_snapshot_metadata ~snapshot_path</code> reads <code>snapshot_file</code>'s metadata.</p></dd></dl><dl><dt class="spec value" id="val-export"><a href="#val-export" class="anchor"></a><code><span class="keyword">val</span> export : <span>?&#8288;snapshot_path:string</span> <span>&#45;&gt;</span> <a href="index.html#type-snapshot_format">snapshot_format</a> <span>&#45;&gt;</span> <span>?&#8288;rolling:bool</span> <span>&#45;&gt;</span> <span>block:<a href="../../tezos-shell-services/Tezos_shell_services/Block_services/index.html#type-block">Tezos_shell_services.Block_services.block</a></span> <span>&#45;&gt;</span> <span>store_dir:string</span> <span>&#45;&gt;</span> <span>context_dir:string</span> <span>&#45;&gt;</span> <span>chain_name:<a href="../../tezos-base/Tezos_base__Distributed_db_version/Name/index.html#type-t">Tezos_base__TzPervasives.Distributed_db_version.Name.t</a></span> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base__TzPervasives.Genesis.t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>export ?snapshot_path snapshot_format ?rolling ~block ~store_dir
   ~context_dir ~chain_name genesis</code> reads from the <code>store_dir</code> and <code>context_dir</code> the current state of the node and produces a snapshot, of the given <code>snapshot_format</code>, in <code>snapshot_file</code> if it is provided. Otherwise, a snapshot file name is automatically generated using the target block as hint. If <code>rolling</code> is set, only the necessary blocks will be exported.</p></dd></dl><dl><dt class="spec value" id="val-import"><a href="#val-import" class="anchor"></a><code><span class="keyword">val</span> import : <span>snapshot_path:string</span> <span>&#45;&gt;</span> <span>?&#8288;patch_context:<span>(<a href="../../tezos-context/Tezos_context/Context/index.html#type-t">Tezos_context.Context.t</a> <span>&#45;&gt;</span> <span><span><a href="../../tezos-context/Tezos_context/Context/index.html#type-t">Tezos_context.Context.t</a> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;block:<a href="../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;check_consistency:bool</span> <span>&#45;&gt;</span> <span>dst_store_dir:string</span> <span>&#45;&gt;</span> <span>dst_context_dir:string</span> <span>&#45;&gt;</span> <span>chain_name:<a href="../../tezos-base/Tezos_base__Distributed_db_version/Name/index.html#type-t">Tezos_base__TzPervasives.Distributed_db_version.Name.t</a></span> <span>&#45;&gt;</span> <span>user_activated_upgrades:<a href="../../tezos-base/Tezos_base/User_activated/index.html#type-upgrades">Tezos_base__TzPervasives.User_activated.upgrades</a></span> <span>&#45;&gt;</span> <span>user_activated_protocol_overrides:<a href="../../tezos-base/Tezos_base/User_activated/index.html#type-protocol_overrides">Tezos_base__TzPervasives.User_activated.protocol_overrides</a></span> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base__TzPervasives.Genesis.t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>import ~snapshot_path ?patch_context ?block ?check_consistency
   ~dst_store_dir ~dst_context_dir chain_name ~user_activated_upgrades
   ~user_activated_protocol_overrides genesis</code> populates <code>dst_store_dir</code> and <code>dst_context_dir</code> with the data contained in the <code>snapshot_file</code>. If <code>check_consistency</code> is unset, less security checks will be made and the import process will be more efficient. If <code>block</code> is set, the import process will make sure that the block is the correct one we load. <code>patch_context</code>, <code>user_activated_upgrades</code> and <code>user_activated_protocol_overrides</code> are passed to the validator in order to validate the target block.</p></dd></dl><dl><dt class="spec value" id="val-snapshot_file_kind"><a href="#val-snapshot_file_kind" class="anchor"></a><code><span class="keyword">val</span> snapshot_file_kind : <span>snapshot_path:string</span> <span>&#45;&gt;</span> <span><span><a href="index.html#type-snapshot_kind">snapshot_kind</a> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>snapshot_file_kind ~snapshot_file</code> reads the <code>snapshot_file</code> and returns its kind. Returns <code>Invalid</code> if it is a wrong snapshot file.</p></dd></dl></div></body></html>