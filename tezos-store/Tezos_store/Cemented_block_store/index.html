<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Cemented_block_store (tezos-store.Tezos_store.Cemented_block_store)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">tezos-store</a> &#x00BB; <a href="../index.html">Tezos_store</a> &#x00BB; Cemented_block_store</nav><h1>Module <code>Tezos_store.Cemented_block_store</code></h1><nav class="toc"><ul><li><a href="#invariants">Invariants</a></li><li><a href="#files-format">Files format</a></li></ul></nav></header><aside><p>Persistent block store with linear history</p><p>The cemented block store is a store where blocks are stored linearly (by level) in chunks. Blocks in this store should not be reorganized anymore and are thus *cemented*. As these blocks should not be accessed regularly and especially their optionally stored metadata, the later are compressed using a zip format to save disk space. For each chunk of blocks, a dedicated file is used. Moreover, to enable easy access and to prevent too much on-disk reading, two indexed maps are used to retrieve blocks hash from their level and their level from the block hash.</p><p>The cemented block store contains a set of files updated each time a new chunk is added to the store. These files indicate which interval of blocks (w.r.t. their levels) are stored in it.</p></aside><section><header><h2 id="invariants"><a href="#invariants" class="anchor"></a>Invariants</h2><p>This store is expected to respect the following invariants:</p><ul><li>A key/value present in an index is present as well in the other as value/key.</li></ul><ul><li>Every block stored is correctly referenced through its associated indexes.</li></ul><ul><li>A cemented chunk of blocks that is represented by the interval <code> i ; j </code> (with i &lt;= j) contains | j - i + 1 | blocks and are ordered from i to j in the file.</li></ul><ul><li>The set F of cemented chunks is always ordered by block level.</li></ul><ul><li>The cemented store does not contain holes: let F be the cemented chunks, if |F| &gt; 1 then:</li></ul><pre>      ∀f_x=(i,j) ∈ F ∧ x &lt; |F|, ∃f_y =(i', j'), x = y - 1 ∧ j + 1 = j'</pre><p>meaning the concatenation of every chunk must be continuous.</p><ul><li>A metadata zip file is indexed by the same interval as the chunks and, when it is the lowest chunk of metadata stored, is not assured to contain every block's metadata of the chunk.</li></ul></header></section><section><header><h2 id="files-format"><a href="#files-format" class="anchor"></a>Files format</h2><p>The cemented block store is composed of the following files:</p><ul><li>file: /&lt;i_j&gt;, a chunk of blocks from level i to level j. The format of this file is:</li></ul><p>| &lt;n&gt; × &lt;offset&gt; | &lt;n&gt; × &lt;block&gt; |</p><p>where n is (j - i + 1), &lt;offset&gt; is a 4 bytes integer representing the absolute offset of a block where the k-th (with 0 &lt;= k &lt; n) offset stands for the absolute offset of the k-th block in the file and with &lt;block&gt;, a <a href="../Block_repr/index.html#type-t"><code>Block_repr.t</code></a> value encoded using <a href="../Block_repr/index.html#val-encoding"><code>Block_repr.encoding</code></a> (thus prefixed by the its size).</p><ul><li>dir: /cemented_block_index_level, the Hash -&gt; Level key/value index ;</li></ul><ul><li>dir: /cemented_block_index_hash, the Level -&gt; Hash key/value index.</li></ul><ul><li>dir: /metadata, the directory containing chunks of compressed metadata (present if relevant).</li></ul><ul><li>files: /metadata/&lt;i_j&gt;.zip, the compressed metadata where every chunk of block's metadata is indexed by their level encoded as string (present if relevant).</li></ul></header><dl><dt class="spec module" id="module-Cemented_block_level_index"><a href="#module-Cemented_block_level_index" class="anchor"></a><code><span class="keyword">module</span> Cemented_block_level_index : Index.S <span class="keyword">with</span> <span class="keyword">type</span> <a href="index.html#module-Cemented_block_level_index">Cemented_block_level_index</a>.key = <a href="../Block_key/index.html#type-t">Block_key.t</a> <span class="keyword">and</span> <span class="keyword">type</span> <a href="index.html#module-Cemented_block_level_index">Cemented_block_level_index</a>.value = <a href="../Block_level/index.html#type-t">Block_level.t</a></code></dt><dd><p>On-disk index of block's hash to level.</p></dd></dl><dl><dt class="spec module" id="module-Cemented_block_hash_index"><a href="#module-Cemented_block_hash_index" class="anchor"></a><code><span class="keyword">module</span> Cemented_block_hash_index : Index.S <span class="keyword">with</span> <span class="keyword">type</span> <a href="index.html#module-Cemented_block_hash_index">Cemented_block_hash_index</a>.key = <a href="../Block_level/index.html#type-t">Block_level.t</a> <span class="keyword">and</span> <span class="keyword">type</span> <a href="index.html#module-Cemented_block_hash_index">Cemented_block_hash_index</a>.value = <a href="../Block_key/index.html#type-t">Block_key.t</a></code></dt><dd><p>On-disk index of block's level to hash.</p></dd></dl><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dd><p>The type of the cemented block store</p></dd></dl><dl><dt class="spec type" id="type-cemented_blocks_file"><a href="#type-cemented_blocks_file" class="anchor"></a><code><span class="keyword">type</span> cemented_blocks_file</code><code> = </code><code>{</code><table class="record"><tr id="type-cemented_blocks_file.start_level" class="anchored"><td class="def field"><a href="#type-cemented_blocks_file.start_level" class="anchor"></a><code>start_level : int32;</code></td></tr><tr id="type-cemented_blocks_file.end_level" class="anchored"><td class="def field"><a href="#type-cemented_blocks_file.end_level" class="anchor"></a><code>end_level : int32;</code></td></tr><tr id="type-cemented_blocks_file.file" class="anchored"><td class="def field"><a href="#type-cemented_blocks_file.file" class="anchor"></a><code>file : <span><span>[ `Cemented_blocks_file ]</span> <a href="../Naming/index.html#type-file">Naming.file</a></span>;</code></td></tr></table><code>}</code></dt><dd><p>The type for cemented block chunks file description</p></dd></dl><dl><dt class="spec value" id="val-init"><a href="#val-init" class="anchor"></a><code><span class="keyword">val</span> init : <span>?&#8288;log_size:int</span> <span>&#45;&gt;</span> <span><span>[&lt; `Chain_dir ]</span> <a href="../Naming/index.html#type-directory">Naming.directory</a></span> <span>&#45;&gt;</span> <span>readonly:bool</span> <span>&#45;&gt;</span> <span><span><a href="index.html#type-t">t</a> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>init ?log_size ~cemented_blocks_dir ~readonly</code> creates or loads an existing cemented block store at path <code>cemented_blocks_dir</code>. <code>cemented_blocks_dir</code> will be created if it does not exists. If <code>readonly</code> is true, cementing blocks will result in an error. <code>log_size</code> determines the index cache size.</p></dd></dl><dl><dt class="spec value" id="val-close"><a href="#val-close" class="anchor"></a><code><span class="keyword">val</span> close : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>close cemented_store</code> closes the <code>cemented_store</code> opened files: its indexes.</p></dd></dl><dl><dt class="spec value" id="val-cemented_blocks_files"><a href="#val-cemented_blocks_files" class="anchor"></a><code><span class="keyword">val</span> cemented_blocks_files : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span><a href="index.html#type-cemented_blocks_file">cemented_blocks_file</a> array</span> option</span></code></dt><dd><p><code>cemented_blocks_files cemented_store</code> returns the <b>current</b> list of cemented blocks chunks files.</p></dd></dl><dl><dt class="spec value" id="val-cemented_block_level_index"><a href="#val-cemented_block_level_index" class="anchor"></a><code><span class="keyword">val</span> cemented_block_level_index : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#module-Cemented_block_level_index">Cemented_block_level_index</a>.t</code></dt><dd><p><code>cemented_block_level_index block_store</code> returns the hash to level index.</p></dd></dl><dl><dt class="spec value" id="val-cemented_block_hash_index"><a href="#val-cemented_block_hash_index" class="anchor"></a><code><span class="keyword">val</span> cemented_block_hash_index : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#module-Cemented_block_hash_index">Cemented_block_hash_index</a>.t</code></dt><dd><p><code>cemented_block_hash_index block_store</code> returns the level to hash index.</p></dd></dl><dl><dt class="spec value" id="val-load_table"><a href="#val-load_table" class="anchor"></a><code><span class="keyword">val</span> load_table : <span><span>[ `Cemented_blocks_dir ]</span> <a href="../Naming/index.html#type-directory">Naming.directory</a></span> <span>&#45;&gt;</span> <span><span><span><span><a href="index.html#type-cemented_blocks_file">cemented_blocks_file</a> array</span> option</span> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>load_table ~cemented_blocks_dir</code> reads the <code>cemented_blocks_dir</code> directory and instantiate the cemented blocks chunks files.</p></dd></dl><dl><dt class="spec value" id="val-find_block_file"><a href="#val-find_block_file" class="anchor"></a><code><span class="keyword">val</span> find_block_file : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int32 <span>&#45;&gt;</span> <span><a href="index.html#type-cemented_blocks_file">cemented_blocks_file</a> option</span></code></dt><dd><p><code>find_block_file cemented_store block_level</code> lookups the <code>cemented_store</code> to find the cemented block chunk file that contains the block at level <code>block_level</code>. Returns <code>None</code> if the block cannot be found.</p></dd></dl><dl><dt class="spec value" id="val-is_cemented"><a href="#val-is_cemented" class="anchor"></a><code><span class="keyword">val</span> is_cemented : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>is_cemented cemented_store block_hash</code> checks if the <code>block_hash</code> is stored in the <code>cemented_store</code>.</p></dd></dl><dl><dt class="spec value" id="val-get_cemented_block_level"><a href="#val-get_cemented_block_level" class="anchor"></a><code><span class="keyword">val</span> get_cemented_block_level : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <span>int32 option</span></code></dt><dd><p><code>get_cemented_block_level cemented_store block_hash</code> returns the level of the <code>block_hash</code> if present in <code>cemented_store</code>. Returns <code>None</code> otherwise.</p></dd></dl><dl><dt class="spec value" id="val-get_cemented_block_hash"><a href="#val-get_cemented_block_hash" class="anchor"></a><code><span class="keyword">val</span> get_cemented_block_hash : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int32 <span>&#45;&gt;</span> <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> option</span></code></dt><dd><p><code>get_cemented_block_hash cemented_store block_level</code> returns the hash of the block at <code>block_level</code> if present in <code>cemented_store</code>. Returns <code>None</code> otherwise.</p></dd></dl><dl><dt class="spec value" id="val-read_block_metadata"><a href="#val-read_block_metadata" class="anchor"></a><code><span class="keyword">val</span> read_block_metadata : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int32 <span>&#45;&gt;</span> <span><span><span><a href="../Block_repr/index.html#type-metadata">Block_repr.metadata</a> option</span> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>read_block_metadata cemented_store block_level</code> returns the metadata of the block at <code>block_level</code> if present in <code>cemented_store</code>. Returns <code>None</code> otherwise.</p></dd></dl><dl><dt class="spec value" id="val-cement_blocks_metadata"><a href="#val-cement_blocks_metadata" class="anchor"></a><code><span class="keyword">val</span> cement_blocks_metadata : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="../Block_repr/index.html#type-t">Block_repr.t</a> list</span> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>cement_blocks_metadata cemented_store chunk</code> compresses and stores the metadata of blocks present in <code>chunk</code>. If no block of the given <code>chunk</code> contains metadata, nothing is done. Otherwise, for every block containing metadata, an entry is written in the dedicated .zip metadata file.</p><p>We assume that the blocks containing metadata are contiguous and if at least one block has metadata, then the blocks from that block with metadata to the last block of <code>chunk</code> must have metadata. However, we do not check the validity of this assumption.</p></dd></dl><dl><dt class="spec value" id="val-get_lowest_cemented_level"><a href="#val-get_lowest_cemented_level" class="anchor"></a><code><span class="keyword">val</span> get_lowest_cemented_level : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>int32 option</span></code></dt><dd><p><code>get_lowest_cemented_level cemented_store</code> returns the lowest cemented block in <code>cemented_store</code>, if it exists.</p></dd></dl><dl><dt class="spec value" id="val-get_highest_cemented_level"><a href="#val-get_highest_cemented_level" class="anchor"></a><code><span class="keyword">val</span> get_highest_cemented_level : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>int32 option</span></code></dt><dd><p><code>get_highest_cemented_level cemented_store</code> returns the highest cemented block in <code>cemented_store</code> if it exists.</p></dd></dl><dl><dt class="spec value" id="val-get_cemented_block_by_level"><a href="#val-get_cemented_block_by_level" class="anchor"></a><code><span class="keyword">val</span> get_cemented_block_by_level : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>read_metadata:bool</span> <span>&#45;&gt;</span> int32 <span>&#45;&gt;</span> <span><span><span><a href="../Block_repr/index.html#type-block">Block_repr.block</a> option</span> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>get_cemented_block_by_level cemented_store ~read_metadata level</code> reads the cemented block at <code>level</code> in <code>cemented_store</code>, if it exists. It also retrieves the metadata depending on <code>read_metadata</code>.</p></dd></dl><dl><dt class="spec value" id="val-get_cemented_block_by_hash"><a href="#val-get_cemented_block_by_hash" class="anchor"></a><code><span class="keyword">val</span> get_cemented_block_by_hash : <span>read_metadata:bool</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <span><span><span><a href="../Block_repr/index.html#type-block">Block_repr.block</a> option</span> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>get_cemented_block_by_hash cemented_store hash</code> reads the cemented block of <code>hash</code> in <code>cemented_store</code>, if it exists. It also retrieves the metadata depending on <code>read_metadata</code>.</p></dd></dl><dl><dt class="spec value" id="val-cement_blocks"><a href="#val-cement_blocks" class="anchor"></a><code><span class="keyword">val</span> cement_blocks : <span>?&#8288;check_consistency:bool</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>write_metadata:bool</span> <span>&#45;&gt;</span> <span><a href="../Block_repr/index.html#type-t">Block_repr.t</a> list</span> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>cemented_blocks ?check_consistency cemented_store ~write_metadata
    chunk</code> stores the <code>chunk</code> of blocks and write their metadata if the flag <code>write_metadata</code> is set. <code>check_consistency</code> (default is true) ensures that the blocks in the given <code>chunk</code> are contiguous.</p></dd></dl><dl><dt class="spec value" id="val-trigger_gc"><a href="#val-trigger_gc" class="anchor"></a><code><span class="keyword">val</span> trigger_gc : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-shell-services/Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>trigger_gc cemented_store history_mode</code> garbage collects metadata chunks and/or chunks from the <code>cemented_store</code> depending on the <span class="xref-unresolved" title="unresolved reference to &quot;History_mode.t&quot;"><code>History_mode</code>.t</span>:</p><ul><li>in <code>Archive</code> mode, nothing is done;</li></ul><ul><li>in <code>Full offset</code> mode, only <code>offset</code> chunks of <b>metadata</b> are kept;</li></ul><ul><li>in <code>Rolling offset</code> mode, only <code>offset</code> chunks of <b>metadata and chunks</b> are kept.</li></ul><p><b>Important:</b> when purging chunks of blocks, it is necessary to rewrite the index to remove garbage collected blocks. Therefore, the higher the offset is, the longest the GC phase will last.</p></dd></dl><dl><dt class="spec value" id="val-iter_cemented_file"><a href="#val-iter_cemented_file" class="anchor"></a><code><span class="keyword">val</span> iter_cemented_file : <span>(<a href="../Block_repr/index.html#type-block">Block_repr.block</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span>)</span> <span>&#45;&gt;</span> <a href="index.html#type-cemented_blocks_file">cemented_blocks_file</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>iter_cemented_file ~cemented_block_dir f block_file</code> reads from the cemented <code>block_file</code> located in <code>cemented_block_dir</code> and applies <code>f</code> on every block.</p></dd></dl><dl><dt class="spec value" id="val-check_indexes_consistency"><a href="#val-check_indexes_consistency" class="anchor"></a><code><span class="keyword">val</span> check_indexes_consistency : <span>?&#8288;post_step:<span>(unit <span>&#45;&gt;</span> <span>unit Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;genesis_hash:<a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>check_indexes_consistency ?post_step ?genesis_hash cemented_store
    history_mode</code> iterates over a partially initialized <code>cemented_store</code> that contains both chunks of blocks and indexes then check the consistency of each block: (hashes, predecessors and levels). The hash is not checked for <code>genesis_hash</code> and <code>post_step</code> is called after each treated chunk. This is used for snapshot imports.</p></dd></dl></section></div></body></html>