<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Floating_block_store (tezos-store.Tezos_store.Floating_block_store)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">tezos-store</a> &#x00BB; <a href="../index.html">Tezos_store</a> &#x00BB; Floating_block_store</nav><h1>Module <code>Tezos_store.Floating_block_store</code></h1><nav class="toc"><ul><li><a href="#invariants">Invariants</a></li><li><a href="#files-format">Files format</a></li></ul></nav></header><aside><p>Persistent block store with arborescent history</p><p>The floating block store is an append-only store where blocks are stored arbitrarily. This structure possess an indexed map <span class="xref-unresolved" title="unresolved reference to &quot;Block_hash.t&quot;"><code>Block_hash</code>.t</span> -&gt; (offset × predecessors) which points to its offset in the associated file along with an exponential list of predecessors block hashes (as implemented in <span class="xref-unresolved" title="unresolved reference to &quot;Block_store.compute_predecessors&quot;"><a href="../index.html#module-Block_store"><code>Block_store</code></a>.compute_predecessors</span>). The structure access/modification is protected by a mutex (<code>Lwt_idle_waiter</code>) and thus can be manipulated concurrently. Stored blocks may or may not contain metadata. The instance maintains an opened file descriptor. Therefore it must be properly closed or it might lead to a file descriptor leak.</p><p>Four different kind of instances are allowed to co-exist for an identical path: - RO, a read-only instance; - RW, a read-write instance - RO_TMP, RW_TMP, read-write instances; - Restore is a generic instance used to wrap leftover instances while fixing a crashed storage. See <a href="../Block_store/index.html"><code>Block_store</code></a>.</p></aside><section><header><h2 id="invariants"><a href="#invariants" class="anchor"></a>Invariants</h2><p>This store is expected to respect the following invariant:</p><ul><li>Every block stored is correctly indexed.</li></ul></header></section><section><header><h2 id="files-format"><a href="#files-format" class="anchor"></a>Files format</h2><p>The floating block store is composed of the following files:</p><ul><li>file: /&lt;kind&gt;_floating_block_store, a list of <a href="../Block_repr/index.html#type-t"><code>Block_repr.t</code></a>:</li></ul><p>| &lt;block&gt; * |</p><p>where &lt;kind&gt; is RO(_TMP), RW(_TMP) (see <a href="../Naming/index.html"><code>Naming</code></a>) and &lt;block&gt;, a <a href="../Block_repr/index.html#type-t"><code>Block_repr.t</code></a> value encoded using <a href="../Block_repr/index.html#val-encoding"><code>Block_repr.encoding</code></a> (thus prefixed by the its size).</p></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dd><p>The type of the floating store.</p></dd></dl><dl><dt class="spec type" id="type-floating_kind"><a href="#type-floating_kind" class="anchor"></a><code><span class="keyword">type</span> floating_kind</code><code> = <a href="../Naming/index.html#type-floating_kind">Naming.floating_kind</a></code><code> = </code><table class="variant"><tr id="type-floating_kind.RO" class="anchored"><td class="def constructor"><a href="#type-floating_kind.RO" class="anchor"></a><code>| </code><code><span class="constructor">RO</span></code></td></tr><tr id="type-floating_kind.RW" class="anchored"><td class="def constructor"><a href="#type-floating_kind.RW" class="anchor"></a><code>| </code><code><span class="constructor">RW</span></code></td></tr><tr id="type-floating_kind.RW_TMP" class="anchored"><td class="def constructor"><a href="#type-floating_kind.RW_TMP" class="anchor"></a><code>| </code><code><span class="constructor">RW_TMP</span></code></td></tr><tr id="type-floating_kind.RO_TMP" class="anchored"><td class="def constructor"><a href="#type-floating_kind.RO_TMP" class="anchor"></a><code>| </code><code><span class="constructor">RO_TMP</span></code></td></tr><tr id="type-floating_kind.Restore" class="anchored"><td class="def constructor"><a href="#type-floating_kind.Restore" class="anchor"></a><code>| </code><code><span class="constructor">Restore</span> <span class="keyword">of</span> <a href="index.html#type-floating_kind">floating_kind</a></code></td></tr></table></dt><dd><p>The type for the kind of floating store opened.</p></dd></dl><dl><dt class="spec value" id="val-kind"><a href="#val-kind" class="anchor"></a><code><span class="keyword">val</span> kind : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-floating_kind">floating_kind</a></code></dt><dd><p><code>kind floating_store</code> returns the floating store's kind.</p></dd></dl><dl><dt class="spec value" id="val-mem"><a href="#val-mem" class="anchor"></a><code><span class="keyword">val</span> mem : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <span>bool Lwt.t</span></code></dt><dd><p><code>mem floating_store hash</code> tests whether <code>hash</code> is stored in <code>floating_store</code>.</p></dd></dl><dl><dt class="spec value" id="val-find_predecessors"><a href="#val-find_predecessors" class="anchor"></a><code><span class="keyword">val</span> find_predecessors : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <span><span><span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span> option</span> Lwt.t</span></code></dt><dd><p><code>find_predecessors floating_store block_hash</code> reads from the index the list of <code>block_hash</code>'s predecessors if the block is stored in <code>floating_store</code>, returns <code>None</code> otherwise.</p></dd></dl><dl><dt class="spec value" id="val-read_block"><a href="#val-read_block" class="anchor"></a><code><span class="keyword">val</span> read_block : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <span><span><a href="../Block_repr/index.html#type-t">Block_repr.t</a> option</span> Lwt.t</span></code></dt><dd><p><code>read_block floating_store hash</code> reads from the file the block of <code>hash</code> if the block is stored in <code>floating_store</code>, returns <code>None</code> otherwise.</p></dd></dl><dl><dt class="spec value" id="val-read_block_and_predecessors"><a href="#val-read_block_and_predecessors" class="anchor"></a><code><span class="keyword">val</span> read_block_and_predecessors : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <span><span><span>(<a href="../Block_repr/index.html#type-t">Block_repr.t</a> * <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span>)</span> option</span> Lwt.t</span></code></dt><dd><p><code>read_block_and_predecessors floating_store hash</code> same as <code>read_block</code> but also returns the block's predecessors. Returns <code>None</code> if it fails to resolve the given <code>hash</code>.</p></dd></dl><dl><dt class="spec value" id="val-append_block"><a href="#val-append_block" class="anchor"></a><code><span class="keyword">val</span> append_block : <span>?&#8288;flush:bool</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span> <span>&#45;&gt;</span> <a href="../Block_repr/index.html#type-t">Block_repr.t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>append_block floating_store ?flush preds block</code> stores the <code>block</code> in <code>floating_store</code> updating its index with the given predecessors <code>preds</code> and flushing if <code>flush</code> is set to <code>true</code> (defaults to <code>true</code>).</p></dd></dl><dl><dt class="spec value" id="val-append_all"><a href="#val-append_all" class="anchor"></a><code><span class="keyword">val</span> append_all : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span> * <a href="../Block_repr/index.html#type-t">Block_repr.t</a>)</span> <a href="../../../tezos-error-monad/Tezos_error_monad__TzLwtreslib/Seq/index.html#type-t">Tezos_base__TzPervasives.Seq.t</a></span> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>append_all floating_store chunk</code> stores the <code>chunk</code> of (predecessors × blocks) in <code>floating_store</code> updating its index accordingly.</p></dd></dl><dl><dt class="spec value" id="val-iter_s_raw_fd"><a href="#val-iter_s_raw_fd" class="anchor"></a><code><span class="keyword">val</span> iter_s_raw_fd : <span>(<a href="../Block_repr/index.html#type-t">Block_repr.t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span>)</span> <span>&#45;&gt;</span> Lwt_unix.file_descr <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>iter_s_raw_fd f fd</code> unsafe sequential iterator on a file descriptor <code>fd</code>. Applies <code>f</code> on every block encountered.</p><p><b>Warning</b>: should be used for internal use only (e.g. snapshots).</p></dd></dl><dl><dt class="spec value" id="val-fold_left_s"><a href="#val-fold_left_s" class="anchor"></a><code><span class="keyword">val</span> fold_left_s : <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <a href="../Block_repr/index.html#type-block">Block_repr.block</a> <span>&#45;&gt;</span> <span><span><span class="type-var">'a</span> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span><span class="type-var">'a</span> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>fold_left_s f e floating_store</code> sequential fold left on the <code>floating_store</code> using <code>f</code> on every block and <code>e</code> as initial element. The function <code>f</code> is given the last read block.</p></dd></dl><dl><dt class="spec value" id="val-fold_left_with_pred_s"><a href="#val-fold_left_with_pred_s" class="anchor"></a><code><span class="keyword">val</span> fold_left_with_pred_s : <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span>(<a href="../Block_repr/index.html#type-block">Block_repr.block</a> * <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span>)</span> <span>&#45;&gt;</span> <span><span><span class="type-var">'a</span> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span><span class="type-var">'a</span> <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>fold_left_with_pred_s f e floating_store</code> sequential fold left on the <code>floating_store</code> using <code>f</code> on every block and <code>e</code> as initial element. The function <code>f</code> is given the last read block along with its predecessors.</p></dd></dl><dl><dt class="spec value" id="val-iter_s"><a href="#val-iter_s" class="anchor"></a><code><span class="keyword">val</span> iter_s : <span>(<a href="../Block_repr/index.html#type-t">Block_repr.t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>iter_s f floating_store</code> sequential iterator on the <code>floating_store</code>. Applies <code>f</code> on every block read.</p></dd></dl><dl><dt class="spec value" id="val-iter_with_pred_s"><a href="#val-iter_with_pred_s" class="anchor"></a><code><span class="keyword">val</span> iter_with_pred_s : <span>(<span>(<a href="../Block_repr/index.html#type-t">Block_repr.t</a> * <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span>)</span> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>iter_with_pred_s f floating_store</code> sequential iterator on the <code>floating_store</code>. Applies <code>f</code> on every block with its predecessors read.</p></dd></dl><dl><dt class="spec value" id="val-init"><a href="#val-init" class="anchor"></a><code><span class="keyword">val</span> init : <span><span>[ `Chain_dir ]</span> <a href="../Naming/index.html#type-directory">Naming.directory</a></span> <span>&#45;&gt;</span> <span>readonly:bool</span> <span>&#45;&gt;</span> <a href="index.html#type-floating_kind">floating_kind</a> <span>&#45;&gt;</span> <span><a href="index.html#type-t">t</a> Lwt.t</span></code></dt><dd><p><code>init ~chain_dir ~readonly kind</code> creates or load an existing floating store at path <code>chain_dir</code> with <code>kind</code>.</p><p><b>Warning</b> If <code>readonly</code> is not set, a <code>RO</code> instance is writable.</p></dd></dl><dl><dt class="spec value" id="val-close"><a href="#val-close" class="anchor"></a><code><span class="keyword">val</span> close : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>close floating_store</code> closes <code>floating_store</code> by closing the index and the associated opened file descriptor.</p></dd></dl><dl><dt class="spec value" id="val-delete_files"><a href="#val-delete_files" class="anchor"></a><code><span class="keyword">val</span> delete_files : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>delete_files store</code> closes the <code>store</code> then deletes its content.</p></dd></dl><dl><dt class="spec value" id="val-swap"><a href="#val-swap" class="anchor"></a><code><span class="keyword">val</span> swap : <span>src:<a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>dst:<a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>swap ~src ~dst</code> closes <code>src</code> and <code>dst</code> then overwrites <code>dst</code> files with <code>src</code>'s ones.</p><p><b>Warning</b> Non-atomic swap.</p></dd></dl><dl><dt class="spec value" id="val-append_floating_store"><a href="#val-append_floating_store" class="anchor"></a><code><span class="keyword">val</span> append_floating_store : <span>from:<a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>into:<a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tztrace">Tezos_base__TzPervasives.tztrace</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>append_floating_store ~from ~into</code> takes two opened floating block stores and appends all blocks contained in <code>from</code> to <code>into</code>.</p></dd></dl><aside><p>Integrity checks</p></aside><dl><dt class="spec value" id="val-all_files_exists"><a href="#val-all_files_exists" class="anchor"></a><code><span class="keyword">val</span> all_files_exists : <span><span>[ `Chain_dir ]</span> <a href="../Naming/index.html#type-directory">Naming.directory</a></span> <span>&#45;&gt;</span> <a href="index.html#type-floating_kind">floating_kind</a> <span>&#45;&gt;</span> <span>bool Lwt.t</span></code></dt><dd><p><code>all_files_exists ~chain_dir kind</code> checks that the files to the associated <code>kind</code> of floating store are present in the <code>chain_dir</code> directory.</p></dd></dl><dl><dt class="spec value" id="val-fix_integrity"><a href="#val-fix_integrity" class="anchor"></a><code><span class="keyword">val</span> fix_integrity : <span><span>[ `Chain_dir ]</span> <a href="../Naming/index.html#type-directory">Naming.directory</a></span> <span>&#45;&gt;</span> <a href="index.html#type-floating_kind">floating_kind</a> <span>&#45;&gt;</span> <span><span>unit <a href="../../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>fix_integrity ~chain_dir kind error</code> fixes the integrity of the floating block stores by removing corrupted data and restoring a consistent state.</p></dd></dl></section></div></body></html>