<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Floating_block_store (tezos-store.Tezos_store.Floating_block_store)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">tezos-store</a> &#x00BB; <a href="../index.html">Tezos_store</a> &#x00BB; Floating_block_store</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_store.Floating_block_store</span></code></h1><p>Persistent block store with arborescent history</p><p>The floating block store is an append-only store where blocks are stored arbitrarily. This structure possess an indexed map <code>Block_hash</code>.t -&gt; (offset × predecessors) which points to its offset in the associated file along with an exponential list of predecessors block hashes (as implemented in <code>Block_store</code>.compute_predecessors). The structure access/modification is protected by a mutex (<code>Lwt_idle_waiter</code>) and thus can be manipulated concurrently. Stored blocks may or may not contain metadata. The instance maintains an opened file descriptor. Therefore it must be properly closed or it might lead to a file descriptor leak.</p><p>Four different kind of instances are allowed to co-exist for an identical path: - RO, a read-only instance; - RW, a read-write instance - RO_TMP, RW_TMP, read-write instances; - Restore is a generic instance used to wrap leftover instances while fixing a crashed storage. See <a href="../Block_store/index.html"><code>Block_store</code></a>.</p></header><nav class="odoc-toc"><ul><li><a href="#invariants">Invariants</a></li><li><a href="#files-format">Files format</a></li></ul></nav><div class="odoc-content"><h2 id="invariants"><a href="#invariants" class="anchor"></a>Invariants</h2><p>This store is expected to respect the following invariant:</p><ul><li>Every block stored is correctly indexed.</li></ul><h2 id="files-format"><a href="#files-format" class="anchor"></a>Files format</h2><p>The floating block store is composed of the following files:</p><ul><li>file: /&lt;kind&gt;_floating_block_store, a list of <a href="../Block_repr/index.html#type-t"><code>Block_repr.t</code></a>:</li></ul><p>| &lt;block&gt; * |</p><p>where &lt;kind&gt; is RO(_TMP), RW(_TMP) (see <a href="../Naming/index.html"><code>Naming</code></a>) and &lt;block&gt;, a <a href="../Block_repr/index.html#type-t"><code>Block_repr.t</code></a> value encoded using <a href="../Block_repr/index.html#val-encoding"><code>Block_repr.encoding</code></a> (thus prefixed by the its size).</p><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The type of the floating store.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-floating_kind" class="anchored"><a href="#type-floating_kind" class="anchor"></a><code><span><span class="keyword">type</span> floating_kind</span><span> = <a href="../Naming/index.html#type-floating_kind">Naming.floating_kind</a></span><span> = </span></code><table><tr id="type-floating_kind.RO" class="anchored"><td class="def variant constructor"><a href="#type-floating_kind.RO" class="anchor"></a><code><span>| </span><span><span class="constructor">RO</span></span></code></td></tr><tr id="type-floating_kind.RW" class="anchored"><td class="def variant constructor"><a href="#type-floating_kind.RW" class="anchor"></a><code><span>| </span><span><span class="constructor">RW</span></span></code></td></tr><tr id="type-floating_kind.RW_TMP" class="anchored"><td class="def variant constructor"><a href="#type-floating_kind.RW_TMP" class="anchor"></a><code><span>| </span><span><span class="constructor">RW_TMP</span></span></code></td></tr><tr id="type-floating_kind.RO_TMP" class="anchored"><td class="def variant constructor"><a href="#type-floating_kind.RO_TMP" class="anchor"></a><code><span>| </span><span><span class="constructor">RO_TMP</span></span></code></td></tr><tr id="type-floating_kind.Restore" class="anchored"><td class="def variant constructor"><a href="#type-floating_kind.Restore" class="anchor"></a><code><span>| </span><span><span class="constructor">Restore</span> <span class="keyword">of</span> <a href="#type-floating_kind">floating_kind</a></span></code></td></tr></table></div><div class="spec-doc"><p>The type for the kind of floating store opened.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-kind" class="anchored"><a href="#val-kind" class="anchor"></a><code><span><span class="keyword">val</span> kind : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-floating_kind">floating_kind</a></span></code></div><div class="spec-doc"><p><code>kind floating_store</code> returns the floating store's kind.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-mem" class="anchored"><a href="#val-mem" class="anchor"></a><code><span><span class="keyword">val</span> mem : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>mem floating_store hash</code> tests whether <code>hash</code> is stored in <code>floating_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-find_predecessors" class="anchored"><a href="#val-find_predecessors" class="anchor"></a><code><span><span class="keyword">val</span> find_predecessors : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>find_predecessors floating_store block_hash</code> reads from the index the list of <code>block_hash</code>'s predecessors if the block is stored in <code>floating_store</code>, returns <code>None</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-read_block" class="anchored"><a href="#val-read_block" class="anchor"></a><code><span><span class="keyword">val</span> read_block : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../Block_repr/index.html#type-t">Block_repr.t</a> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>read_block floating_store hash</code> reads from the file the block of <code>hash</code> if the block is stored in <code>floating_store</code>, returns <code>None</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-read_block_and_predecessors" class="anchored"><a href="#val-read_block_and_predecessors" class="anchor"></a><code><span><span class="keyword">val</span> read_block_and_predecessors : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="../Block_repr/index.html#type-t">Block_repr.t</a> * <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span>)</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>read_block_and_predecessors floating_store hash</code> same as <code>read_block</code> but also returns the block's predecessors. Returns <code>None</code> if it fails to resolve the given <code>hash</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-append_block" class="anchored"><a href="#val-append_block" class="anchor"></a><code><span><span class="keyword">val</span> append_block : <span>?flush:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Block_repr/index.html#type-t">Block_repr.t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>append_block floating_store ?flush preds block</code> stores the <code>block</code> in <code>floating_store</code> updating its index with the given predecessors <code>preds</code> and flushing if <code>flush</code> is set to <code>true</code> (defaults to <code>true</code>).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-append_all" class="anchored"><a href="#val-append_all" class="anchor"></a><code><span><span class="keyword">val</span> append_all : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span> * <a href="../Block_repr/index.html#type-t">Block_repr.t</a>)</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>append_all floating_store chunk</code> stores the <code>chunk</code> of (predecessors × blocks) in <code>floating_store</code> updating its index accordingly.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-iter_s_raw_fd" class="anchored"><a href="#val-iter_s_raw_fd" class="anchor"></a><code><span><span class="keyword">val</span> iter_s_raw_fd : <span><span>(<span><a href="../Block_repr/index.html#type-t">Block_repr.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>iter_s_raw_fd f fd</code> unsafe sequential iterator on a file descriptor <code>fd</code>. Applies <code>f</code> on every block encountered.</p><p><b>Warning</b>: should be used for internal use only (e.g. snapshots).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-fold_left_s" class="anchored"><a href="#val-fold_left_s" class="anchor"></a><code><span><span class="keyword">val</span> fold_left_s : <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Block_repr/index.html#type-block">Block_repr.block</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>fold_left_s f e floating_store</code> sequential fold left on the <code>floating_store</code> using <code>f</code> on every block and <code>e</code> as initial element. The function <code>f</code> is given the last read block.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-fold_left_with_pred_s" class="anchored"><a href="#val-fold_left_with_pred_s" class="anchor"></a><code><span><span class="keyword">val</span> fold_left_with_pred_s : <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="../Block_repr/index.html#type-block">Block_repr.block</a> * <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'a</span>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>fold_left_with_pred_s f e floating_store</code> sequential fold left on the <code>floating_store</code> using <code>f</code> on every block and <code>e</code> as initial element. The function <code>f</code> is given the last read block along with its predecessors.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-iter_s" class="anchored"><a href="#val-iter_s" class="anchor"></a><code><span><span class="keyword">val</span> iter_s : <span><span>(<span><a href="../Block_repr/index.html#type-t">Block_repr.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>iter_s f floating_store</code> sequential iterator on the <code>floating_store</code>. Applies <code>f</code> on every block read.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-iter_with_pred_s" class="anchored"><a href="#val-iter_with_pred_s" class="anchor"></a><code><span><span class="keyword">val</span> iter_with_pred_s : <span><span>(<span><span>(<a href="../Block_repr/index.html#type-t">Block_repr.t</a> * <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>iter_with_pred_s f floating_store</code> sequential iterator on the <code>floating_store</code>. Applies <code>f</code> on every block with its predecessors read.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-init" class="anchored"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : <span><span><span>[ `Chain_dir ]</span> <a href="../Naming/index.html#type-directory">Naming.directory</a></span> <span class="arrow">&#45;&gt;</span></span> <span>readonly:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-floating_kind">floating_kind</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>init ~chain_dir ~readonly kind</code> creates or load an existing floating store at path <code>chain_dir</code> with <code>kind</code>.</p><p><b>Warning</b> If <code>readonly</code> is not set, a <code>RO</code> instance is writable.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-close" class="anchored"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>close floating_store</code> closes <code>floating_store</code> by closing the index and the associated opened file descriptor.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-delete_files" class="anchored"><a href="#val-delete_files" class="anchor"></a><code><span><span class="keyword">val</span> delete_files : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>delete_files store</code> closes the <code>store</code> then deletes its content.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-swap" class="anchored"><a href="#val-swap" class="anchor"></a><code><span><span class="keyword">val</span> swap : <span>src:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>dst:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>swap ~src ~dst</code> closes <code>src</code> and <code>dst</code> then overwrites <code>dst</code> files with <code>src</code>'s ones.</p><p><b>Warning</b> Non-atomic swap.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-append_floating_store" class="anchored"><a href="#val-append_floating_store" class="anchor"></a><code><span><span class="keyword">val</span> append_floating_store : <span>from:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>into:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>append_floating_store ~from ~into</code> takes two opened floating block stores and appends all blocks contained in <code>from</code> to <code>into</code>.</p></div></div><p>Integrity checks</p><div class="odoc-spec"><div class="spec value" id="val-all_files_exists" class="anchored"><a href="#val-all_files_exists" class="anchor"></a><code><span><span class="keyword">val</span> all_files_exists : <span><span><span>[ `Chain_dir ]</span> <a href="../Naming/index.html#type-directory">Naming.directory</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-floating_kind">floating_kind</a> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>all_files_exists ~chain_dir kind</code> checks that the files to the associated <code>kind</code> of floating store are present in the <code>chain_dir</code> directory.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-fix_integrity" class="anchored"><a href="#val-fix_integrity" class="anchor"></a><code><span><span class="keyword">val</span> fix_integrity : <span><span><span>[ `Chain_dir ]</span> <a href="../Naming/index.html#type-directory">Naming.directory</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-floating_kind">floating_kind</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>fix_integrity ~chain_dir kind error</code> fixes the integrity of the floating block stores by removing corrupted data and restoring a consistent state.</p></div></div></div></body></html>