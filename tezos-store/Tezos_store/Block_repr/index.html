<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Block_repr (tezos-store.Tezos_store.Block_repr)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-store</a> &#x00BB; <a href="../index.html">Tezos_store</a> &#x00BB; Block_repr</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_store.Block_repr</span></code></h1><p>Block representation effectively stored on disk and its accessors.</p></header><nav class="odoc-toc"><ul><li><a href="#type-definitions-and-encodings">Type definitions and encodings</a></li><li><a href="#genesis">Genesis</a></li><li><a href="#accessors">Accessors</a><ul><li><a href="#block-header-accessors">Block header accessors</a></li><li><a href="#metadata-accessors">Metadata accessors</a></li></ul></li><li><a href="#utility-functions">Utility functions</a></li></ul></nav><div class="odoc-content"><h2 id="type-definitions-and-encodings"><a href="#type-definitions-and-encodings" class="anchor"></a>Type definitions and encodings</h2><div class="odoc-spec"><div class="spec type" id="type-contents" class="anchored"><a href="#type-contents" class="anchor"></a><code><span><span class="keyword">type</span> contents</span><span> = </span><span>{</span></code><table><tr id="type-contents.header" class="anchored"><td class="def record field"><a href="#type-contents.header" class="anchor"></a><code><span>header : <a href="../../../tezos-base/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a>;</span></code></td></tr><tr id="type-contents.operations" class="anchored"><td class="def record field"><a href="#type-contents.operations" class="anchor"></a><code><span>operations : <span><span><a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> list</span> list</span>;</span></code></td></tr><tr id="type-contents.block_metadata_hash" class="anchored"><td class="def record field"><a href="#type-contents.block_metadata_hash" class="anchor"></a><code><span>block_metadata_hash : <span><a href="../../../tezos-crypto/Tezos_crypto/Block_metadata_hash/index.html#type-t">Tezos_crypto.Block_metadata_hash.t</a> option</span>;</span></code></td></tr><tr id="type-contents.operations_metadata_hashes" class="anchored"><td class="def record field"><a href="#type-contents.operations_metadata_hashes" class="anchor"></a><code><span>operations_metadata_hashes : <span><span><span><a href="../../../tezos-crypto/Tezos_crypto/Operation_metadata_hash/index.html#type-t">Tezos_crypto.Operation_metadata_hash.t</a> list</span> list</span> option</span>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>The type for the effective <code>contents</code> of a block is its header and the <code>operations</code> it contains. Their metadata hashes are also present.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-metadata" class="anchored"><a href="#type-metadata" class="anchor"></a><code><span><span class="keyword">type</span> metadata</span><span> = </span><span>{</span></code><table><tr id="type-metadata.message" class="anchored"><td class="def record field"><a href="#type-metadata.message" class="anchor"></a><code><span>message : <span>string option</span>;</span></code></td></tr><tr id="type-metadata.max_operations_ttl" class="anchored"><td class="def record field"><a href="#type-metadata.max_operations_ttl" class="anchor"></a><code><span>max_operations_ttl : int;</span></code></td></tr><tr id="type-metadata.last_allowed_fork_level" class="anchored"><td class="def record field"><a href="#type-metadata.last_allowed_fork_level" class="anchor"></a><code><span>last_allowed_fork_level : <span class="xref-unresolved">Stdlib</span>.Int32.t;</span></code></td></tr><tr id="type-metadata.block_metadata" class="anchored"><td class="def record field"><a href="#type-metadata.block_metadata" class="anchor"></a><code><span>block_metadata : <span class="xref-unresolved">Stdlib</span>.Bytes.t;</span></code></td></tr><tr id="type-metadata.operations_metadata" class="anchored"><td class="def record field"><a href="#type-metadata.operations_metadata" class="anchor"></a><code><span>operations_metadata : <span><span><span class="xref-unresolved">Stdlib</span>.Bytes.t list</span> list</span>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>The type for a block's <code>metadata</code> stored on disk. This representation is tightly linked to <a href="../../../tezos-validation/Tezos_validation/Block_validation/index.html#type-result"><code>Tezos_validation.Block_validation.result</code></a> which also has a strong dependency to <a href="../../../tezos-protocol-environment/Tezos_protocol_environment/index.html#type-validation_result"><code>Tezos_protocol_environment.validation_result</code></a>.</p><p>Some fields exposed by <a href="../../../tezos-validation/Tezos_validation/Block_validation/index.html#type-result"><code>Tezos_validation.Block_validation.result</code></a> are unnecessary hence the lack of direct link.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-block" class="anchored"><a href="#type-block" class="anchor"></a><code><span><span class="keyword">type</span> block</span><span> = </span><span>{</span></code><table><tr id="type-block.hash" class="anchored"><td class="def record field"><a href="#type-block.hash" class="anchor"></a><code><span>hash : <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a>;</span></code></td></tr><tr id="type-block.contents" class="anchored"><td class="def record field"><a href="#type-block.contents" class="anchor"></a><code><span>contents : <a href="#type-contents">contents</a>;</span></code></td></tr><tr id="type-block.metadata" class="anchored"><td class="def record field"><a href="#type-block.metadata" class="anchor"></a><code><span><span class="keyword">mutable</span> metadata : <span><a href="#type-metadata">metadata</a> option</span>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>The type for a <code>block</code> stored on disk.</p><p>The <code>hash</code> of the block is also stored to improve efficiency by not forcing the user to hash the header. This also allows to store fake hashes (e.g. sandbox's genesis blocks) but should be prevented by the API.</p><p>The <code>metadata</code> might not be present. The mutability flag allows users to re-use the same structure to store freshly loaded metadata.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <a href="#type-block">block</a></span></code></div></div><h2 id="genesis"><a href="#genesis" class="anchor"></a>Genesis</h2><div class="odoc-spec"><div class="spec value" id="val-create_genesis_block" class="anchored"><a href="#val-create_genesis_block" class="anchor"></a><code><span><span class="keyword">val</span> create_genesis_block : <span>genesis:<a href="../../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base.Genesis.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create_genesis_block ~genesis context_hash</code> creates a default genesis block for the given <code>genesis</code> and its <code>context_hash</code> that contains metadata.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-contents_encoding" class="anchored"><a href="#val-contents_encoding" class="anchor"></a><code><span><span class="keyword">val</span> contents_encoding : <span><a href="#type-contents">contents</a> <span class="xref-unresolved">Tezos_base__TzPervasives</span>.Data_encoding.t</span></span></code></div><div class="spec-doc"><p>Encoding for <a href="#type-block.contents"><code>contents</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-metadata_encoding" class="anchored"><a href="#val-metadata_encoding" class="anchor"></a><code><span><span class="keyword">val</span> metadata_encoding : <span><a href="#type-metadata">metadata</a> <span class="xref-unresolved">Tezos_base__TzPervasives</span>.Data_encoding.t</span></span></code></div><div class="spec-doc"><p>Encoding for <a href="#val-metadata"><code>metadata</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-encoding" class="anchored"><a href="#val-encoding" class="anchor"></a><code><span><span class="keyword">val</span> encoding : <span><a href="#type-t">t</a> <span class="xref-unresolved">Tezos_base__TzPervasives</span>.Data_encoding.t</span></span></code></div><div class="spec-doc"><p>Encoding for <a href="#type-t"><code>t</code></a> (and <a href="#type-block"><code>block</code></a>).</p><p><b>Important</b> An encoded block is prefixed by 4 bytes which stands for the length of the data. This is the case with <code>Data_encoding.dynamic_size ~kind:`Uint30</code> encodings. This will be expected to be present to improve the store efficiency.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-pp_json" class="anchored"><a href="#val-pp_json" class="anchor"></a><code><span><span class="keyword">val</span> pp_json : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>pp_json</code> pretty-print a block as JSON.</p></div></div><h2 id="accessors"><a href="#accessors" class="anchor"></a>Accessors</h2><div class="odoc-spec"><div class="spec value" id="val-descriptor" class="anchored"><a href="#val-descriptor" class="anchor"></a><code><span><span class="keyword">val</span> descriptor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Store_types/index.html#type-block_descriptor">Store_types.block_descriptor</a></span></code></div><div class="spec-doc"><p><code>descriptor block</code> returns the pair (hash x level) of <code>block</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-hash" class="anchored"><a href="#val-hash" class="anchor"></a><code><span><span class="keyword">val</span> hash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></span></code></div><div class="spec-doc"><p><code>hash block</code> returns the stored <code>block</code>'s hash. It is not guaranteed to be the same as <code>Block_header.hash (header block)</code> (e.g. in sandbox, the genesis block might have a fake hash).</p></div></div><div class="odoc-spec"><div class="spec value" id="val-operations" class="anchored"><a href="#val-operations" class="anchor"></a><code><span><span class="keyword">val</span> operations : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../../../tezos-base/Tezos_base/Operation/index.html#type-t">Tezos_base.Operation.t</a> list</span> list</span></span></code></div><div class="spec-doc"><p><code>operations block</code> returns the list of list of operations contained in the <code>block</code>.</p></div></div><h3 id="block-header-accessors"><a href="#block-header-accessors" class="anchor"></a>Block header accessors</h3><div class="odoc-spec"><div class="spec value" id="val-header" class="anchored"><a href="#val-header" class="anchor"></a><code><span><span class="keyword">val</span> header : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-base/Tezos_base/Block_header/index.html#type-t">Tezos_base.Block_header.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-shell_header" class="anchored"><a href="#val-shell_header" class="anchor"></a><code><span><span class="keyword">val</span> shell_header : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-base/Tezos_base/Block_header/index.html#type-shell_header">Tezos_base.Block_header.shell_header</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-level" class="anchored"><a href="#val-level" class="anchor"></a><code><span><span class="keyword">val</span> level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Stdlib</span>.Int32.t</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-proto_level" class="anchored"><a href="#val-proto_level" class="anchor"></a><code><span><span class="keyword">val</span> proto_level : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-predecessor" class="anchored"><a href="#val-predecessor" class="anchor"></a><code><span><span class="keyword">val</span> predecessor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-timestamp" class="anchored"><a href="#val-timestamp" class="anchor"></a><code><span><span class="keyword">val</span> timestamp : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-base/Tezos_base/Time/Protocol/index.html#type-t">Tezos_base.Time.Protocol.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-validation_passes" class="anchored"><a href="#val-validation_passes" class="anchor"></a><code><span><span class="keyword">val</span> validation_passes : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-operations_hash" class="anchored"><a href="#val-operations_hash" class="anchor"></a><code><span><span class="keyword">val</span> operations_hash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-crypto/Tezos_crypto/Operation_list_list_hash/index.html#type-t">Tezos_crypto.Operation_list_list_hash.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-fitness" class="anchored"><a href="#val-fitness" class="anchor"></a><code><span><span class="keyword">val</span> fitness : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-base/Tezos_base/Fitness/index.html#type-t">Tezos_base.Fitness.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-context" class="anchored"><a href="#val-context" class="anchor"></a><code><span><span class="keyword">val</span> context : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-protocol_data" class="anchored"><a href="#val-protocol_data" class="anchor"></a><code><span><span class="keyword">val</span> protocol_data : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Stdlib</span>.Bytes.t</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-block_metadata_hash" class="anchored"><a href="#val-block_metadata_hash" class="anchor"></a><code><span><span class="keyword">val</span> block_metadata_hash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Block_metadata_hash/index.html#type-t">Tezos_crypto.Block_metadata_hash.t</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-operations_metadata_hashes" class="anchored"><a href="#val-operations_metadata_hashes" class="anchor"></a><code><span><span class="keyword">val</span> operations_metadata_hashes : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span><a href="../../../tezos-crypto/Tezos_crypto/Operation_metadata_hash/index.html#type-t">Tezos_crypto.Operation_metadata_hash.t</a> list</span> list</span> option</span></span></code></div></div><h3 id="metadata-accessors"><a href="#metadata-accessors" class="anchor"></a>Metadata accessors</h3><div class="odoc-spec"><div class="spec value" id="val-metadata" class="anchored"><a href="#val-metadata" class="anchor"></a><code><span><span class="keyword">val</span> metadata : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-metadata">metadata</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-message" class="anchored"><a href="#val-message" class="anchor"></a><code><span><span class="keyword">val</span> message : <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-max_operations_ttl" class="anchored"><a href="#val-max_operations_ttl" class="anchor"></a><code><span><span class="keyword">val</span> max_operations_ttl : <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-last_allowed_fork_level" class="anchored"><a href="#val-last_allowed_fork_level" class="anchor"></a><code><span><span class="keyword">val</span> last_allowed_fork_level : <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Stdlib</span>.Int32.t</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-block_metadata" class="anchored"><a href="#val-block_metadata" class="anchor"></a><code><span><span class="keyword">val</span> block_metadata : <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Stdlib</span>.Bytes.t</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-operations_metadata" class="anchored"><a href="#val-operations_metadata" class="anchor"></a><code><span><span class="keyword">val</span> operations_metadata : <span><a href="#type-metadata">metadata</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="xref-unresolved">Stdlib</span>.Bytes.t list</span> list</span></span></code></div></div><h2 id="utility-functions"><a href="#utility-functions" class="anchor"></a>Utility functions</h2><div class="odoc-spec"><div class="spec value" id="val-check_block_consistency" class="anchored"><a href="#val-check_block_consistency" class="anchor"></a><code><span><span class="keyword">val</span> check_block_consistency : <span>?genesis_hash:<a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span class="arrow">&#45;&gt;</span></span> <span>?pred_block:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
<span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit,Â <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>check_block_consistency ?genesis_hash ?pred_block block</code> checks that the stored data is consistent:</p><ul><li>Does the <code>hash</code> stored equals the result of <code>Block_header.hash</code> of its header and, if not, is this the stored <code>genesis_hash</code>?</li><li>Is the <code>block</code> a successor of <code>pred_block</code> with regards to its level and its predecessor's hash?</li><li>Are the stored operations hashes consistent regarding the stored operations hashes?</li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-read_next_block_exn" class="anchored"><a href="#val-read_next_block_exn" class="anchor"></a><code><span><span class="keyword">val</span> read_next_block_exn : <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="#type-t">t</a> * int)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>read_next_block_exn fd</code> reads from <code>fd</code> and decode the next block found in the descriptor. The <code>fd</code>'s offset is moved as a side effect. This returns the decoded block along with the block length (number of bytes) of the encoded block. This function updates the given <code>fd</code> state and may raise Unix.error errors, see Unix.read.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-read_next_block" class="anchored"><a href="#val-read_next_block" class="anchor"></a><code><span><span class="keyword">val</span> read_next_block : <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-t">t</a> * int)</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <code>read_next_block fd</code> but returns <code>None</code> if there was an error.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-pread_block_exn" class="anchored"><a href="#val-pread_block_exn" class="anchor"></a><code><span><span class="keyword">val</span> pread_block_exn : <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span>file_offset:int <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="#type-t">t</a> * int)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>pread_block_exn fd ~file_offset</code> reads from <code>fd</code> and decode the block at offset <code>file_offset</code> in the descriptor. This returns the decoded block along with the block length (number of bytes) of the encoded block. This function may raise Unix.error errors, see Unix.read.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-pread_block" class="anchored"><a href="#val-pread_block" class="anchor"></a><code><span><span class="keyword">val</span> pread_block : <span><span class="xref-unresolved">Lwt_unix</span>.file_descr <span class="arrow">&#45;&gt;</span></span> <span>file_offset:int <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-t">t</a> * int)</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p>Same as <code>pread_block fd ~file_offset</code> but returns <code>None</code> if there was an error.</p></div></div></div></body></html>