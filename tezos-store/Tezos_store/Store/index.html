<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Store (tezos-store.Tezos_store.Store)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">tezos-store</a> &#x00BB; <a href="../index.html">Tezos_store</a> &#x00BB; Store</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_store.Store</span></code></h1><p>Store abstraction over the disk storage.</p></header><nav class="odoc-toc"><ul><li><a href="#description">Description</a></li><li><a href="#concurrency">Concurrency</a></li><li><a href="#context-handling">Context handling</a></li><li><a href="#history-mode-handling">History mode handling</a></li><li><a href="#protocol-store">Protocol store</a></li><li><a href="#chain-stores-and-merging">Chain stores and merging</a></li><li><a href="#files-hierarchy">Files hierarchy</a><ul><li><a href="#initialization">Initialization</a></li><li><a href="#accessors">Accessors</a></li></ul></li></ul></nav><div class="odoc-content"><h3 id="description"><a href="#description" class="anchor"></a>Description</h3><p>This component handles the on-disk storage of static objects such as blocks, operations, block's metadata, protocols and chain data. The store also handle the chain's current state: current head, invalid blocks, active testchains, ...</p><h3 id="concurrency"><a href="#concurrency" class="anchor"></a>Concurrency</h3><p>This module is designed to handle concurrent accesses to the store. Data-races and deadlocks might still happen through the use of potential dangerous calls that are documented as such. Both a mutex and a lockfile are present to handle concurrent accesses at process levels.</p><h3 id="context-handling"><a href="#context-handling" class="anchor"></a>Context handling</h3><p>The store manages the context and thus handles the context initialization through <code>Lib_context</code>.Context.init. This is done, among others reasons, for a consistency checking when storing a block. The store never commits a context on-disk.</p><h3 id="history-mode-handling"><a href="#history-mode-handling" class="anchor"></a>History mode handling</h3><p>This store handles the three different <code>Tezos_base</code>.History_mode.t:</p><ul><li>Archive: maintains every block that is part of the chain including their metadata.</li></ul><ul><li>Full &lt;offset&gt;: maintains every block that is part of the chain but prune the metadata for blocks that are below the following threshold level: <code>last_allowed_fork_level</code> of the current head - <code>offset</code> cycles.</li></ul><ul><li>Rolling &lt;offset&gt;: maintains rolling windows which contain recent blocks that are part of the chain, along with their metadata. It prunes everything that is below the following threshold level: <code>last_allowed_fork_level</code> of the current head - <code>offset</code> cycles.</li></ul><h3 id="protocol-store"><a href="#protocol-store" class="anchor"></a>Protocol store</h3><p>The store has a global protocol store which may be shared by different chain stores.</p><h3 id="chain-stores-and-merging"><a href="#chain-stores-and-merging" class="anchor"></a>Chain stores and merging</h3><p>The store has a toplevel chain store which is called the <code>main_chain_store</code> and which can be accessed through the store's interface. It is either created if the associated directory is not present or loaded if it was previously created. This <code>main_chain_store</code> is able to recursively spawn testchains which are also chain stores. Those testchains are also recursively able to spawn their own testchains.</p><p>Each chain store possesses its own block store and therefore its own historic. It also maintains a state throughout its run which is composed of:</p><ul><li><code>current_head</code>: the current head of the chain.</li></ul><ul><li><code>target</code>: the optional block for which the chain must pass. The store will not allow to store blocks past this target's block if they are not its successors.</li></ul><ul><li><code>checkpoint</code>: the block that represents the no fork point level: blocks that are below this block are discarded.</li></ul><ul><li><code>savepoint</code>: the block that represents the lowest block with metadata in the chain.</li></ul><ul><li><code>caboose</code>: the block that represents the lowest block known in the chain (with or without metadata).</li></ul><p>More details and invariants on these points are provided in the <a href="Chain/index.html"><code>Chain</code></a> module description below.</p><p>When a block is promoted as head of the chain (through <a href="Chain/index.html#val-set_head"><code>Chain.set_head</code></a>) the following happens:</p><ul><li>A check is made if this head is consistent (i.e. if it's not below the checkpoint);</li></ul><ul><li>If the <code>last_allowed_fork_level</code> of the head is different from the previous head's one, then we can establish that a cycle has been completed and we can start cementing this cycle by &quot;triggering a merge&quot;.</li></ul><p>A merge phase consists of establishing the interval of blocks to cement, which is trivially <code>last_allowed_fork_level(new_head)</code> to <code>last_allowed_fork_level(prev_head)</code>, but also, for Full and Rolling history modes, keep some extra blocks so that we make sure to keep blocks above max_operation_ttl(last_allowed_fork_level(checkpoint)). This is done to make sure that we can export snapshots at the checkpoint level later on. This merging operation is asynchronous, the changes will be committed on disk only when the merge succeeds. Before that, we only retain the changes in RAM so we may keep storing new blocks without blocking. If the process crashes while a merge is happening, the state is reloaded before the merging point. More details are given in <a href="Chain/index.html#val-set_head"><code>Chain.set_head</code></a>.</p><h3 id="files-hierarchy"><a href="#files-hierarchy" class="anchor"></a>Files hierarchy</h3><p>The store directory is organized as follows:</p><ul><li>/&lt;protocol_dir&gt;/ the directory containing stored protocols</li></ul><ul><li>/&lt;protocol_dir&gt;/&lt;protocol_hash_b58&gt;* files containing the encoded protocol.</li></ul><ul><li>/&lt;chain_id_b58&gt;/ the <code>chain_store_dir</code> directory containing the main chain store.</li></ul><p><code>chain_store_dir</code> is a symbol for all chain stores directory hierarchy.</p><ul><li><code>chain_store_dir</code>/&lt;lock&gt; the lockfile.</li></ul><ul><li><code>chain_store_dir</code>/&lt;config.json&gt; the chain store's configuration as a JSON file.</li></ul><ul><li><code>chain_store_dir</code>/&lt;block_store&gt; contains every file mentioned in <a href="../Block_store/index.html"><code>Block_store</code></a>'s format.</li></ul><ul><li><code>chain_store_dir</code>/&lt;stored_data&gt;* files containing encoded simple data structures such as: genesis block, checkpoint, savepoint, caboose, protocol levels, forked chains, alternate heads, invalid blocks, etc.</li></ul><ul><li><code>chain_store_dir</code>/testchains/&lt;testchain_id_b58&gt;/ contains the <code>chains_store_dir</code>'s test chain, based on a similar hierarchy.</li></ul><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The abstract type to manipulate the global store.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-store" class="anchored"><a href="#type-store" class="anchor"></a><code><span><span class="keyword">type</span> store</span><span> = <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>The type alias for the global store.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-chain_store" class="anchored"><a href="#type-chain_store" class="anchor"></a><code><span><span class="keyword">type</span> chain_store</span></code></div><div class="spec-doc"><p>The abstract type for a chain store. Equivalent to <a href="Chain/index.html#type-t"><code>Chain.t</code></a>.</p></div></div><h4 id="initialization"><a href="#initialization" class="anchor"></a>Initialization</h4><div class="odoc-spec"><div class="spec value" id="val-init" class="anchored"><a href="#val-init" class="anchor"></a><code><span><span class="keyword">val</span> init : <span>?patch_context:<span>(<span><a href="../../../tezos-context/Tezos_context/Context/index.html#type-t">Tezos_context.Context.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="../../../tezos-context/Tezos_context/Context/index.html#type-t">Tezos_context.Context.t</a>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
<span>?commit_genesis:<span>(<span>chain_id:<a href="../../../tezos-crypto/Tezos_crypto/Chain_id/index.html#type-t">Tezos_crypto.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="../../../tezos-crypto/Tezos_crypto/Context_hash/index.html#type-t">Tezos_crypto.Context_hash.t</a>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span>?history_mode:<a href="../../../tezos-shell-services/Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a> <span class="arrow">&#45;&gt;</span></span>
<span>?readonly:bool <span class="arrow">&#45;&gt;</span></span> <span>store_dir:string <span class="arrow">&#45;&gt;</span></span> <span>context_dir:string <span class="arrow">&#45;&gt;</span></span> <span>allow_testchains:bool <span class="arrow">&#45;&gt;</span></span>
<span><a href="../../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base.Genesis.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-store">store</a>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>init ?patch_context ?commit_genesis ?history_mode ~store_dir
    ~context_dir ~allow_testchains genesis</code> initializes the store and a main chain store. If <code>store_dir</code> (resp. <code>context_dir</code>) does not exist, a fresh store (resp. context) is created. Otherwise, it loads the store (resp. context) from reading the adequate directory. If <code>allow_testchains</code> is passed, the store will be able to fork chains and instantiate testchain's sub chain stores, for all chains contained in the store. The chain store created is based on the <code>genesis</code> provided. Its chain identifier will be computed using the <a href="../../../tezos-crypto/Tezos_crypto/Chain_id/index.html#val-of_block_hash"><code>Tezos_crypto.Chain_id.of_block_hash</code></a> function.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">patch_context</span> <p>the handle called when initializing the context. It usually is passed when creating a sandboxed chain.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">commit_genesis</span> <p>overrides the default initial genesis commit when the node is created. This is used for when the context must be in readonly (e.g. started by an external validator) and we want to prevent writing in the context. <b>Warning</b> passing this argument will initialize the context in readonly. Default: <code>Context</code>.commit_genesis is called with <code>genesis</code></p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">history_mode</span> <p>the history mode used throughout the store. If a directory already exists and the given <code>history_mode</code> is different, the initialization will fail. Default: <code>History_mode</code>.default (which should correspond to full with 5 extra preserved cycles.)</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">readonly</span> <p>a flag that, if set to true, prevent writing throughout the store <b>and</b> context. Default: false</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-main_chain_store" class="anchored"><a href="#val-main_chain_store" class="anchor"></a><code><span><span class="keyword">val</span> main_chain_store : <span><a href="#type-store">store</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-chain_store">chain_store</a></span></code></div><div class="spec-doc"><p><code>main_chain_store global_store</code> returns the main chain store.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-close_store" class="anchored"><a href="#val-close_store" class="anchor"></a><code><span><span class="keyword">val</span> close_store : <span><a href="#type-store">store</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>close_store global_store</code> closes the underlying block store and context along with every opened file descriptors for every chain store and testchain present in <code>global_store</code>. If the store is already closed, this function is idempotent.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-may_switch_history_mode" class="anchored"><a href="#val-may_switch_history_mode" class="anchor"></a><code><span><span class="keyword">val</span> may_switch_history_mode : <span>store_dir:string <span class="arrow">&#45;&gt;</span></span> <span>context_dir:string <span class="arrow">&#45;&gt;</span></span>
<span><a href="../../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base.Genesis.t</a> <span class="arrow">&#45;&gt;</span></span> <span>new_history_mode:<a href="../../../tezos-shell-services/Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>may_switch_history_mode ?patch_context ~store_dir ~context_dir
    genesis ~new_history_mode</code> tries switching the store located at <code>store_dir</code> (if present) to <code>new_history_mode</code> when possible.</p></div></div><h4 id="accessors"><a href="#accessors" class="anchor"></a>Accessors</h4><div class="odoc-spec"><div class="spec value" id="val-directory" class="anchored"><a href="#val-directory" class="anchor"></a><code><span><span class="keyword">val</span> directory : <span><a href="#type-store">store</a> <span class="arrow">&#45;&gt;</span></span> <span><span>[ `Store_dir ]</span> <a href="../Naming/index.html#type-directory">Naming.directory</a></span></span></code></div><div class="spec-doc"><p><code>directory global_store</code> returns the path where <code>global_store</code> is stored. This corresponds to the <code>store_dir</code> argument passed to the <code>init</code> function.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-context_index" class="anchored"><a href="#val-context_index" class="anchor"></a><code><span><span class="keyword">val</span> context_index : <span><a href="#type-store">store</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-context/Tezos_context/Context/index.html#type-index">Tezos_context.Context.index</a></span></code></div><div class="spec-doc"><p><code>context_index global_store</code> returns the context's index initialized in <code>global_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-allow_testchains" class="anchored"><a href="#val-allow_testchains" class="anchor"></a><code><span><span class="keyword">val</span> allow_testchains : <span><a href="#type-store">store</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>allow_testchains global_store</code> returns true if the store is allowed to fork testchains.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-all_chain_stores" class="anchored"><a href="#val-all_chain_stores" class="anchor"></a><code><span><span class="keyword">val</span> all_chain_stores : <span><a href="#type-store">store</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-chain_store">chain_store</a> list</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>all_chain_stores global_store</code> returns every initialized chain store in <code>global_store</code>. The resulting list also comprises the initialized testchains. If <code>allow_testchains</code> is false, the list will only contain a single element.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-get_chain_store" class="anchored"><a href="#val-get_chain_store" class="anchor"></a><code><span><span class="keyword">val</span> get_chain_store : <span><a href="#type-store">store</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Chain_id/index.html#type-t">Tezos_crypto.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-chain_store">chain_store</a>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_chain_store global_store chain_id</code> returns the initialized chain store in <code>global_store</code> associated to <code>chain_id</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-get_chain_store_opt" class="anchored"><a href="#val-get_chain_store_opt" class="anchor"></a><code><span><span class="keyword">val</span> get_chain_store_opt : <span><a href="#type-store">store</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-crypto/Tezos_crypto/Chain_id/index.html#type-t">Tezos_crypto.Chain_id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-chain_store">chain_store</a> option</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_chain_store_opt global_store chain_id</code> optional version of <code>get_chain_store</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-make_pp_store" class="anchored"><a href="#val-make_pp_store" class="anchor"></a><code><span><span class="keyword">val</span> make_pp_store : <span><a href="#type-store">store</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-make_pp_chain_store" class="anchored"><a href="#val-make_pp_chain_store" class="anchor"></a><code><span><span class="keyword">val</span> make_pp_chain_store : <span><a href="#type-chain_store">chain_store</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Block" class="anchored"><a href="#module-Block" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Block/index.html">Block</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>The module for handling block-related operations such as storing and reading data associated to a single block.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Chain" class="anchored"><a href="#module-Chain" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Chain/index.html">Chain</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>The module for handling chain-related operations such as setting the head of the chain, updating the chain state, forking testchains, ...</p></div></div><div class="odoc-spec"><div class="spec value" id="val-global_block_watcher" class="anchored"><a href="#val-global_block_watcher" class="anchor"></a><code><span><span class="keyword">val</span> global_block_watcher : <span><a href="#type-store">store</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="Chain/index.html#type-chain_store">Chain.chain_store</a> * <a href="Block/index.html#type-block">Block.block</a>)</span> <span class="xref-unresolved">Lwt_stream</span>.t</span> * <span class="xref-unresolved">Lwt_watcher</span>.stopper</span></code></div><div class="spec-doc"><p><code>global_block_watcher global_store</code> instantiates a new block watcher for every chain store active in <code>global_store</code>.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Protocol" class="anchored"><a href="#module-Protocol" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Protocol/index.html">Protocol</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>The module for handling protocol-related operations.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Chain_traversal" class="anchored"><a href="#module-Chain_traversal" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Chain_traversal/index.html">Chain_traversal</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>The utility module used to traverse the chain.</p></div></div></div></body></html>