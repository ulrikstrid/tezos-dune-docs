<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Legacy (tezos-store.Tezos_store.Legacy)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">tezos-store</a> &#x00BB; <a href="../index.html">Tezos_store</a> &#x00BB; Legacy</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_store.Legacy</span></code></h1><p>Legacy storage upgrade</p><p>The legacy store upgrade aims to migrate a storage using the LMDB backend (v0.0.4) to the new store representation (v0.0.5). This migration is available for any store running v0.0.4 with any history mode. The upgrade procedure is going to retrieve each the block and its associated data available in the old store, convert and store them in the new backend. It will preserve all the information originally contained in the LMDB store such as the current head, checkpoint, savepoint and caboose.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module" id="module-Hardcoded" class="anchored"><a href="#module-Hardcoded" class="anchor"></a><code><span><span class="keyword">module</span> </span><span><a href="Hardcoded/index.html">Hardcoded</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Module for handling values needed by the legacy upgrade. It exposes the <code>cycle_length</code> to allow upgrading <code>supported_networks</code> only. These values are mandatory as the new backend regroup blocks by cycles, something which was not available in the previous representation when the metadata of blocks is not fully available.</p></div></div><div class="odoc-spec"><div class="spec type extension"><code><span><span class="keyword">type</span> <span class="xref-unresolved">Tezos_base__TzPervasives.error</span> += </span></code><table><tr id="extension-Failed_to_convert_protocol" class="anchored"><td class="def extension"><a href="#extension-Failed_to_convert_protocol" class="anchor"></a><code><span>| </span><span><span class="extension">Failed_to_convert_protocol</span> <span class="keyword">of</span> <a href="../../../tezos-crypto/Tezos_crypto/Protocol_hash/index.html#type-t">Tezos_crypto.Protocol_hash.t</a></span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec type extension"><code><span><span class="keyword">type</span> <span class="xref-unresolved">Tezos_base__TzPervasives.error</span> += </span></code><table><tr id="extension-Failed_to_upgrade" class="anchored"><td class="def extension"><a href="#extension-Failed_to_upgrade" class="anchor"></a><code><span>| </span><span><span class="extension">Failed_to_upgrade</span> <span class="keyword">of</span> string</span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec value" id="val-temporary_former_store_path" class="anchored"><a href="#val-temporary_former_store_path" class="anchor"></a><code><span><span class="keyword">val</span> temporary_former_store_path : <span>data_dir:string <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>temporary_former_store_path ~data_dir</code> returns the path of the preserved legacy store given a <code>data_dir</code></p></div></div><div class="odoc-spec"><div class="spec value" id="val-raw_upgrade" class="anchored"><a href="#val-raw_upgrade" class="anchor"></a><code><span><span class="keyword">val</span> raw_upgrade : <span><a href="../../../tezos-base/Tezos_base/Distributed_db_version/Name/index.html#type-t">Tezos_base.Distributed_db_version.Name.t</a> <span class="arrow">&#45;&gt;</span></span> <span>new_store:<a href="../Store/index.html#type-t">Store.t</a> <span class="arrow">&#45;&gt;</span></span> <span>legacy_state:<a href="../../../tezos-legacy-store/Tezos_legacy_store/Legacy_state/index.html#type-t">Tezos_legacy_store.Legacy_state.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-shell-services/Tezos_shell_services/History_mode/index.html#type-t">Tezos_shell_services.History_mode.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base.Genesis.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>raw_upgrade chain_name ~new_store ~old_store hm genesis</code> is the low level upgrade procedure which performs the store upgrade given the direct paths to the <code>new_store</code> and <code>old_store</code>.</p><p><b>Warning</b> This function is unsafe and is exposed for testing purposes.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-upgrade_0_0_4" class="anchored"><a href="#val-upgrade_0_0_4" class="anchor"></a><code><span><span class="keyword">val</span> upgrade_0_0_4 : <span>data_dir:string <span class="arrow">&#45;&gt;</span></span> <span>?patch_context:<span>(<span><a href="../../../tezos-context/Tezos_context/Context/index.html#type-t">Tezos_context.Context.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="../../../tezos-context/Tezos_context/Context/index.html#type-t">Tezos_context.Context.t</a>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span>
<span class="arrow">&#45;&gt;</span></span> <span>chain_name:<a href="../../../tezos-base/Tezos_base/Distributed_db_version/Name/index.html#type-t">Tezos_base.Distributed_db_version.Name.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-base/Tezos_base/Genesis/index.html#type-t">Tezos_base.Genesis.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>upgrade_0_0_4 ~data_dir genesis patch_context ~chain_name</code> upgrades a store located in <code>data_dir</code> base on v.0.0.4 to a v0.0.5. It outputs information regarding the necessary actions in order to cleanely complete the upgrade. Here this case, the user must delete the old storage. Returns the message to display to the user.</p></div></div></div></body></html>