<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>P2p_connect_handler (tezos-p2p.Tezos_p2p.P2p_connect_handler)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">tezos-p2p</a> &#x00BB; <a href="../index.html">Tezos_p2p</a> &#x00BB; P2p_connect_handler</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_p2p.P2p_connect_handler</span></code></h1><p>This module manages incoming <code>accept</code> and outgoing connections <code>connect</code>.</p><p><code>connect</code> and <code>accept</code> try to authenticate the remote point, and agree on protocol version. They ultimately returns a <code>P2p_conn.t</code> which provides the highest-level view of a connection in <code>lib_p2p</code>.</p><p>TODO: properly document this modules, including side-effects and interaction with <code>P2p_pool</code>.</p><p>Functions of this module can trigger two types of events. They can *log* <code>P2p_connection.P2p_event.t</code>, and they can trigger condition variables defined in <code>P2p_trigger.t</code>.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>('msg, 'peer, 'conn) t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-config" class="anchored"><a href="#type-config" class="anchor"></a><code><span><span class="keyword">type</span> config</span><span> = </span><span>{</span></code><table><tr id="type-config.incoming_app_message_queue_size" class="anchored"><td class="def record field"><a href="#type-config.incoming_app_message_queue_size" class="anchor"></a><code><span>incoming_app_message_queue_size : <span>int option</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Size of the message queue for user messages (messages returned by this module's <code>read</code> function.</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.private_mode" class="anchored"><td class="def record field"><a href="#type-config.private_mode" class="anchor"></a><code><span>private_mode : bool;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>If <code>true</code>, only open outgoing/accept incoming connections to/from peers whose addresses are in <code>trusted_peers</code>, and inform these peers that the identity of this node should not be revealed to the rest of the network.</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.min_connections" class="anchored"><td class="def record field"><a href="#type-config.min_connections" class="anchor"></a><code><span>min_connections : int;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Strict minimum number of connections (triggers <code>LogEvent.too_few_connections</code>).</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.max_connections" class="anchored"><td class="def record field"><a href="#type-config.max_connections" class="anchor"></a><code><span>max_connections : int;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Max number of connections. If it's reached, <code>connect</code> and <code>accept</code> will fail, i.e. not add more connections (also triggers <code>LogEvent.too_many_connections</code>).</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.max_incoming_connections" class="anchored"><td class="def record field"><a href="#type-config.max_incoming_connections" class="anchor"></a><code><span>max_incoming_connections : int;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Max not-yet-authentified incoming connections. Above this number, <code>accept</code> will start dropping incoming connections.</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.incoming_message_queue_size" class="anchored"><td class="def record field"><a href="#type-config.incoming_message_queue_size" class="anchor"></a><code><span>incoming_message_queue_size : <span>int option</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Size of the incoming message queue internal of a peer's Reader (See <code>P2p_connection.accept</code>).</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.outgoing_message_queue_size" class="anchored"><td class="def record field"><a href="#type-config.outgoing_message_queue_size" class="anchor"></a><code><span>outgoing_message_queue_size : <span>int option</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Size of the outgoing message queue internal to a peer's Writer (See <code>P2p_connection.accept</code>).</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.binary_chunks_size" class="anchored"><td class="def record field"><a href="#type-config.binary_chunks_size" class="anchor"></a><code><span>binary_chunks_size : <span>int option</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Size (in bytes) of binary blocks that are sent to other peers. Default value is 64 kB.</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.identity" class="anchored"><td class="def record field"><a href="#type-config.identity" class="anchor"></a><code><span>identity : <a href="../../../tezos-base/Tezos_base/P2p_identity/index.html#type-t">Tezos_base.P2p_identity.t</a>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Our identity.</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.connection_timeout" class="anchored"><td class="def record field"><a href="#type-config.connection_timeout" class="anchor"></a><code><span>connection_timeout : <a href="../../../tezos-base/Tezos_base/Time/System/Span/index.html#type-t">Tezos_base.Time.System.Span.t</a>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Maximum time allowed to the establishment of a connection.</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.authentication_timeout" class="anchored"><td class="def record field"><a href="#type-config.authentication_timeout" class="anchor"></a><code><span>authentication_timeout : <a href="../../../tezos-base/Tezos_base/Time/System/Span/index.html#type-t">Tezos_base.Time.System.Span.t</a>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Maximum time allowed to the establishment of a connection.</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.reconnection_config" class="anchored"><td class="def record field"><a href="#type-config.reconnection_config" class="anchor"></a><code><span>reconnection_config : <a href="../P2p_point_state/Info/index.html#type-reconnection_config">P2p_point_state.Info.reconnection_config</a>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>Delay granted to a peer to perform authentication.</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.proof_of_work_target" class="anchored"><td class="def record field"><a href="#type-config.proof_of_work_target" class="anchor"></a><code><span>proof_of_work_target : <a href="../../../tezos-crypto/Tezos_crypto/Crypto_box/index.html#type-pow_target">Tezos_crypto.Crypto_box.pow_target</a>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>The greylisting configuration.</p><span class="comment-delim">*)</span></td></tr><tr id="type-config.listening_port" class="anchored"><td class="def record field"><a href="#type-config.listening_port" class="anchor"></a><code><span>listening_port : <span><a href="../../../tezos-base/Tezos_base/P2p_addr/index.html#type-port">Tezos_base.P2p_addr.port</a> option</span>;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>The proof of work target we require from peers.</p><span class="comment-delim">*)</span></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>?p2p_versions:<span><a href="../../../tezos-base/Tezos_base/P2p_version/index.html#type-t">Tezos_base.P2p_version.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
<span><a href="#type-config">config</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="../P2p_pool/index.html#type-t">P2p_pool.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'msg</span> <a href="../P2p_params/index.html#type-message_config">P2p_params.message_config</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'conn</span> <a href="../P2p_params/index.html#type-conn_meta_config">P2p_params.conn_meta_config</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../P2p_io_scheduler/index.html#type-t">P2p_io_scheduler.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../P2p_trigger/index.html#type-t">P2p_trigger.t</a> <span class="arrow">&#45;&gt;</span></span> <span>log:<span>(<span><a href="../../../tezos-base/Tezos_base/P2p_connection/P2p_event/index.html#type-t">Tezos_base.P2p_connection.P2p_event.t</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
<span>answerer:<span><span><span class="type-var">'msg</span> <a href="../P2p_answerer/index.html#type-t">P2p_answerer.t</a></span> <span class="xref-unresolved">Stdlib</span>.Lazy.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>create ?p2p_version config pool message_config socket_meta_config
     scheduler triggers log answerer</code> returns a connection handler.</p><p><code>config</code> is a record of configuration parameters. <code>triggers</code> is a record of condition variable used to signal some events to other modules. <code>log</code> is a callback to signal events to the upper layer. <code>answerer</code> is a parameterized callback that defines how the p2p layer will reply to incoming <code>P2p_message.t</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-config" class="anchored"><a href="#val-config" class="anchor"></a><code><span><span class="keyword">val</span> config : <span><span><span>(<span class="type-var">_</span>, <span class="type-var">_</span>, <span class="type-var">_</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-config">config</a></span></code></div><div class="spec-doc"><p><code>config t</code> is the <code>config</code> argument passed to <code>t</code> at creation.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-connect" class="anchored"><a href="#val-connect" class="anchor"></a><code><span><span class="keyword">val</span> connect : <span>?timeout:<a href="../../../tezos-base/Tezos_base/Time/System/Span/index.html#type-t">Tezos_base.Time.System.Span.t</a> <span class="arrow">&#45;&gt;</span></span>
<span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-base/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.P2p_point.Id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="../P2p_conn/index.html#type-t">P2p_conn.t</a></span>, <span><a href="../../../tezos-error-monad/Tezos_error_monad/TzCore/index.html#type-error">Tezos_error_monad.TzCore.error</a> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>connect ?timeout t point</code> tries to add a connection to <code>point</code> in <code>t</code> in less than <code>timeout</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-accept" class="anchored"><a href="#val-accept" class="anchor"></a><code><span><span class="keyword">val</span> accept : <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../P2p_fd/index.html#type-t">P2p_fd.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../tezos-base/Tezos_base/P2p_point/Id/index.html#type-t">Tezos_base.P2p_point.Id.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>accept t fd point</code> instructs <code>t</code> to start the process of accepting a connection from <code>fd</code>. <code>point</code> is the id of the connecting host.</p><p>Incoming connection from banned points, or when maximum number of connection is exceeded are refused. The maximum number of connections maybe be randomly increased by one. Socket <code>fd</code> is closed when the connection is refused.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-stat" class="anchored"><a href="#val-stat" class="anchor"></a><code><span><span class="keyword">val</span> stat : <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="../../../tezos-base/Tezos_base/P2p_stat/index.html#type-t">Tezos_base.P2p_stat.t</a></span></code></div><div class="spec-doc"><p><code>stat t</code> is a snapshot of current bandwidth usage for the entire connected peers.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-on_new_connection" class="anchored"><a href="#val-on_new_connection" class="anchor"></a><code><span><span class="keyword">val</span> on_new_connection : <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="../../../tezos-base/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base.P2p_peer.Id.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="../P2p_conn/index.html#type-t">P2p_conn.t</a></span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>on_new_connection t f</code> installs <code>f</code> as a hook for new connections in <code>t</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-destroy" class="anchored"><a href="#val-destroy" class="anchor"></a><code><span><span class="keyword">val</span> destroy : <span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div></div></body></html>