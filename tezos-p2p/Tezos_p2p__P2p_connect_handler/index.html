<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tezos_p2p__P2p_connect_handler (tezos-p2p.Tezos_p2p__P2p_connect_handler)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">tezos-p2p</a> &#x00BB; Tezos_p2p__P2p_connect_handler</nav><h1>Module <code>Tezos_p2p__P2p_connect_handler</code></h1><p>This module manages incoming <code>accept</code> and outgoing connections <code>connect</code>.</p><p><code>connect</code> and <code>accept</code> try to authenticate the remote point, and agree on protocol version. They ultimately returns a <code>P2p_conn.t</code> which provides the highest-level view of a connection in <code>lib_p2p</code>.</p><p>TODO: properly document this modules, including side-effects and interaction with <code>P2p_pool</code>.</p><p>Functions of this module can trigger two types of events. They can *log* <code>P2p_connection.P2p_event.t</code>, and they can trigger condition variables defined in <code>P2p_trigger.t</code>.</p></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> <span>('msg, 'peer, 'conn) t</span></code></dt><dt class="spec type" id="type-config"><a href="#type-config" class="anchor"></a><code><span class="keyword">type</span> config</code><code> = </code><code>{</code><table class="record"><tr id="type-config.incoming_app_message_queue_size" class="anchored"><td class="def field"><a href="#type-config.incoming_app_message_queue_size" class="anchor"></a><code>incoming_app_message_queue_size : <span>int option</span>;</code></td><td class="doc"><p>Size of the message queue for user messages (messages returned by this module's <code>read</code> function.</p></td></tr><tr id="type-config.private_mode" class="anchored"><td class="def field"><a href="#type-config.private_mode" class="anchor"></a><code>private_mode : bool;</code></td><td class="doc"><p>If <code>true</code>, only open outgoing/accept incoming connections to/from peers whose addresses are in <code>trusted_peers</code>, and inform these peers that the identity of this node should not be revealed to the rest of the network.</p></td></tr><tr id="type-config.min_connections" class="anchored"><td class="def field"><a href="#type-config.min_connections" class="anchor"></a><code>min_connections : int;</code></td><td class="doc"><p>Strict minimum number of connections (triggers <code>LogEvent.too_few_connections</code>).</p></td></tr><tr id="type-config.max_connections" class="anchored"><td class="def field"><a href="#type-config.max_connections" class="anchor"></a><code>max_connections : int;</code></td><td class="doc"><p>Max number of connections. If it's reached, <code>connect</code> and <code>accept</code> will fail, i.e. not add more connections (also triggers <code>LogEvent.too_many_connections</code>).</p></td></tr><tr id="type-config.max_incoming_connections" class="anchored"><td class="def field"><a href="#type-config.max_incoming_connections" class="anchor"></a><code>max_incoming_connections : int;</code></td><td class="doc"><p>Max not-yet-authentified incoming connections. Above this number, <code>accept</code> will start dropping incoming connections.</p></td></tr><tr id="type-config.incoming_message_queue_size" class="anchored"><td class="def field"><a href="#type-config.incoming_message_queue_size" class="anchor"></a><code>incoming_message_queue_size : <span>int option</span>;</code></td><td class="doc"><p>Size of the incoming message queue internal of a peer's Reader (See <code>P2p_connection.accept</code>).</p></td></tr><tr id="type-config.outgoing_message_queue_size" class="anchored"><td class="def field"><a href="#type-config.outgoing_message_queue_size" class="anchor"></a><code>outgoing_message_queue_size : <span>int option</span>;</code></td><td class="doc"><p>Size of the outgoing message queue internal to a peer's Writer (See <code>P2p_connection.accept</code>).</p></td></tr><tr id="type-config.binary_chunks_size" class="anchored"><td class="def field"><a href="#type-config.binary_chunks_size" class="anchor"></a><code>binary_chunks_size : <span>int option</span>;</code></td><td class="doc"><p>Size (in bytes) of binary blocks that are sent to other peers. Default value is 64 kB.</p></td></tr><tr id="type-config.identity" class="anchored"><td class="def field"><a href="#type-config.identity" class="anchor"></a><code>identity : <a href="../../tezos-base/Tezos_base/P2p_identity/index.html#type-t">Tezos_base__TzPervasives.P2p_identity.t</a>;</code></td><td class="doc"><p>Our identity.</p></td></tr><tr id="type-config.connection_timeout" class="anchored"><td class="def field"><a href="#type-config.connection_timeout" class="anchor"></a><code>connection_timeout : <a href="../../tezos-base/Tezos_base__Time/System/Span/index.html#type-t">Tezos_base__TzPervasives.Time.System.Span.t</a>;</code></td><td class="doc"><p>Maximum time allowed to the establishment of a connection.</p></td></tr><tr id="type-config.authentication_timeout" class="anchored"><td class="def field"><a href="#type-config.authentication_timeout" class="anchor"></a><code>authentication_timeout : <a href="../../tezos-base/Tezos_base__Time/System/Span/index.html#type-t">Tezos_base__TzPervasives.Time.System.Span.t</a>;</code></td><td class="doc"><p>Maximum time allowed to the establishment of a connection.</p></td></tr><tr id="type-config.reconnection_config" class="anchored"><td class="def field"><a href="#type-config.reconnection_config" class="anchor"></a><code>reconnection_config : <a href="../Tezos_p2p/P2p_point_state/Info/index.html#type-reconnection_config">Tezos_p2p.P2p_point_state.Info.reconnection_config</a>;</code></td><td class="doc"><p>Delay granted to a peer to perform authentication.</p></td></tr><tr id="type-config.proof_of_work_target" class="anchored"><td class="def field"><a href="#type-config.proof_of_work_target" class="anchor"></a><code>proof_of_work_target : <a href="../../tezos-crypto/Tezos_crypto/Crypto_box/index.html#type-pow_target">Tezos_crypto.Crypto_box.pow_target</a>;</code></td><td class="doc"><p>The greylisting configuration.</p></td></tr><tr id="type-config.listening_port" class="anchored"><td class="def field"><a href="#type-config.listening_port" class="anchor"></a><code>listening_port : <span><a href="../../tezos-base/Tezos_base/P2p_addr/index.html#type-port">Tezos_base__TzPervasives.P2p_addr.port</a> option</span>;</code></td><td class="doc"><p>The proof of work target we require from peers.</p></td></tr></table><code>}</code></dt></dl><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <span>?&#8288;p2p_versions:<span><a href="../../tezos-base/Tezos_base/P2p_version/index.html#type-t">Tezos_base__TzPervasives.P2p_version.t</a> list</span></span> <span>&#45;&gt;</span> <a href="index.html#type-config">config</a> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="../Tezos_p2p/P2p_pool/index.html#type-t">Tezos_p2p.P2p_pool.t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'msg</span> <a href="../Tezos_p2p/P2p_params/index.html#type-message_config">Tezos_p2p.P2p_params.message_config</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'conn</span> <a href="../Tezos_p2p/P2p_params/index.html#type-conn_meta_config">Tezos_p2p.P2p_params.conn_meta_config</a></span> <span>&#45;&gt;</span> <a href="../Tezos_p2p/P2p_io_scheduler/index.html#type-t">Tezos_p2p.P2p_io_scheduler.t</a> <span>&#45;&gt;</span> <a href="../Tezos_p2p/P2p_trigger/index.html#type-t">Tezos_p2p.P2p_trigger.t</a> <span>&#45;&gt;</span> <span>log:<span>(<a href="../../tezos-base/Tezos_base__P2p_connection/P2p_event/index.html#type-t">Tezos_base__TzPervasives.P2p_connection.P2p_event.t</a> <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> <span>answerer:<span><span><span class="type-var">'msg</span> <a href="../Tezos_p2p/P2p_answerer/index.html#type-t">Tezos_p2p.P2p_answerer.t</a></span> Stdlib.Lazy.t</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>create ?p2p_version config pool message_config socket_meta_config
     scheduler triggers log answerer</code> returns a connection handler.</p><p><code>config</code> is a record of configuration parameters. <code>triggers</code> is a record of condition variable used to signal some events to other modules. <code>log</code> is a callback to signal events to the upper layer. <code>answerer</code> is a parameterized callback that defines how the p2p layer will reply to incoming <code>P2p_message.t</code>.</p></dd></dl><dl><dt class="spec value" id="val-config"><a href="#val-config" class="anchor"></a><code><span class="keyword">val</span> config : <span><span>(<span class="type-var">_</span>, <span class="type-var">_</span>, <span class="type-var">_</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="index.html#type-config">config</a></code></dt><dd><p><code>config t</code> is the <code>config</code> argument passed to <code>t</code> at creation.</p></dd></dl><dl><dt class="spec value" id="val-connect"><a href="#val-connect" class="anchor"></a><code><span class="keyword">val</span> connect : <span>?&#8288;timeout:<a href="../../tezos-base/Tezos_base__Time/System/Span/index.html#type-t">Tezos_base__TzPervasives.Time.System.Span.t</a></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base__P2p_point/Id/index.html#type-t">Tezos_base__TzPervasives.P2p_point.Id.t</a> <span>&#45;&gt;</span> <span><span><span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="../Tezos_p2p/P2p_conn/index.html#type-t">Tezos_p2p.P2p_conn.t</a></span> <a href="../../tezos-base/Tezos_base__TzPervasives/index.html#type-tzresult">Tezos_base__TzPervasives.tzresult</a></span> Lwt.t</span></code></dt><dd><p><code>connect ?timeout t point</code> tries to add a connection to <code>point</code> in <code>t</code> in less than <code>timeout</code>.</p></dd></dl><dl><dt class="spec value" id="val-accept"><a href="#val-accept" class="anchor"></a><code><span class="keyword">val</span> accept : <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../Tezos_p2p/P2p_fd/index.html#type-t">Tezos_p2p.P2p_fd.t</a> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base__P2p_point/Id/index.html#type-t">Tezos_base__TzPervasives.P2p_point.Id.t</a> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>accept t fd point</code> instructs <code>t</code> to start the process of accepting a connection from <code>fd</code>. <code>point</code> is the id of the connecting host.</p><p>Incoming connection from banned points, or when maximum number of connection is exceeded are refused. The maximum number of connections maybe be randomly increased by one. Socket <code>fd</code> is closed when the connection is refused.</p></dd></dl><dl><dt class="spec value" id="val-stat"><a href="#val-stat" class="anchor"></a><code><span class="keyword">val</span> stat : <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../../tezos-base/Tezos_base/P2p_stat/index.html#type-t">Tezos_base__TzPervasives.P2p_stat.t</a></code></dt><dd><p><code>stat t</code> is a snapshot of current bandwidth usage for the entire connected peers.</p></dd></dl><dl><dt class="spec value" id="val-on_new_connection"><a href="#val-on_new_connection" class="anchor"></a><code><span class="keyword">val</span> on_new_connection : <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>(<a href="../../tezos-base/Tezos_base/P2p_peer_id/index.html#type-t">Tezos_base__TzPervasives.P2p_peer.Id.t</a> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="../Tezos_p2p/P2p_conn/index.html#type-t">Tezos_p2p.P2p_conn.t</a></span> <span>&#45;&gt;</span> unit)</span> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>on_new_connection t f</code> installs <code>f</code> as a hook for new connections in <code>t</code>.</p></dd></dl><dl><dt class="spec value" id="val-destroy"><a href="#val-destroy" class="anchor"></a><code><span class="keyword">val</span> destroy : <span><span>(<span class="type-var">'msg</span>, <span class="type-var">'peer</span>, <span class="type-var">'conn</span>)</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt></dl></div></body></html>