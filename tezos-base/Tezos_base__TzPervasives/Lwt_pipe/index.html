<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Lwt_pipe (tezos-base.Tezos_base__TzPervasives.Lwt_pipe)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../../index.html">tezos-base</a> &#x00BB; <a href="../index.html">Tezos_base__TzPervasives</a> &#x00BB; Lwt_pipe</nav><h1>Module <code>Tezos_base__TzPervasives.Lwt_pipe</code></h1></header><aside><p>Data queues similar to the <code>Pipe</code> module in Jane Street's <code>Async</code> library. They are implemented with <code>Queue</code>s, limited in size, and use Lwt primitives for concurrent access.</p></aside><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> <span>'a t</span></code></dt><dd><p>Type of queues holding values of type <code>'a</code>.</p></dd></dl><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <span>?&#8288;size:<span>(int * <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> int)</span>)</span></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>create ~size:(max_size, compute_size) ()</code> is an empty queue that can hold max <code>size</code> &quot;bytes&quot; of data, using <code>compute_size</code> to compute the number of &quot;bytes&quot; in a datum.</p><p>Note that you can use <code>size</code> to actually limit the size in byte (i.e., the memory foot-print of the structure (in this case, consider using <a href="index.html#val-push_overhead"><code>push_overhead</code></a> to account for the boilerplate memory), but you can also use <code>size</code> to limit the foot-print of the structure for some other resource. E.g., you can spin up tasks in separate processes and limit the number of concurrently running processes.</p><p>Also note that the size bound is not inclusive. So with <code>size</code> set to <code>(2, fun _ -&gt; 1)</code> you can add one (1) element and then the pipe is full. (It is full because adding any other element would take the total size to <code>2</code> which is not strictly smaller than the <code>max_size</code> bound.)</p><p>If you do not provide a <code>size</code> argument, the queue is unbounded.</p></dd></dl><dl><dt class="spec value" id="val-push"><a href="#val-push" class="anchor"></a><code><span class="keyword">val</span> push : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>push q v</code> is a promise that is pending until there is enough space in <code>q</code> to accommodate <code>v</code>. When this happens <code>v</code> is added to the end of <code>q</code> and the promise resolves.</p><p>If there is enough space in <code>q</code> to accommodate <code>v</code> when the call is made, then the <code>v</code> is added immediately and an already resolved promise is returned.</p><p>Note that if several writes are stuck because the pipe is full. These writes will succeed in an order that might be different from the order the write attempts were made. Specifically, when pushing elements of different computed sizes, smaller pushes may be resolved earlier if enough space is freed.</p><dl><dt>raises {!Closed}</dt><dd><p>if <code>q</code> is closed. More specifically, the promise is rejected with <a href="index.html#exception-Closed"><code>Closed</code></a> if <code>q</code> is closed.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-pop"><a href="#val-pop" class="anchor"></a><code><span class="keyword">val</span> pop : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span></code></dt><dd><p><code>pop q</code> is a promise that is pending until there is an element in <code>q</code>. When this happens an element is removed and the promise is fulfilled with it.</p><p>If there is already an element in <code>q</code> when the call is made, the element is removed immediately and an already resolved promise is returned.</p><dl><dt>raises {!Closed}</dt><dd><p>if <code>q</code> is empty and closed. More specifically, the promise is rejected with <a href="index.html#exception-Closed"><code>Closed</code></a> if <code>q</code> is empty and closed.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-pop_with_timeout"><a href="#val-pop_with_timeout" class="anchor"></a><code><span class="keyword">val</span> pop_with_timeout : <span>unit Lwt.t</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span><span class="type-var">'a</span> option</span> Lwt.t</span></code></dt><dd><p><code>pop_with_timeout t q</code> is a promise that behaves similarly to <code>pop q</code> except that it resolves with <code>None</code> if <code>t</code> resolves before there is an element in <code>q</code> to pop.</p><p>Note that there can be multiple promises that are awaiting for an element to pop from the queue. As a result, it is possible that <code>pop_with_timeout</code> is fulfilled with <code>None</code> even though values have been pushed to the <code>q</code>.</p><p><code>t</code> is canceled (i.e., it fails with <code>Canceled</code>) if an element is returned.</p><dl><dt>raises {!Closed}</dt><dd><p>if <code>q</code> is empty and closed. More specifically, the promise is rejected with <a href="index.html#exception-Closed"><code>Closed</code></a> if <code>q</code> is empty and closed.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-pop_all"><a href="#val-pop_all" class="anchor"></a><code><span class="keyword">val</span> pop_all : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span><span class="type-var">'a</span> list</span> Lwt.t</span></code></dt><dd><p><code>pop_all q</code> is a promise that is pending until there is an element in <code>q</code>. When this happens, all the elements of <code>q</code> are removed and the promise is fulfilled with the list of elements (in the order in which they were inserted).</p><p>If there is already an element in <code>q</code> when the call is made, the elements are removed immediately and an already resolved promise is returned.</p><dl><dt>raises {!Closed}</dt><dd><p>if <code>q</code> is empty and closed. More specifically, the promise is rejected with <a href="index.html#exception-Closed"><code>Closed</code></a> if <code>q</code> is empty and closed.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-pop_all_now"><a href="#val-pop_all_now" class="anchor"></a><code><span class="keyword">val</span> pop_all_now : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> list</span></code></dt><dd><p><code>pop_all_now q</code> removes and returns all the elements in <code>q</code> (in the order in which they were inserted). If <code>q</code> is empty, <code>[]</code> is returned.</p><dl><dt>raises {!Closed}</dt><dd><p>if <code>q</code> is empty and closed.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-peek"><a href="#val-peek" class="anchor"></a><code><span class="keyword">val</span> peek : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span></code></dt><dd><p><code>peek q</code> returns the same value as <code>pop q</code> but does not remove the returned element.</p><dl><dt>raises {!Closed}</dt><dd><p>if <code>q</code> is empty and closed. More specifically, the promise is rejected with <a href="index.html#exception-Closed"><code>Closed</code></a> if <code>q</code> is empty and closed.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-peek_all"><a href="#val-peek_all" class="anchor"></a><code><span class="keyword">val</span> peek_all : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> list</span></code></dt><dd><p><code>peek_all q</code> returns the elements in the <code>q</code> (oldest first), or <code>[]</code> if empty. It does not remove elements from <code>q</code>.</p><dl><dt>raises {!Closed}</dt><dd><p>if <code>q</code> is empty and closed.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-push_now"><a href="#val-push_now" class="anchor"></a><code><span class="keyword">val</span> push_now : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>push_now q v</code> either</p><ul><li>adds <code>v</code> at the ends of <code>q</code> immediately and returns <code>true</code>, or</li><li>if <code>q</code> is full, returns <code>false</code>.</li></ul></dd></dl><dl><dt class="spec value" id="val-pop_now"><a href="#val-pop_now" class="anchor"></a><code><span class="keyword">val</span> pop_now : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> option</span></code></dt><dd><p><code>pop_now q</code> may remove and return the first element in <code>q</code> if <code>q</code> contains at least one element.</p></dd></dl><dl><dt class="spec value" id="val-length"><a href="#val-length" class="anchor"></a><code><span class="keyword">val</span> length : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> int</code></dt><dd><p><code>length q</code> is the number of elements in <code>q</code>.</p></dd></dl><dl><dt class="spec value" id="val-is_empty"><a href="#val-is_empty" class="anchor"></a><code><span class="keyword">val</span> is_empty : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>is_empty q</code> is <code>true</code> if <code>q</code> is empty, <code>false</code> otherwise.</p></dd></dl><dl><dt class="spec value" id="val-empty"><a href="#val-empty" class="anchor"></a><code><span class="keyword">val</span> empty : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>empty q</code> is a promise that resolves when <code>q</code> becomes empty.</p></dd></dl><dl><dt class="spec exception" id="exception-Closed"><a href="#exception-Closed" class="anchor"></a><code><span class="keyword">exception</span> </code><code><span class="exception">Closed</span></code></dt></dl><dl><dt class="spec value" id="val-close"><a href="#val-close" class="anchor"></a><code><span class="keyword">val</span> close : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>close q</code> the write-end of <code>q</code>:</p><p>* Future write attempts will fail with <a href="index.html#exception-Closed"><code>Closed</code></a>. * If there are pending reads, they will become rejected with <a href="index.html#exception-Closed"><code>Closed</code></a>. * Future read attempts will drain the data until there is no data left (at which point <a href="index.html#exception-Closed"><code>Closed</code></a> may be raised).</p><p>The <code>close</code> function is idempotent.</p></dd></dl><dl><dt class="spec value" id="val-is_closed"><a href="#val-is_closed" class="anchor"></a><code><span class="keyword">val</span> is_closed : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> bool</code></dt><dt class="spec value" id="val-push_overhead"><a href="#val-push_overhead" class="anchor"></a><code><span class="keyword">val</span> push_overhead : int</code></dt><dd><p>The number of bytes used in the internal representation to hold an element in the queue.</p></dd></dl></div></body></html>