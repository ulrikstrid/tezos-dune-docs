<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Block_locator (tezos-base.Tezos_base.Block_locator)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">tezos-base</a> &#x00BB; <a href="../index.html">Tezos_base</a> &#x00BB; Block_locator</nav><h1>Module <code>Tezos_base.Block_locator</code></h1></header><aside><p>A locator <code>t</code> is a data structure which roughly represents a list of block hashes in the chain. These hashes go from the top of the chain to the bottom. It is sparse in the sense that the distance between two hashes increases exponentially when we move away from the head.</p><p>The distance between two hashes of a locator is randomized to prevent attacks. The seed is determined uniquely from the <code>peer_id</code> of the sender and the receiver so that the distance between two hashes can be recomputed locally. This is the purpose of the function <code>to_steps</code>.</p><p>The <code>step</code> representation is mostly used by the <code>peer_validator</code> and the <code>bootstrap_pipeline</code> modules.</p><p>The last step of a locator may be truncated. It is the case when the last step hits the caboose. Thus, such a <code>non-strict</code> step can be terminated by:</p><ul><li>The genesis: it is the case in both <code>Archive</code> and <code>Full</code> modes as the caboose is always located down to the genesis block, but it is also the case in a <code>Rolling</code> mode early state (when caboose = genesis).</li></ul><ul><li>Any block: it is the case in <code>Rolling</code> mode when the caboose is higher than the genesis. Indeed, the caboose can be located (almost) anywhere.</li></ul></aside><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code><code> = <span class="keyword">private</span> <a href="../Block_header/index.html#type-t">Block_header.t</a> * <span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> list</span></code></dt><dd><p>Type for sparse block locators (/à la/ Bitcoin).</p></dd></dl><dl><dt class="spec value" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span class="keyword">val</span> pp : Stdlib.Format.formatter <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-pp_short"><a href="#val-pp_short" class="anchor"></a><code><span class="keyword">val</span> pp_short : Stdlib.Format.formatter <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-encoding"><a href="#val-encoding" class="anchor"></a><code><span class="keyword">val</span> encoding : <span><a href="index.html#type-t">t</a> Data_encoding.t</span></code></dt><dt class="spec value" id="val-bounded_encoding"><a href="#val-bounded_encoding" class="anchor"></a><code><span class="keyword">val</span> bounded_encoding : <span>max_header_size:int</span> <span>&#45;&gt;</span> <span>max_length:int</span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <span><a href="index.html#type-t">t</a> Data_encoding.t</span></code></dt></dl><dl><dt class="spec type" id="type-seed"><a href="#type-seed" class="anchor"></a><code><span class="keyword">type</span> seed</code><code> = </code><code>{</code><table class="record"><tr id="type-seed.sender_id" class="anchored"><td class="def field"><a href="#type-seed.sender_id" class="anchor"></a><code>sender_id : <a href="../P2p_peer_id/index.html#type-t">P2p_peer.Id.t</a>;</code></td></tr><tr id="type-seed.receiver_id" class="anchored"><td class="def field"><a href="#type-seed.receiver_id" class="anchor"></a><code>receiver_id : <a href="../P2p_peer_id/index.html#type-t">P2p_peer.Id.t</a>;</code></td></tr></table><code>}</code></dt><dd><p>Argument to the seed used to randomize the locator.</p></dd></dl><dl><dt class="spec value" id="val-estimated_length"><a href="#val-estimated_length" class="anchor"></a><code><span class="keyword">val</span> estimated_length : <a href="index.html#type-seed">seed</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int</code></dt><dd><p><code>estimated_length seed locator</code> estimates the length of the chain represented by <code>locator</code> using <code>seed</code>.</p></dd></dl><dl><dt class="spec value" id="val-compute"><a href="#val-compute" class="anchor"></a><code><span class="keyword">val</span> compute : <span>get_predecessor:<span>(<a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> int <span>&#45;&gt;</span> <span><span><a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> option</span> Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>caboose:<a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></span> <span>&#45;&gt;</span> <span>size:int</span> <span>&#45;&gt;</span> <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <a href="../Block_header/index.html#type-t">Block_header.t</a> <span>&#45;&gt;</span> <a href="index.html#type-seed">seed</a> <span>&#45;&gt;</span> <span><a href="index.html#type-t">t</a> Lwt.t</span></code></dt><dd><p><code>compute ~get_predecessor ~caboose ~size block_hash header seed</code> returns a sparse block locator whose header is the given <code>header</code> and whose sparse block is computed using <code>seed</code> to compute random jumps from the <code>block_hash</code>, adding the <code>caboose</code> at the end of the sparse block. The sparse block locator contains at most <code>size + 1</code> elements, including the caboose.</p></dd></dl><dl><dt class="spec type" id="type-step"><a href="#type-step" class="anchor"></a><code><span class="keyword">type</span> step</code><code> = </code><code>{</code><table class="record"><tr id="type-step.block" class="anchored"><td class="def field"><a href="#type-step.block" class="anchor"></a><code>block : <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a>;</code></td></tr><tr id="type-step.predecessor" class="anchored"><td class="def field"><a href="#type-step.predecessor" class="anchor"></a><code>predecessor : <a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a>;</code></td></tr><tr id="type-step.step" class="anchored"><td class="def field"><a href="#type-step.step" class="anchor"></a><code>step : int;</code></td></tr><tr id="type-step.strict_step" class="anchored"><td class="def field"><a href="#type-step.strict_step" class="anchor"></a><code>strict_step : bool;</code></td></tr></table><code>}</code></dt><dd><p>A 'step' in a locator is a couple of consecutive hashes in the locator, and the expected difference of level between the two blocks (or an upper bounds when <code>strict_step = false</code>).</p></dd></dl><dl><dt class="spec value" id="val-pp_step"><a href="#val-pp_step" class="anchor"></a><code><span class="keyword">val</span> pp_step : Stdlib.Format.formatter <span>&#45;&gt;</span> <a href="index.html#type-step">step</a> <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-to_steps"><a href="#val-to_steps" class="anchor"></a><code><span class="keyword">val</span> to_steps : <a href="index.html#type-seed">seed</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="index.html#type-step">step</a> list</span></code></dt><dd><p><code>to_steps seed t</code> builds all the 'steps' composing the locator using the given <code>seed</code>, starting with the oldest one (typically the predecessor of the first step will be the `caboose`). All steps contains <code>strict_step = true</code>, except the oldest one.</p></dd></dl><dl><dt class="spec value" id="val-to_steps_truncate"><a href="#val-to_steps_truncate" class="anchor"></a><code><span class="keyword">val</span> to_steps_truncate : <span>limit:int</span> <span>&#45;&gt;</span> <span>save_point:<a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a></span> <span>&#45;&gt;</span> <a href="index.html#type-seed">seed</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="index.html#type-step">step</a> list</span></code></dt><dd><p><code>to_steps_truncate ~limit ~save_point seed t</code> behaves as <code>to_steps</code> except that when the sum of all the steps already done, and the steps to do in order to reach the next block is superior to <code>limit</code>, we return a truncated list of steps, setting the <code>predecessor</code> of the last step as <code>save_point</code> and its field <code>strict</code> to <code>false</code>.</p></dd></dl><dl><dt class="spec type" id="type-validity"><a href="#type-validity" class="anchor"></a><code><span class="keyword">type</span> validity</code><code> = </code><table class="variant"><tr id="type-validity.Unknown" class="anchored"><td class="def constructor"><a href="#type-validity.Unknown" class="anchor"></a><code>| </code><code><span class="constructor">Unknown</span></code></td></tr><tr id="type-validity.Known_valid" class="anchored"><td class="def constructor"><a href="#type-validity.Known_valid" class="anchor"></a><code>| </code><code><span class="constructor">Known_valid</span></code></td></tr><tr id="type-validity.Known_invalid" class="anchored"><td class="def constructor"><a href="#type-validity.Known_invalid" class="anchor"></a><code>| </code><code><span class="constructor">Known_invalid</span></code></td></tr></table></dt><dd><p>A block can either be known valid, invalid or unknown.</p></dd></dl><dl><dt class="spec value" id="val-unknown_prefix"><a href="#val-unknown_prefix" class="anchor"></a><code><span class="keyword">val</span> unknown_prefix : <span>is_known:<span>(<a href="../../../tezos-crypto/Tezos_crypto/Block_hash/index.html#type-t">Tezos_crypto.Block_hash.t</a> <span>&#45;&gt;</span> <span><a href="index.html#type-validity">validity</a> Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<a href="index.html#type-validity">validity</a> * <a href="index.html#type-t">t</a>)</span> Lwt.t</span></code></dt><dd><p><code>unknown_prefix ~is_known t</code> either returns :</p><ul><li><code>(Known_valid, (h, hist))</code> when we find a known valid block in the locator history (w.r.t. <code>is_known</code>), where <code>h</code> is the given locator header and <code>hist</code> is the unknown prefix ending with the known valid block.</li></ul><ul><li><code>(Known_invalid, (h, hist))</code> when we find a known invalid block (w.r.t. <code>is_known</code>) in the locator history, where <code>h</code> is the given locator header and <code>hist</code> is the unknown prefix ending with the known invalid block.</li></ul><ul><li><code>(Unknown, (h, hist))</code> when no block is known valid nor invalid (w.r.t. <code>is_known</code>), where <code>(h, hist)</code> is the given <code>locator</code>.</li></ul></dd></dl></div></body></html>