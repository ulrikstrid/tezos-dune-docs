<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tree (tezos-sapling.Tezos_sapling.Storage.Make_Storage.Tree)</title><link rel="stylesheet" href="../../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../index.html">tezos-sapling</a> &#x00BB; <a href="../../../index.html">Tezos_sapling</a> &#x00BB; <a href="../../index.html">Storage</a> &#x00BB; <a href="../index.html">Make_Storage</a> &#x00BB; Tree</nav><header class="odoc-preamble"><h1>Module <code><span>Make_Storage.Tree</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module" id="module-H" class="anchored"><a href="#module-H" class="anchor"></a><code><span><span class="keyword">module</span> </span><span>H</span><span> = <a href="../argument-1-C/Hash/index.html">C.Hash</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-max_uint32" class="anchored"><a href="#val-max_uint32" class="anchor"></a><code><span><span class="keyword">val</span> max_uint32 : int64</span></code></div></div><p>Incremental Merkle Tree * * A tree of height h contains 2^h leaves and h+1 levels of nodes with * leaves at level 0 and root at level h. * * The leaves are commitments and the tree is treated as always filled * with a default value H.uncommitted. This allows to have proofs of * membership, or witnesses, of fixed size. * * All the nodes at the same level of an empty tree have the same hash, * which can be computed from the default value of the leaves. This is * stored in the <code>uncommitted</code> list. * * Any subtree filled with default values is represented by the Empty * constructor and given its height it's possible to compute its hash * using the <code>uncommitted</code> list. * * The leaves are indexed by their position <code>pos</code>, ranging from 0 to * (2^h)-1. The encoding of <code>pos</code> limits the possible size of the tree. * In any case the only valid height for the Sapling library is 32, so even * if the library encodes positions as uint64, they never exceed uint32. * * The tree is incremental in the sense that leaves cannot be modified but * only added and exclusively in successive positions. * The type t contains the size of the tree which is also the next position * to fill. * * Given that elements are added and retrieved by position, it is possible * to use this information to efficiently navigate the tree. * Given a tree of height <code>h</code> and a position <code>pos</code>, if pos &lt; pow2 (h-1) only * the left subtree needs to be inspected recursively. Otherwise only the * right needs to be visited, decreasing <code>pos</code> by <code>pow2 (h-1)</code>. * * In order to avoid storing the height for each subtree (or worse * recomputing it), each function with suffix `_height` expects the height * of the tree as parameter. These functions are only for internal use and * are later aliased by functions using the default height of a Sapling * incremental Merkle tree.</p><div class="odoc-spec"><div class="spec type" id="type-tree" class="anchored"><a href="#type-tree" class="anchor"></a><code><span><span class="keyword">type</span> tree</span><span> = </span></code><table><tr id="type-tree.Empty" class="anchored"><td class="def variant constructor"><a href="#type-tree.Empty" class="anchor"></a><code><span>| </span><span><span class="constructor">Empty</span></span></code></td></tr><tr id="type-tree.Leaf" class="anchored"><td class="def variant constructor"><a href="#type-tree.Leaf" class="anchor"></a><code><span>| </span><span><span class="constructor">Leaf</span> <span class="keyword">of</span> <a href="../argument-1-C/Commitment/index.html#type-t">C.Commitment.t</a></span></code></td></tr><tr id="type-tree.Node" class="anchored"><td class="def variant constructor"><a href="#type-tree.Node" class="anchor"></a><code><span>| </span><span><span class="constructor">Node</span> <span class="keyword">of</span> <a href="../argument-1-C/Hash/index.html#type-t">H.t</a> * <a href="#type-tree">tree</a> * <a href="#type-tree">tree</a></span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec value" id="val-tree_encoding" class="anchored"><a href="#val-tree_encoding" class="anchor"></a><code><span><span class="keyword">val</span> tree_encoding : <span><a href="#type-tree">tree</a> <span class="xref-unresolved">Data_encoding</span>.encoding</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-get_root_height" class="anchored"><a href="#val-get_root_height" class="anchor"></a><code><span><span class="keyword">val</span> get_root_height : <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <a href="../argument-1-C/Hash/index.html#type-t">H.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-pow2" class="anchored"><a href="#val-pow2" class="anchor"></a><code><span><span class="keyword">val</span> pow2 : <span>int <span class="arrow">&#45;&gt;</span></span> int64</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-split_at" class="anchored"><a href="#val-split_at" class="anchor"></a><code><span><span class="keyword">val</span> split_at : <span><a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> list</span> * <span><span class="type-var">'a</span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-hash" class="anchored"><a href="#val-hash" class="anchor"></a><code><span><span class="keyword">val</span> hash : <span>height:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span> <a href="../argument-1-C/Hash/index.html#type-t">H.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-insert" class="anchored"><a href="#val-insert" class="anchor"></a><code><span><span class="keyword">val</span> insert : <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../argument-1-C/Commitment/index.html#type-t">C.Commitment.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-tree">tree</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-insert_node" class="anchored"><a href="#val-insert_node" class="anchor"></a><code><span><span class="keyword">val</span> insert_node : <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../argument-1-C/Commitment/index.html#type-t">C.Commitment.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-tree">tree</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-get_cm_height" class="anchored"><a href="#val-get_cm_height" class="anchor"></a><code><span><span class="keyword">val</span> get_cm_height : <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <a href="../argument-1-C/Commitment/index.html#type-t">C.Commitment.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-get_witness_height" class="anchored"><a href="#val-get_witness_height" class="anchor"></a><code><span><span class="keyword">val</span> get_witness_height : <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> <span class="arrow">&#45;&gt;</span></span> bytes</span></code></div><div class="spec-doc"><p>Create the witness in the format required by Sapling.</p><ul><li>height of the merkle tree (32 for Sapling)</li><li>a list of size of hash (32 for Pedersen hash) and hash</li><li>the position as little-endian uint64</li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-fold_from_height" class="anchored"><a href="#val-fold_from_height" class="anchor"></a><code><span><span class="keyword">val</span> fold_from_height : <span>pos:<a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> <span class="arrow">&#45;&gt;</span></span> <span>f:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../argument-1-C/Commitment/index.html#type-t">C.Commitment.t</a> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span>init:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-tree">tree</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = int64 * <a href="#type-tree">tree</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-encoding" class="anchored"><a href="#val-encoding" class="anchor"></a><code><span><span class="keyword">val</span> encoding : <span><span>(int64 * <a href="#type-tree">tree</a>)</span> <span class="xref-unresolved">Data_encoding</span>.encoding</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-empty" class="anchored"><a href="#val-empty" class="anchor"></a><code><span><span class="keyword">val</span> empty : int64 * <a href="#type-tree">tree</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-size" class="anchored"><a href="#val-size" class="anchor"></a><code><span><span class="keyword">val</span> size : <span><span>(<span class="type-var">'a</span> * <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-default_height" class="anchored"><a href="#val-default_height" class="anchor"></a><code><span><span class="keyword">val</span> default_height : int</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-max_size" class="anchored"><a href="#val-max_size" class="anchor"></a><code><span><span class="keyword">val</span> max_size : int64</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-get_root" class="anchored"><a href="#val-get_root" class="anchor"></a><code><span><span class="keyword">val</span> get_root : <span><span>(<span class="type-var">'a</span> * <a href="#type-tree">tree</a>)</span> <span class="arrow">&#45;&gt;</span></span> <a href="../argument-1-C/Hash/index.html#type-t">H.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-add" class="anchored"><a href="#val-add" class="anchor"></a><code><span><span class="keyword">val</span> add : <span><span>(<a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> * <a href="#type-tree">tree</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../argument-1-C/Commitment/index.html#type-t">C.Commitment.t</a> list</span> <span class="arrow">&#45;&gt;</span></span> int64 * <a href="#type-tree">tree</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-get_witness" class="anchored"><a href="#val-get_witness" class="anchor"></a><code><span><span class="keyword">val</span> get_witness : <span><span>(<a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> * <a href="#type-tree">tree</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> <span class="arrow">&#45;&gt;</span></span> <span>bytes option</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-get_cm" class="anchored"><a href="#val-get_cm" class="anchor"></a><code><span><span class="keyword">val</span> get_cm : <span><span>(<a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> * <a href="#type-tree">tree</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../argument-1-C/Commitment/index.html#type-t">C.Commitment.t</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-get_from" class="anchored"><a href="#val-get_from" class="anchor"></a><code><span><span class="keyword">val</span> get_from : <span><span>(<a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> * <a href="#type-tree">tree</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../../../../../tezos-stdlib/Tezos_stdlib/Compare/Int64/index.html#type-t">Tezos_stdlib.Compare.Int64.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../argument-1-C/Commitment/index.html#type-t">C.Commitment.t</a> list</span> option</span></span></code></div></div></div></body></html>